<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Asteroid Impact Analysis</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
  html, body { height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
  body { display: flex; background: #0a0a0a; }
  #sidebar { 
    width: 280px; 
    background: linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 100%);
    color: white; 
    padding: 20px; 
    box-sizing: border-box; 
    overflow-y: auto;
    border-right: 2px solid #ff6600;
  }
  #map { flex: 1; height: 100vh; position: relative; }
  .data-item { 
    margin-bottom: 12px; 
    padding: 8px;
    background: rgba(255, 102, 0, 0.1);
    border-radius: 5px;
    border-left: 3px solid #ff6600;
  }
  .data-item b { color: #ff6600; }
  .tab-button {
    background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
    color: white;
    border: 1px solid #333;
    padding: 12px;
    margin: 5px 0;
    width: 100%;
    text-align: left;
    cursor: pointer;
    border-radius: 8px;
    font-size: 13px;
    transition: all 0.3s ease;
  }
  .tab-button:hover {
    background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
    border-color: #ff6600;
    transform: translateX(5px);
  }
  .tab-button.active {
    background: linear-gradient(135deg, #ff6600 0%, #cc5200 100%);
    color: white;
    font-weight: bold;
    border-color: #ff6600;
    box-shadow: 0 0 20px rgba(255, 102, 0, 0.5);
  }
  #impactContainer {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 400px;
    max-height: calc(100vh - 40px);
    overflow-y: auto;
    background: linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 100%);
    color: white;
    border-radius: 12px;
    font-family: sans-serif;
    box-shadow: 0 0 30px rgba(0,0,0,0.8);
    z-index: 1000;
    border: 2px solid #ff6600;
  }
  .tab-header {
    padding: 18px;
    background: linear-gradient(135deg, #ff6600 0%, #cc5200 100%);
    font-weight: bold;
    border-radius: 10px 10px 0 0;
    font-size: 17px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
  }
  .tab-content {
    padding: 20px;
    background: #1a1a1a;
    border-radius: 0 0 10px 10px;
  }
  .info-section {
    margin-bottom: 15px;
    padding: 12px;
    background: rgba(255, 102, 0, 0.1);
    border-radius: 8px;
    border-left: 3px solid #ff6600;
  }
  .info-section b {
    color: #ff6600;
  }
  .chart-container {
    margin: 15px 0;
    padding: 10px;
    background: rgba(0,0,0,0.3);
    border-radius: 8px;
  }
  h2, h3 { color: #ff6600; text-shadow: 0 0 10px rgba(255, 102, 0, 0.3); }
  hr { border-color: #ff6600; margin: 20px 0; opacity: 0.3; }
</style>
</head>
<body>

<div id="sidebar">
  <h2>üåç Asteroid Impact</h2>
  <div class="data-item"><b>Radius:</b> <span id="radius"></span> m</div>
  <div class="data-item"><b>Density:</b> <span id="density"></span> kg/m¬≥</div>
  <div class="data-item"><b>Velocity:</b> <span id="velocity"></span> km/s</div>
  <div class="data-item"><b>Angle:</b> <span id="angle"></span>¬∞</div>
  
  
  <hr>
  <h3>üìä Analysis</h3>
  
  <button class="tab-button active" onclick="showTab('energy')">‚ö° Impact Energy</button>
  <button class="tab-button" onclick="showTab('atmospheric')">üå´Ô∏è Atmospheric Entry</button>
  <button class="tab-button" onclick="showTab('crater')">üï≥Ô∏è Crater Dimensions</button>
  <button class="tab-button" onclick="showTab('thermal')">üî• Thermal Radiation</button>
  <button class="tab-button" onclick="showTab('seismic')">üìà Seismic Effects</button>
  <button class="tab-button" onclick="showTab('Windeffects')">üí® Wind Effects</button>
  <button class="tab-button" onclick="showTab('water')">üåä Water Effects</button>
  <button class="tab-button" onclick="showTab('global')">üåê Global Effects</button>
  <hr>
<button id="goBackBtn" style="width: 100%; padding: 12px; margin-top: 10px; background: orange; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s;">
  üîô Go Back
</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let mainMap = null;
let currentMapLayer = null;

document.getElementById('goBackBtn').addEventListener('click', () => {
    window.history.back();
});


// ------------------------------
// 1Ô∏è‚É£ Format number with metric prefixes (k, M, G, T, P)
// ------------------------------
function formatMetric(num) {
    const absNum = Math.abs(num);

    // Large numbers
    if (absNum >= 1e18) return (num / 1e18).toFixed(2) + ' E'; // Exa
    if (absNum >= 1e15) return (num / 1e15).toFixed(2) + ' P'; // Peta
    if (absNum >= 1e12) return (num / 1e12).toFixed(2) + ' T'; // Tera
    if (absNum >= 1e9)  return (num / 1e9).toFixed(2) + ' G';  // Giga
    if (absNum >= 1e6)  return (num / 1e6).toFixed(2) + ' M';  // Mega
    if (absNum >= 1e3)  return (num / 1e3).toFixed(2) + ' k';  // kilo

    // Small numbers
    if (absNum >= 1e-3) return (num * 1e3).toFixed(2) + ' m';  // milli
    if (absNum >= 1e-6) return (num * 1e6).toFixed(2) + ' Œº';  // micro
    if (absNum >= 1e-9) return (num * 1e9).toFixed(2) + ' n';  // nano
    if (absNum >= 1e-12) return (num * 1e12).toFixed(2) + ' p'; // pico
    if (absNum >= 1e-15) return (num * 1e15).toFixed(2) + ' f'; // femto
    if (absNum >= 1e-18) return (num * 1e18).toFixed(2) + ' a'; // atto

    return num.toFixed(2); // very small numbers smaller than 1e-18
}




// ------------------------------
// 2Ô∏è‚É£ Format number into words: millions, billions, trillions
// ------------------------------
function formatLargeNumberWords(num) {
    const absNum = Math.abs(num);

    if (absNum >= 1e33) return (num / 1e33).toFixed(2) + ' decillion';
    if (absNum >= 1e30) return (num / 1e30).toFixed(2) + ' nonillion';
    if (absNum >= 1e27) return (num / 1e27).toFixed(2) + ' octillion';
    if (absNum >= 1e24) return (num / 1e24).toFixed(2) + ' septillion';
    if (absNum >= 1e21) return (num / 1e21).toFixed(2) + ' sextillion';
    if (absNum >= 1e18) return (num / 1e18).toFixed(2) + ' quintillion';
    if (absNum >= 1e15) return (num / 1e15).toFixed(2) + ' quadrillion';
    if (absNum >= 1e12) return (num / 1e12).toFixed(2) + ' trillion';
    if (absNum >= 1e9)  return (num / 1e9).toFixed(2) + ' billion';
    if (absNum >= 1e6)  return (num / 1e6).toFixed(2) + ' million';

    return num.toFixed(2);
}



let asteroidData = null;


document.addEventListener("DOMContentLoaded", async () => {

    const response = await fetch("/get-custom-data", {
        method: "GET",
        credentials: "same-origin"
    });
    
    if (!response.ok) {
        console.error(`Error: ${response.status}`);
        alert("No calculation data found. Please go back and calculate first.");
        return;
    }
    
    const asteroidSession = await response.json();
    console.log("Retrieved from session:", asteroidSession);
    
    // Keep the full object globally
    window.asteroidSession = asteroidSession;
    
    // Extract inner info
    const asteroidInfo = asteroidSession.data || {};
    const isLand = asteroidSession.is_land ?? 0;
    const impactTarget = asteroidSession.impact_target || "Unknown";
    
    // Keep inner data separately too if needed
    asteroidData = asteroidInfo; // inner data
    window.asteroidData = asteroidInfo;
    
    // Update sidebar safely
    const updateText = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.innerText = value ?? "N/A";
    };
    
    updateText("radius", asteroidInfo.radius);
    updateText("density", asteroidInfo.density);
    updateText("velocity", asteroidInfo.velocity);
    updateText("angle", asteroidInfo.angle);
    updateText("isLand", isLand ? "Yes" : "No");
    updateText("impactTarget", impactTarget);

    console.log(`The material strength is ${asteroidInfo.materialStrength}`);

    // Initialize map or other functions
    mainMap = L.map('map').setView([asteroidInfo.lat, asteroidInfo.lon], 5);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(mainMap);

    L.marker([asteroidInfo.lat, asteroidInfo.lon], {
        icon: L.divIcon({
            className: 'impact-marker',
            html: '<div style="background: #ff6600; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 20px #ff6600;"></div>',
            iconSize: [20, 20]
        })
    })
    .addTo(mainMap)
    .bindPopup(`<b>Impact Site</b><br>Lat: ${asteroidInfo.lat}<br>Lon: ${asteroidInfo.lon}`)
    .openPopup();

    showTab('energy');

});

    




function sendPopulationRequest(lat, lon, radius) {
    fetch("/estimate_population", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ lat: lat, lon: lon, radius: radius })
    })
    .then(res => res.json())
    .then(data => {
        console.log("Population estimate:", data.population);
        showOnMap(lat, lon, radius, data.population);
    });
}

// Function to request population from backend
async function getPopulation(lat, lon, radius) {
    try {
        const response = await fetch("/estimate_population", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ lat: lat, lon: lon, radius: radius })
        });

        const data = await response.json();
        console.log("Estimated population:", data.population);

        // You can now update your UI with the population
        document.getElementById("populationResult").innerText =
            `Population in area: ${data.population}`;
    } catch (err) {
        console.error("Error fetching population:", err);
    }
}






async function showTab(tabName, event) {
    // Handle tab button active state
    const buttons = document.querySelectorAll('.tab-button');
    buttons.forEach(btn => btn.classList.remove('active'));
    if (event) event.currentTarget.classList.add('active'); // use currentTarget

    // Remove existing container
    const existingContainer = document.getElementById("impactContainer");
    if (existingContainer) {
        existingContainer.remove();
    }

    // Remove existing map layer
    if (currentMapLayer) {
        mainMap.removeLayer(currentMapLayer);
        currentMapLayer = null;
    }

    // Create new container
    const container = document.createElement("div");
    container.id = "impactContainer";
    document.getElementById('map').appendChild(container);

    // Determine header and content
    let headerText = "";
    let content = "";

    switch(tabName) {
        case 'energy':
            headerText = "‚ö° Impact Energy & Recurrence";
            content = generateEnergyContent();
            break;
        case 'atmospheric':
            headerText = "üå´Ô∏è Atmospheric Entry";
            content = generateAtmosphericContent();
            break;
        case 'crater':
            headerText = "üï≥Ô∏è Crater Dimensions & Melt";
            content = generateCraterContent();
            break;
        case 'thermal':
            headerText = "üî• Thermal Radiation";
            content = await generateThermalContent();
            break;
        case 'seismic':
            headerText = "üìà Seismic Effects";
            content = await generateSeismicContent();
            break;
        case 'Windeffects':
            headerText = "üí® WindEffects";
            content = await generateWindContent();
            break;
        case 'water':
            headerText = "üåä Effect of Water Layer";
            content = await generateWaterContent();
            break;
        case 'global':
            headerText = "üåê Global Effects";
            content = await generateGlobalEffectsContent();
            break;
    }

    // Add tab header and content to container
    const tabHeader = document.createElement("div");
    tabHeader.className = "tab-header";
    tabHeader.innerText = headerText;
    container.appendChild(tabHeader);

    const tabContent = document.createElement("div");
    tabContent.className = "tab-content";
    tabContent.innerHTML = content;
    container.appendChild(tabContent);

    if (tabName === 'energy') {
        // Delay to ensure canvas elements exist
        setTimeout(() => {
            initEnergyCharts();
        }, 50);
    }


    if (tabName === 'atmospheric') {
        // Delay to ensure canvas elements exist
        setTimeout(() => {
            initAtmosphericCharts();
        }, 50);
    }

    if (tabName === 'crater') {
        // Delay to ensure canvas elements exist
        setTimeout(() => {
            initCraterCharts();
            showCraterMap()
        }, 50);
    }

    if (tabName === 'thermal') {
        // Delay to ensure canvas elements exist
        setTimeout(() => {
            initThermalCharts();
            showThermalMap()
        }, 50);
    }
    
    if (tabName === 'seismic') {
        // Delay to ensure canvas elements exist
        setTimeout(() => {
            initSeismicCharts();
            showSeismicMap()
        }, 100);
    }

    if (tabName === 'water') {
        // Delay to ensure canvas elements exist
        setTimeout(() => {
            initWaterCharts();
            showWaterMap()
        }, 100);
    }
    
    if(tabName === 'Windeffects'){
        setTimeout(() => {
            initWindCharts();
            showWindMap()
        }, 100);
    }

    if(tabName === 'global'){
        setTimeout(() => {
            initGlobalEffectsCharts();
        
        }, 100);
    }
    


    // Optionally adjust map view
    if (asteroidData && asteroidData.lat && asteroidData.lon) {
        mainMap.setView([asteroidData.lat, asteroidData.lon], 8);
    }


    
}




//energy

function generateEnergyContent() {
    if (!asteroidData) return "<p>Loading data...</p>";

    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const angleDeg = asteroidData.angle;
    
    // Core calculations
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const E_Mt = E_joules / 4.184e15;
    const E_kt = E_Mt * 1000;
    
    // Historical context calculations
    const hiroshimaEquivalent = E_kt / 15;
    const krakatoaEquivalent = E_Mt / 200;
    const earthquakeEquivalent = Math.log10(E_joules) * 0.67 - 5.87;
    
    // Calculate recurrence interval
    const recurrenceYears = 500000 * Math.pow(E_joules / (0.5 * (4/3) * Math.PI * Math.pow(1000, 3) * 2000 * Math.pow(20000, 2)), 0.9);

    return `
        <div class="info-section" style="background: linear-gradient(135deg, #6200ea 0%, #3700b3 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px; color: white;">
            <h3>‚ö° Energy Analysis</h3>
            <b>Total Energy:</b> ${formatLargeNumberWords(E_joules)} J (${formatLargeNumberWords(E_Mt)} Mt TNT)<br>
            <b>Mass:</b> ${formatLargeNumberWords(m)} kg<br>
            <b>Average Recurrence:</b> ${formatLargeNumberWords(recurrenceYears)} years<br>
            <b>Equivalent to:</b> ${formatLargeNumberWords(hiroshimaEquivalent)} Hiroshima bombs
        </div>

        <div class="info-section" style="background: #212121; padding: 15px; border-radius: 10px; margin-bottom: 15px; color: #ffffff;">
            <h4>üßÆ Equations & Explanation</h4>
            <p><b>1Ô∏è‚É£ Mass of Asteroid:</b> <code>m = (4/3) œÄ r¬≥ œÅ</code><br>
            Calculates total mass of asteroid.<br>
            <ul>
                <li><b>r:</b> radius (m)</li>
                <li><b>œÅ:</b> density (kg/m¬≥)</li>
            </ul></p>

            <p><b>2Ô∏è‚É£ Kinetic Energy:</b> <code>E = ¬Ω m v¬≤</code><br>
            Total energy of asteroid due to motion.<br>
            <ul>
                <li><b>m:</b> mass (kg)</li>
                <li><b>v:</b> velocity (m/s)</li>
            </ul></p>

            <p><b>3Ô∏è‚É£ Energy in Megatons:</b> <code>E(Mt) = E(J) / 4.184√ó10¬π‚Åµ</code><br>
            Converts Joules to TNT equivalent.<br>
            <ul>
                <li>1 Mt TNT = 4.184√ó10¬π‚Åµ J</li>
            </ul></p>

            <p><b>4Ô∏è‚É£ Hiroshima Equivalent:</b> <code>E_Hiroshima = E_kt / 15</code><br>
            How many Hiroshima bombs equal this energy.<br>
            <ul>
                <li>1 Hiroshima bomb ‚âà 15 kt</li>
            </ul></p>

            <p><b>5Ô∏è‚É£ Recurrence Interval:</b> <code>Recurrence ‚âà 500,000 * (E / referenceEnergy)^0.9</code><br>
            Estimates how often an asteroid of this energy hits Earth.<br>
            <ul>
                <li><b>referenceEnergy:</b> small asteroid baseline (kg, m/s)</li>
            </ul></p>
        </div>

        <div class="chart-container" style="margin-bottom: 15px;">
            <canvas id="energyComparisonChart" height="250"></canvas>
        </div>

        <div class="chart-container" style="margin-bottom: 15px;">
            <canvas id="historicalEventsChart" height="200"></canvas>
        </div>

        <div class="chart-container" style="margin-bottom: 15px;">
            <canvas id="energyDistributionChart" height="220"></canvas>
        </div>
    `;
}


function initEnergyCharts() {
    if (!asteroidData) return;

    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const E_Mt = (E_joules / 4.184e15).toFixed(2);

    // Energy Comparison Chart (logarithmic scale)
    const energyComparisons = [
        { label: 'Lightning Strike', energy: 1e9 },
        { label: 'Little Boy (Hiroshima)', energy: 6.3e13 },
        { label: 'Tsar Bomba', energy: 2.1e17 },
        { label: 'This Impact', energy: E_joules },
        { label: 'Krakatoa Eruption', energy: 8.4e17 },
        { label: 'Chicxulub Impact', energy: 4.2e23 }
    ].sort((a, b) => a.energy - b.energy);

    new Chart(document.getElementById('energyComparisonChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: energyComparisons.map(e => e.label),
            datasets: [{
                label: 'Energy (Joules)',
                data: energyComparisons.map(e => Math.log10(e.energy)),
                backgroundColor: energyComparisons.map(e => 
                    e.label === 'This Impact' ? '#ff4081' : '#6200ea'),
                borderColor: '#ffffff',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Energy Release Comparison (Log Scale)',
                    color: '#ffffff'
                },
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    title: {
                        display: true,
                        text: 'Log‚ÇÅ‚ÇÄ(Joules)',
                        color: '#ffffff'
                    }
                }
            }
        }
    });

    // Historical Events Timeline
    const historicalEvents = [
        { year: 1908, event: 'Tunguska', energy: 15 },
        { year: 1945, event: 'Hiroshima', energy: 0.015 },
        { year: 1961, event: 'Tsar Bomba', energy: 50 },
        { year: 2013, event: 'Chelyabinsk', energy: 0.4 },
        { year: 2023, event: 'This Impact', energy: E_Mt }
    ];

    new Chart(document.getElementById('historicalEventsChart').getContext('2d'), {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Historical Impact Events',
                data: historicalEvents.map(e => ({
                    x: e.year,
                    y: Math.log10(e.energy),
                    label: e.event
                })),
                backgroundColor: historicalEvents.map(e => 
                    e.event === 'This Impact' ? '#ff4081' : '#3700b3'),
                pointRadius: 8,
                pointHoverRadius: 12
            }]
        },
        options: {
            responsive: true,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: (context) => {
                            const point = historicalEvents[context.dataIndex];
                            return `${point.event}: ${point.energy} Mt TNT`;
                        }
                    }
                }
            }
        }
    });

    // Energy Distribution Chart
    const energyDistribution = {
        labels: ['Kinetic Energy', 'Thermal Radiation', 'Seismic Waves', 'Atmospheric Blast', 'Other Effects'],
        datasets: [{
            data: [45, 30, 15, 8, 2],
            backgroundColor: [
                '#6200ea',
                '#ff4081',
                '#00bcd4',
                '#64dd17',
                '#ffd600'
            ]
        }]
    };

    new Chart(document.getElementById('energyDistributionChart').getContext('2d'), {
        type: 'doughnut',
        data: energyDistribution,
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Impact Energy Distribution (%)',
                    color: '#ffffff'
                },
                legend: {
                    position: 'right',
                    labels: {
                        color: '#ffffff'
                    }
                }
            }
        }
    });
}









// Flexible function to fetch population for any lat, lon, radius
async function fetchPopulation(lat, lon, radius) {
    try {
        const response = await fetch("/estimate_population", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ lat: lat, lon: lon, radius: radius })
        });

        const data = await response.json();
        // Return the population number
        return data.population;
    } catch (err) {
        console.error("Error fetching population:", err);
        return 0; // fallback
    }
}



function generateAtmosphericContent() {
    if (!asteroidData) return "<p>Loading data...</p>";

    // --- Basic asteroid properties (units)
    const r = Number(asteroidData.radius);           // meters
    const rho = Number(asteroidData.density);        // kg/m^3 (projectile density)
    const v0 = Number(asteroidData.velocity) * 1000; // km/s -> m/s
    const angle = Number(asteroidData.angle) * Math.PI / 180; // radians from horizontal
    const L0 = 2 * r;                                 // characteristic length (m)
    const m = (4/3) * Math.PI * Math.pow(r, 3) * rho; // mass (kg)

    // --- Atmosphere & drag
    const CD = 2;      // drag coefficient (order-of-magnitude)
    const rho0 = 1.225; // kg/m^3 at sea level
    const H = 8000;    // m, scale height
    const atmosphereTop = 100000; // m (100 km)

    // --- Material strength (Pa)
    const Yi = Number(asteroidData.materialStrength);

    // -------------------------
    // Correct breakup altitude
    // Solve 0.5 * rho(z) * v^2 = Yi
    // rho(z) = rho0 * exp(-z/H)  =>  z = -H * ln( 2*Yi / (rho0 * v^2) )
    // If 2*Yi/(rho0*v^2) >= 1 => ln(...) >= 0 => z <= 0 or "no breakup" in atmosphere (survives)
    // -------------------------
    let zStar; // meters
    const ratio = (2 * Yi) / (rho0 * v0 * v0);

    if (!isFinite(ratio) || ratio <= 0) {
        // physically degenerate, treat as immediate breakup high (set zStar = 0)
        zStar = 0;
    } else if (ratio >= 1) {
        // dynamic pressure never reaches material strength in the atmosphere
        zStar = Infinity; // denote "no breakup due to dynamic pressure"
    } else {
        zStar = -H * Math.log(ratio); // m
        if (!isFinite(zStar) || isNaN(zStar)) zStar = 0;
    }

    const breakupAltitude = (zStar === Infinity) ? Infinity : Math.max(0, zStar / 1000); // km

    // -------------------------
    // Generate altitude array and compute velocity, pressure, energy vs altitude
    // altitudes: 100 km down to 0 km in steps of 5 km (same as your UI)
    // -------------------------
    const altitudes = Array.from({length: 21}, (_, i) => 100 - i * 5); // km
    const altitudes_m = altitudes.map(h => h * 1000); // m

    // Improved velocity decay model (same functional form you used but corrected for sin usage)
    // factor uses sin(angle) in denominator because path length through atmosphere increases with shallow angle
    // ensure we treat near-zero angle carefully
    const sinAngle = Math.max(1e-6, Math.sin(angle)); // avoid division by zero
    const factorCoeff = (3 * CD * rho0 * L0) / (4 * rho * H * sinAngle);

    const velocityDecay = altitudes_m.map(z => {
        // v(z) = v0 * exp(- factor * (1 - exp(-z/H)) )
        // keeps same analytic shape as before but will now work with corrected breakup
        return v0 * Math.exp(-factorCoeff * (1 - Math.exp(-z / H)));
    });

    const dynamicPressure = altitudes_m.map((z, idx) => {
        const localRho = rho0 * Math.exp(-z / H);
        const v = velocityDecay[idx];
        return 0.5 * localRho * v * v; // Pa
    });

    const energyDissipation = velocityDecay.map((v, idx) => {
        return 0.5 * m * (v0 * v0 - v * v); // Joules dissipated above that altitude
    });

    // -------------------------
    // Determine breakup index (altitude where breakup occurs)
    // - If zStar === Infinity => no breakup in atmosphere (survives)
    // - Else find the first altitude <= breakup altitude (zStar)
    // -------------------------
    let breakupIndex;
    if (zStar === Infinity) {
        breakupIndex = -1; // sentinel meaning "no breakup"
    } else {
        breakupIndex = altitudes_m.findIndex(z => z <= zStar);
        if (breakupIndex === -1) {
            // breakup altitude is below lowest listed altitude (below 0 km), treat as near-surface
            breakupIndex = altitudes.length - 1;
        }
    }
    

    // Survival fraction defined as remaining kinetic energy fraction after atmospheric dissipation until breakup
    let survivalFraction;
    if (zStar === Infinity) {
        survivalFraction = 1.0; // no breakup => survives intact (approx)
    } else {
        // energy dissipated until breakup altitude
        const E_diss = energyDissipation[breakupIndex];
        const E_initial = 0.5 * m * v0 * v0;
        survivalFraction = Math.max(0, 1 - (E_diss / E_initial));
    }

    // Maximum dynamic pressure encountered (use whole profile)
    const qMax = Math.max(...dynamicPressure);

    // -------------------------
    // Decide impact outcome
    // -------------------------
    let impactOutcome = "";
    if (zStar === Infinity) {
        // dynamic pressure never reaches material strength
        impactOutcome = "Impactor likely reaches ground intact";
    } else if (breakupAltitude > 30) {
        // High altitude breakup - fragments likely dispersed
        if (survivalFraction > 0.5) {
            impactOutcome = "High altitude airburst ‚Äî larger fragments may reach ground";
        } else {
            impactOutcome = "High altitude airburst ‚Äî most energy dissipated, small fragments only";
        }
    } else if (breakupAltitude > 10) {
        // Mid-altitude breakup
        if (survivalFraction > 0.7 || (r > 50 && rho > 3000)) {
            impactOutcome = "Mid-altitude breakup ‚Äî significant fragments reach ground";
        } else {
            impactOutcome = "Airburst in atmosphere ‚Äî fragments likely";
        }
    } else if (breakupAltitude > 1) {
        // Low altitude breakup
        if (survivalFraction > 0.6 || r > 30) {
            impactOutcome = "Low altitude breakup ‚Äî substantial fragments impact surface";
        } else {
            impactOutcome = "Breakup near surface ‚Äî fragments may hit ground";
        }
    } else {
        // Very low or surface breakup
        if (survivalFraction > 0.8 || (r > 20 && rho > 2500)) {
            impactOutcome = "Impactor reaches ground largely intact ‚Äî crater formation likely";
        } else {
            impactOutcome = "Surface-level breakup ‚Äî ground impact with fragmentation";
        }
    }

    // Velocity at the breakup or at ground index for reporting
    const reportIndex = (breakupIndex === -1) ? (altitudes.length - 1) : breakupIndex;
    const velocityAtReport = velocityDecay[reportIndex];
    const dynamicPressureAtReport = dynamicPressure[reportIndex];
    const energyDissAtReport = energyDissipation[reportIndex];

    // -------------------------
    // Expose arrays for charting/inspection by other functions
    // -------------------------
    window.atmosphericSimulation = {
        altitudes_km: altitudes,
        altitudes_m,
        velocityDecay,
        dynamicPressure,
        energyDissipation,
        breakupAltitude_km: (zStar === Infinity) ? Infinity : (zStar / 1000),
        breakupIndex,
        survivalFraction,
        impactOutcome,
        qMax
    };

    // -------------------------
    // Small helper formatters (local)
    // -------------------------
    function formatMetric(x) {
        if (!isFinite(x)) return "‚àû";
        const absx = Math.abs(x);
        if (absx === 0) return "0";
        const units = [
            {u: "P", v: 1e15},
            {u: "T", v: 1e12},
            {u: "G", v: 1e9},
            {u: "M", v: 1e6},
            {u: "k", v: 1e3},
            {u: "",  v: 1}
        ];
        for (const {u, v} of units) {
            if (absx >= v) return (x / v).toFixed( (v>=1e6) ? 2 : 1 ) + u;
        }
        return x.toExponential(2);
    }

    function formatLargeNumberWords(x) {
        if (!isFinite(x)) return String(x);
        if (x === 0) return "0";
        const absx = Math.abs(x);
        if (absx >= 1e12) return (x / 1e12).toFixed(2) + " trillion";
        if (absx >= 1e9)  return (x / 1e9).toFixed(2) + " billion";
        if (absx >= 1e6)  return (x / 1e6).toFixed(2) + " million";
        if (absx >= 1e3)  return (x / 1e3).toFixed(2) + " thousand";
        return x.toFixed(2);
    }

    // friendly numeric strings for the UI
    const formattedEnergy = formatLargeNumberWords(energyDissAtReport);
    const formattedDynamicPressure = (dynamicPressureAtReport >= 1e6) ? (dynamicPressureAtReport / 1e6).toFixed(3) + " MPa" : dynamicPressureAtReport.toExponential(3) + " Pa";
    const formattedVelocity = formatMetric(velocityAtReport) + " m/s";
    const formattedBreakupAlt = (breakupAltitude === Infinity) ? "No breakup in atmosphere" : breakupAltitude.toFixed(2) + " km";

    // -------------------------
    // Return the HTML snippet (same style as your original)
    // -------------------------
    return `
    <div class="info-section" style="background: linear-gradient(135deg, #03a9f4 0%, #0288d1 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px; color: white;">
        <h3>üå°Ô∏è Atmospheric Entry Analysis</h3>
        <b>Breakup Altitude:</b> ${formattedBreakupAlt}<br>
        <b>Velocity at Breakup/Ground index:</b> ${formattedVelocity}<br>
        <b>Dynamic Pressure at Reported Level:</b> ${formattedDynamicPressure}<br>
        <b>Atmospheric Energy Dissipated (above index):</b> ${formattedEnergy} J<br>
        <b>Fraction Reaching Surface (approx):</b> ${(survivalFraction * 100).toFixed(1)} %<br>
        <b>Impact Outcome:</b> ${impactOutcome}
    </div>

    <div class="chart-container" style="margin-bottom: 15px;">
        <canvas id="velocityDecayChart" height="250"></canvas>
    </div>

    <div class="chart-container" style="margin-bottom: 15px;">
        <canvas id="dynamicPressureChart" height="250"></canvas>
    </div>

    <div class="chart-container" style="margin-bottom: 15px;">
        <canvas id="energyDissipationChart" height="250"></canvas>
    </div>
    `;
}


function initAtmosphericCharts() {
    if (!asteroidData) return;

    const v0 = asteroidData.velocity * 1000; // m/s
    const angle = asteroidData.angle * Math.PI/180; // rad
    const L0 = asteroidData.radius*2;
    const rho = asteroidData.density;
    const m = (4/3) * Math.PI * Math.pow(asteroidData.radius,3) * rho;
    const CD = 2;
    const rho0 = 1.225;
    const H = 8000;

    const altitudes = Array.from({length: 21}, (_, i) => 100 - i*5); // km
    const velocityDecay = altitudes.map(h => {
        const z = h*1000;
        const factor = (3 * CD * rho0 * L0)/(4 * rho * H * Math.sin(angle));
        return v0 * Math.exp(-factor*(1-Math.exp(-z/H)));
    });
    const dynamicPressure = altitudes.map((h, idx) => 0.5 * rho0 * Math.exp(-h*1000/H) * Math.pow(velocityDecay[idx],2));
    const energyDissipation = altitudes.map((h, idx) => 0.5 * m * (v0*v0 - velocityDecay[idx]*velocityDecay[idx]));

    // Charts
    const chartOptions = (title, yLabel) => ({
        responsive:true,
        plugins:{
            title:{display:true,text:title,color:'#ffffff'},
            legend:{display:false}
        },
        scales:{
            y:{title:{display:true,text:yLabel,color:'#ffffff'}},
            x:{title:{display:true,text:'Altitude (km)',color:'#ffffff'}}
        }
    });

    new Chart(document.getElementById('velocityDecayChart').getContext('2d'), {
        type:'line',
        data:{
            labels: altitudes.map(h=>h+' km'),
            datasets:[{label:'Velocity (m/s)', data: velocityDecay, borderColor:'#03a9f4', backgroundColor:'rgba(3,169,244,0.2)', fill:true, tension:0.4}]
        },
        options: chartOptions('Velocity Decay vs Altitude','Velocity (m/s)')
    });

    new Chart(document.getElementById('dynamicPressureChart').getContext('2d'), {
        type:'line',
        data:{
            labels: altitudes.map(h=>h+' km'),
            datasets:[{label:'Dynamic Pressure (Pa)', data: dynamicPressure, borderColor:'#ff5722', backgroundColor:'rgba(255,87,34,0.2)', fill:true, tension:0.4}]
        },
        options: chartOptions('Dynamic Pressure vs Altitude','Pressure (Pa)')
    });

    new Chart(document.getElementById('energyDissipationChart').getContext('2d'), {
        type:'line',
        data:{
            labels: altitudes.map(h=>h+' km'),
            datasets:[{label:'Atmospheric Energy Dissipated (J)', data: energyDissipation, borderColor:'#00e676', backgroundColor:'rgba(0,230,118,0.2)', fill:true, tension:0.4}]
        },
        options: chartOptions('Atmospheric Energy Dissipation','Energy (J)')
    });
}

function willAsteroidReachGround(data) {
    // Simple atmospheric filtering model
    const r_m = data.radius;
    const rho = data.density;
    const v = data.velocity * 1000;
    
    // Asteroids smaller than ~25m typically airburst
    // This is a simplified model - actual behavior depends on composition, angle, velocity
    const min_ground_impact_radius = 25;
    
    // Higher velocity asteroids are more likely to reach ground
    const velocity_factor = v / 15000; // Normalized to typical impact velocity
    const effective_min_radius = min_ground_impact_radius / Math.sqrt(velocity_factor);
    
    return r_m > effective_min_radius;
}
 





function showCraterMap() {
    if (!asteroidData) return;

    if (currentMapLayer) {
        mainMap.removeLayer(currentMapLayer);
        currentMapLayer = null;
    }

    currentMapLayer = L.layerGroup();

    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const isLand = asteroidData.is_land ?? 0;
    
    // Calculate crater dimensions
    const D_tr = 1.161 * Math.pow(r_m, 0.78) * Math.pow(v/1000, 0.44) * Math.pow(rho, 0.333) * Math.pow(9.81, -0.22);
    const D_simple_threshold = isLand ? 3000 : 4000;
    let D_final, depth, rim_height, crater_type;
    
    if (D_tr < D_simple_threshold) {
        crater_type = "Simple";
        D_final = D_tr;
        depth = D_final * 0.2;
        rim_height = depth * 0.04;
    } else {
        crater_type = "Complex";
        D_final = 1.17 * Math.pow(D_tr, 1.13);
        depth = D_final * 0.1;
        rim_height = depth * 0.05;
    }
    
    const ejecta_extent = D_final * 1.5;

    // Define zones
    const zones = [
        {
            radius: D_final / 2,
            color: '#8B0000',
            label: `Crater Bowl (${crater_type})`,
            fillOpacity: 0.7,
            details: `Diameter: ${(D_final/1000).toFixed(2)} km<br>Depth: ${(depth/1000).toFixed(3)} km`
        },
        {
            radius: D_final / 2 + rim_height,
            color: '#A0522D',
            label: 'Crater Rim',
            fillOpacity: 0.5,
            details: `Height: ${rim_height.toFixed(1)} m above ground`
        },
        {
            radius: ejecta_extent / 2,
            color: '#D2691E',
            label: 'Primary Ejecta Blanket',
            fillOpacity: 0.3,
            details: `Radius: ${(ejecta_extent/1000/2).toFixed(2)} km<br>Boulder field zone`
        },
        {
            radius: D_final * 2,
            color: '#CD853F',
            label: 'Secondary Ejecta Zone',
            fillOpacity: 0.2,
            details: `Scattered debris and fractured ground`
        },
        {
            radius: D_final * 3,
            color: '#DEB887',
            label: 'Seismic Damage Zone',
            fillOpacity: 0.1,
            details: `Ground shaking and structural damage`
        }
    ];

    // Sort by radius and draw
    zones.sort((a, b) => b.radius - a.radius);

    zones.forEach(zone => {
        L.circle([asteroidData.lat, asteroidData.lon], {
            radius: zone.radius,
            color: zone.color,
            fillColor: zone.color,
            fillOpacity: zone.fillOpacity,
            weight: 2
        }).addTo(currentMapLayer)
          .bindPopup(`<b>${zone.label}</b><br>${zone.details}`);
    });

    // Add impact point marker
    L.marker([asteroidData.lat, asteroidData.lon], {
        icon: L.divIcon({
            className: 'impact-marker',
            html: '<div style="background: #ff0000; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(255,0,0,0.8);"></div>',
            iconSize: [20, 20]
        })
    }).addTo(currentMapLayer).bindPopup(`
        <b>Impact Point</b><br>
        Surface: ${isLand ? 'üèîÔ∏è Land' : 'üåä Water'}<br>
        Crater: ${(D_final/1000).toFixed(2)} km diameter
    `);

    currentMapLayer.addTo(mainMap);

    // Fit bounds
    const maxRadius = Math.max(...zones.map(z => z.radius));
    mainMap.fitBounds([
        [asteroidData.lat - maxRadius/111320, asteroidData.lon - maxRadius/(111320*Math.cos(asteroidData.lat*Math.PI/180))],
        [asteroidData.lat + maxRadius/111320, asteroidData.lon + maxRadius/(111320*Math.cos(asteroidData.lat*Math.PI/180))]
    ]);
}

function generateCraterContent() {
    if (!asteroidData) return "<p>Loading data...</p>";

    // Check if asteroid will reach the ground
if (!willAsteroidReachGround(asteroidData)) {
    // Remove previous message if exists
    const oldMessage = document.getElementById("craterMessage");
    if (oldMessage) oldMessage.remove();

    // Create a centered modal
    const messageDiv = document.createElement("div");
    messageDiv.id = "craterMessage";
    messageDiv.style.position = "fixed";
    messageDiv.style.top = "50%";
    messageDiv.style.left = "50%";
    messageDiv.style.transform = "translate(-50%, -50%)";
    messageDiv.style.backgroundColor = "#ff5252";
    messageDiv.style.color = "white";
    messageDiv.style.padding = "30px 40px";
    messageDiv.style.borderRadius = "12px";
    messageDiv.style.boxShadow = "0 4px 15px rgba(0,0,0,0.3)";
    messageDiv.style.textAlign = "center";
    messageDiv.style.zIndex = "9999";
    messageDiv.innerHTML = `
        <h2>üí® Asteroid Breakup</h2>
        <p>The asteroid will disintegrate in the atmosphere.<br><b>No crater will form on the surface.</b></p>
        <button id="closeCraterMessage" style="
            margin-top: 15px;
            padding: 8px 15px;
            background: white;
            color: #ff5252;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        ">Close</button>
    `;
    document.body.appendChild(messageDiv);

    // Close button functionality
    document.getElementById("closeCraterMessage").addEventListener("click", () => {
        messageDiv.remove();
    });

    return; // stop execution
}

    

    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const E_megatons = E_joules / 4.184e15;
    
    // Crater dimensions using impact scaling laws
    const isLand = window.asteroidSession?.is_land ?? 0;
    const impactAngle = 45; // assume 45¬∞ typical impact
    
    // Transient crater diameter (Collins et al., 2005)
    const D_tr = 1.161 * Math.pow(r_m, 0.78) * Math.pow(v/1000, 0.44) * Math.pow(rho, 0.333) * Math.pow(9.81, -0.22);
    
    // Final crater diameter (simple vs complex crater)
    const D_simple_threshold = isLand ? 3000 : 4000; // meters
    let D_final, depth, rim_height, crater_type;
    
    if (D_tr < D_simple_threshold) {
        // Simple crater
        crater_type = "Simple Bowl-Shaped";
        D_final = D_tr;
        depth = D_final * 0.2; // depth is ~20% of diameter
        rim_height = depth * 0.04; // rim ~4% of depth
    } else {
        // Complex crater with central peak
        crater_type = "Complex with Central Peak";
        D_final = 1.17 * Math.pow(D_tr, 1.13);
        depth = D_final * 0.1; // shallower, ~10% of diameter
        rim_height = depth * 0.05;
    }
    
    // Crater volume
    const crater_volume = (Math.PI / 3) * Math.pow(D_final / 2, 2) * depth;
    
    // Ejecta blanket
    const ejecta_thickness_at_rim = rim_height * 2;
    const ejecta_extent = D_final * 1.5; // extends 1.5x crater diameter
    
    // Famous craters for comparison
    const famousCraters = [
        {name: 'Barringer (Meteor Crater)', diameter: 1200, location: 'Arizona, USA'},
        {name: 'Chicxulub', diameter: 180000, location: 'Mexico (Dinosaur extinction)'},
        {name: 'Vredefort', diameter: 300000, location: 'South Africa (Largest on Earth)'},
        {name: 'Sudbury', diameter: 130000, location: 'Canada'},
        {name: 'Manicouagan', diameter: 100000, location: 'Canada'},
        {name: 'This Impact', diameter: D_final, location: 'Current Simulation'}
    ].sort((a, b) => a.diameter - b.diameter);

    return `
        <div class="info-section" style="background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <h3 style="margin: 0 0 10px 0; color: white;">üï≥Ô∏è Crater Characteristics</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <b>Crater Type:</b> ${crater_type}<br>
                    <b>Final Diameter:</b> ${formatLargeNumberWords(D_final)} m<br>
                    <b>Depth:</b> ${formatLargeNumberWords(depth)} m<br>
                    <b>Rim Height:</b> ${formatLargeNumberWords(rim_height)} m
                </div>
                <div>
                    <b>Volume:</b> ${formatMetric(crater_volume)} m¬≥<br>
                    <b>Impact Surface:</b> ${isLand ? 'üèîÔ∏è Land' : 'üåä Water'}<br>
                    <b>Ejecta Extent:</b> ${formatLargeNumberWords(ejecta_extent)} m<br>
                    <b>Depth/Diameter:</b> ${(depth/D_final * 100).toFixed(1)}%
                </div>
            </div>
        </div>

        <div class="info-section" style="background: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <h3 style="margin: 0 0 10px 0; color: #A0522D;">üìê Crater Profile</h3>
            <div style="position: relative; height: 200px; background: linear-gradient(to bottom, #87CEEB 0%, #D2691E 50%, #8B4513 100%); border-radius: 8px; overflow: hidden;">
                <svg width="100%" height="100%" viewBox="0 0 400 200" style="position: absolute; top: 0; left: 0;">
                    <!-- Ground level -->
                    <line x1="0" y1="100" x2="400" y2="100" stroke="#654321" stroke-width="2" stroke-dasharray="5,5"/>
                    
                    <!-- Crater bowl -->
                    <path d="M 100 100 Q 200 ${100 + (depth/D_final)*80} 300 100" 
                          fill="#654321" stroke="#8B4513" stroke-width="2"/>
                    
                    <!-- Rim -->
                    <path d="M 90 100 L 100 ${100 - (rim_height/depth)*20} L 110 100" 
                          fill="#A0522D" stroke="#654321" stroke-width="1.5"/>
                    <path d="M 290 100 L 300 ${100 - (rim_height/depth)*20} L 310 100" 
                          fill="#A0522D" stroke="#654321" stroke-width="1.5"/>
                    
                    ${D_tr >= D_simple_threshold ? `
                    <!-- Central peak for complex craters -->
                    <path d="M 190 ${100 + (depth/D_final)*60} L 200 ${100 + (depth/D_final)*30} L 210 ${100 + (depth/D_final)*60}" 
                          fill="#8B7355" stroke="#654321" stroke-width="1.5"/>
                    ` : ''}
                    
                    <!-- Labels -->
                    <text x="200" y="95" text-anchor="middle" fill="white" font-size="12">Ground Level</text>
                    <text x="200" y="${100 + (depth/D_final)*80 - 5}" text-anchor="middle" fill="white" font-size="11">Depth: ${(depth/1000).toFixed(2)} km</text>
                    <text x="50" y="95" text-anchor="middle" fill="white" font-size="10">Rim</text>
                </svg>
            </div>
            <p style="margin: 10px 0 0 0; font-size: 0.85em; color: #aaa; text-align: center;">
                ${crater_type} - Cross-sectional view (not to scale)
            </p>
        </div>

        <div class="chart-container" style="margin-bottom: 15px;">
            <canvas id="craterDimensionsChart" height="200"></canvas>
        </div>

        <div class="chart-container" style="margin-bottom: 15px;">
            <canvas id="craterComparisonChart" height="250"></canvas>
        </div>

        <div class="chart-container" style="margin-bottom: 15px;">
            <canvas id="ejectaDistributionChart" height="200"></canvas>
        </div>

        <div class="info-section" style="background: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <h3 style="margin: 0 0 10px 0; color: #A0522D;">ü™® Ejecta Characteristics</h3>
            <div style="font-size: 0.9em; line-height: 1.8;">
                <b style="color: #D2691E;">Ejecta Volume:</b> ~${formatMetric(crater_volume * 2)} m¬≥ (displaced material)<br>
                <b style="color: #D2691E;">Blanket Thickness at Rim:</b> ${formatLargeNumberWords(ejecta_thickness_at_rim)} m<br>
                <b style="color: #D2691E;">Maximum Ejecta Range:</b> ${formatLargeNumberWords(ejecta_extent)} m<br>
                <b style="color: #D2691E;">Boulder Size:</b> Up to ${formatLargeNumberWords(D_final * 0.01)} m at rim<br>
                <b style="color: #D2691E;">Fallback Time:</b> ~${Math.sqrt(2 * depth / 9.81).toFixed(1)} seconds for deepest material
            </div>
        </div>

        <div class="info-section" style="background: linear-gradient(135deg, #1a1a2e 0%, #2d1810 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #A0522D;">
            <h3 style="margin: 0 0 10px 0; color: #D2691E;">üí° Crater Formation Facts</h3>
            <ul style="margin: 5px 0; padding-left: 20px; line-height: 1.7; font-size: 0.9em;">
                <li>Crater formation takes only ${Math.max(1, (D_final/1000/20).toFixed(0))} - ${Math.max(5, (D_final/1000/10).toFixed(0))} minutes</li>
                <li>The crater forms through three stages: contact/compression, excavation, and modification</li>
                <li>${crater_type === "Complex with Central Peak" ? 
                    "The central peak forms from elastic rebound of compressed rock" : 
                    "Simple craters maintain their bowl shape without central uplift"}</li>
                <li>Impact energy melts ~${(E_megatons * 0.01).toExponential(1)} cubic meters of rock</li>
                <li>The crater will erode ${isLand ? 'over millions of years' : 'rapidly if underwater'}</li>
                <li>Seismic shaking equivalent to magnitude ${Math.min(10, 0.67 * Math.log10(E_joules) - 5.87).toFixed(1)} earthquake</li>
                <li>${isLand ? 
                    'Material ejected can reach escape velocity and become meteorites' : 
                    'Water impact creates massive tsunamis radiating outward'}</li>
            </ul>
        </div>

        <div class="info-section" style="background: #0f3460; padding: 15px; border-radius: 8px; margin-top: 15px;">
            <h3 style="margin: 0 0 10px 0; color: #00d4ff;">üî¨ Surface Effects</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
                <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 5px;">
                    <b style="color: #00d4ff;">Vaporized Rock:</b><br>
                    ${formatMetric(crater_volume * 0.1)} m¬≥<br>
                    <span style="font-size: 0.85em; color: #aaa;">Superheated plasma cloud</span>
                </div>
                <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 5px;">
                    <b style="color: #00d4ff;">Melted Rock:</b><br>
                    ${formatMetric(crater_volume * 0.2)} m¬≥<br>
                    <span style="font-size: 0.85em; color: #aaa;">Glass and impact melt</span>
                </div>
                <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 5px;">
                    <b style="color: #00d4ff;">Shocked Material:</b><br>
                    ${formatMetric(crater_volume * 0.5)} m¬≥<br>
                    <span style="font-size: 0.85em; color: #aaa;">High-pressure metamorphism</span>
                </div>
                <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 5px;">
                    <b style="color: #00d4ff;">Fractured Rock:</b><br>
                    ${formatMetric(crater_volume * 2)} m¬≥<br>
                    <span style="font-size: 0.85em; color: #aaa;">Shatter cones and breccia</span>
                </div>
            </div>
        </div>

        ${isLand ? `
        <div class="info-section" style="background: linear-gradient(135deg, #2d5016 0%, #3d6b1f 100%); padding: 15px; border-radius: 8px; margin-top: 15px;">
            <h3 style="margin: 0 0 10px 0; color: white;">üåç Land Impact Specifics</h3>
            <ul style="margin: 5px 0; padding-left: 20px; line-height: 1.6;">
                <li>Crater will be visible from space as a circular scar</li>
                <li>Creates a debris field extending ${(ejecta_extent/1000 * 3).toFixed(0)} km downrange</li>
                <li>Groundwater aquifers disrupted in ${(D_final/1000 * 2).toFixed(0)} km radius</li>
                <li>Local topography permanently altered</li>
                <li>Potential for mineral deposits (shocked quartz, diamonds)</li>
            </ul>
        </div>
        ` : `
        <div class="info-section" style="background: linear-gradient(135deg, #003d5c 0%, #005580 100%); padding: 15px; border-radius: 8px; margin-top: 15px;">
            <h3 style="margin: 0 0 10px 0; color: white;">üåä Water Impact Specifics</h3>
            <ul style="margin: 5px 0; padding-left: 20px; line-height: 1.6;">
                <li>Creates a transient water cavity ${(D_final/1000).toFixed(2)} km wide</li>
                <li>Generates tsunamis with heights up to ${Math.min(300, Math.sqrt(E_megatons) * 10).toFixed(0)} meters</li>
                <li>Steam explosion throws water ${(depth * 5 / 1000).toFixed(1)} km into atmosphere</li>
                <li>Crater may not be visible on seafloor due to water column</li>
                <li>Creates underwater shockwaves devastating to marine life</li>
            </ul>
        </div>
        `}
    `;
}

function initCraterCharts() {
    if (!asteroidData) return;

    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const isLand = window.asteroidSession?.is_land ?? 0;
    
    // Calculate crater dimensions
    const D_tr = 1.161 * Math.pow(r_m, 0.78) * Math.pow(v/1000, 0.44) * Math.pow(rho, 0.333) * Math.pow(9.81, -0.22);
    const D_simple_threshold = isLand ? 3000 : 4000;
    let D_final, depth, rim_height;
    
    if (D_tr < D_simple_threshold) {
        D_final = D_tr;
        depth = D_final * 0.2;
        rim_height = depth * 0.04;
    } else {
        D_final = 1.17 * Math.pow(D_tr, 1.13);
        depth = D_final * 0.1;
        rim_height = depth * 0.05;
    }
    
    const crater_volume = (Math.PI / 3) * Math.pow(D_final / 2, 2) * depth;
    const ejecta_extent = D_final * 1.5;

    // Chart 1: Crater Dimensions Comparison
    new Chart(document.getElementById('craterDimensionsChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: ['Diameter', 'Depth', 'Rim Height', 'Ejecta Extent'],
            datasets: [{
                label: 'Dimensions (meters)',
                data: [D_final, depth, rim_height, ejecta_extent],
                backgroundColor: ['#8B4513', '#A0522D', '#D2691E', '#CD853F'],
                borderColor: '#654321',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { labels: { color: 'white' } },
                title: { display: true, text: 'Crater Dimensions', color: 'white', font: { size: 14 } }
            },
            scales: {
                y: { 
                    type: 'logarithmic',
                    ticks: { color: 'white' }, 
                    grid: { color: '#333' },
                    title: { display: true, text: 'Meters (log scale)', color: 'white' }
                },
                x: { ticks: { color: 'white' }, grid: { color: '#333' } }
            }
        }
    });

    // Chart 2: Famous Craters Comparison
    const famousCraters = [
        {name: 'Barringer', diameter: 1200},
        {name: 'Chicxulub', diameter: 180000},
        {name: 'Vredefort', diameter: 300000},
        {name: 'Sudbury', diameter: 130000},
        {name: 'This Impact', diameter: D_final}
    ].sort((a, b) => a.diameter - b.diameter);

    new Chart(document.getElementById('craterComparisonChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: famousCraters.map(c => c.name),
            datasets: [{
                label: 'Crater Diameter (km)',
                data: famousCraters.map(c => c.diameter / 1000),
                backgroundColor: famousCraters.map(c => 
                    c.name === 'This Impact' ? '#ff6600' : '#A0522D'
                ),
                borderColor: '#654321',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                title: { display: true, text: 'Comparison with Famous Impact Craters', color: 'white', font: { size: 14 } }
            },
            scales: {
                x: { 
                    type: 'logarithmic',
                    ticks: { color: 'white' }, 
                    grid: { color: '#333' },
                    title: { display: true, text: 'Diameter (km, log scale)', color: 'white' }
                },
                y: { ticks: { color: 'white' }, grid: { color: '#333' } }
            }
        }
    });

    // Chart 3: Ejecta Distribution
    const ejecta_distances = [0, 0.5, 1, 1.5, 2, 2.5, 3, 4, 5].map(x => x * D_final);
    const ejecta_thickness = ejecta_distances.map(d => {
        if (d <= D_final/2) return rim_height * 2;
        return (rim_height * 2) * Math.pow((D_final/2) / d, 3);
    });

    new Chart(document.getElementById('ejectaDistributionChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: ejecta_distances.map(d => (d/1000).toFixed(1) + ' km'),
            datasets: [{
                label: 'Ejecta Thickness (m)',
                data: ejecta_thickness,
                borderColor: '#CD853F',
                backgroundColor: 'rgba(205, 133, 63, 0.3)',
                fill: true,
                tension: 0.4,
                pointRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { labels: { color: 'white' } },
                title: { display: true, text: 'Ejecta Blanket Distribution', color: 'white', font: { size: 14 } }
            },
            scales: {
                y: { 
                    type: 'logarithmic',
                    ticks: { color: 'white' }, 
                    grid: { color: '#333' },
                    title: { display: true, text: 'Thickness (meters, log scale)', color: 'white' }
                },
                x: { 
                    ticks: { color: 'white' }, 
                    grid: { color: '#333' },
                    title: { display: true, text: 'Distance from Crater Center', color: 'white' }
                }
            }
        }
    });
}



function showThermalMap() {
    if (!asteroidData) return;
    
    if (currentMapLayer) {
        mainMap.removeLayer(currentMapLayer);
        currentMapLayer = null;
    }
    
    currentMapLayer = L.layerGroup();
    
    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const E_megatons = E_joules / 4.184e15;
    
    // Calculate fireball radius and thermal radiation
    const fireball_radius = 440 * Math.pow(E_megatons, 0.4); // meters
    const fireball_duration = 0.44 * Math.pow(E_megatons, 0.22); // seconds
    
    // Thermal radiation flux at different distances (J/cm¬≤)
    // Based on nuclear weapon scaling laws adapted for asteroid impacts
    function getThermalFlux(distance_m) {
        const distance_km = distance_m / 1000;
        if (distance_km < fireball_radius / 1000) return 1e6; // Inside fireball
        
        // Thermal flux decreases with distance squared, accounting for atmospheric absorption
        const thermal_yield_fraction = 0.35; // 35% of energy as thermal radiation
        const thermal_energy = E_joules * thermal_yield_fraction;
        const flux_at_distance = thermal_energy / (4 * Math.PI * Math.pow(distance_m, 2)) / 10000; // J/cm¬≤
        
        // Atmospheric absorption factor
        const absorption_factor = Math.exp(-distance_km / 50);
        
        return flux_at_distance * absorption_factor;
    }
    
    // Calculate burn radii based on thermal flux thresholds
    // Third-degree burns: ~10 J/cm¬≤
    // Second-degree burns: ~5 J/cm¬≤
    // First-degree burns: ~2.5 J/cm¬≤
    
    function getDistanceForFlux(target_flux) {
        let dist = fireball_radius;
        let flux = getThermalFlux(dist);
        
        // Binary search for distance
        let low = fireball_radius;
        let high = 1000000; // 1000 km max
        
        while (high - low > 100) {
            const mid = (low + high) / 2;
            flux = getThermalFlux(mid);
            
            if (flux > target_flux) {
                low = mid;
            } else {
                high = mid;
            }
        }
        
        return (low + high) / 2;
    }
    
    const third_degree_radius = getDistanceForFlux(10);
    const second_degree_radius = getDistanceForFlux(5);
    const first_degree_radius = getDistanceForFlux(2.5);
    const flash_blindness_radius = getDistanceForFlux(0.5);
    
    // Define thermal zones
    const zones = [
        {
            radius: fireball_radius,
            color: '#FFFFFF',
            label: 'üî• Fireball Zone',
            fillOpacity: 0.9,
            details: `Radius: ${(fireball_radius/1000).toFixed(2)} km<br>Temperature: >10,000¬∞C<br>Complete vaporization`
        },
        {
            radius: third_degree_radius,
            color: '#8B0000',
            label: 'üî• Third-Degree Burns',
            fillOpacity: 0.7,
            details: `Radius: ${(third_degree_radius/1000).toFixed(2)} km<br>Thermal flux: >10 J/cm¬≤<br>Full-thickness skin destruction<br>Clothing ignites`
        },
        {
            radius: second_degree_radius,
            color: '#FF4500',
            label: 'üî• Second-Degree Burns',
            fillOpacity: 0.5,
            details: `Radius: ${(second_degree_radius/1000).toFixed(2)} km<br>Thermal flux: >5 J/cm¬≤<br>Blistering and severe pain<br>Permanent scarring likely`
        },
        {
            radius: first_degree_radius,
            color: '#FFA500',
            label: 'üî• First-Degree Burns',
            fillOpacity: 0.3,
            details: `Radius: ${(first_degree_radius/1000).toFixed(2)} km<br>Thermal flux: >2.5 J/cm¬≤<br>Sunburn-like symptoms<br>Skin redness and pain`
        },
        {
            radius: flash_blindness_radius,
            color: '#FFD700',
            label: 'üëÅÔ∏è Flash Blindness Zone',
            fillOpacity: 0.15,
            details: `Radius: ${(flash_blindness_radius/1000).toFixed(2)} km<br>Temporary vision loss<br>Retinal damage possible<br>Duration: ${fireball_duration.toFixed(1)} seconds`
        }
    ];
    
    // Sort by radius (largest first) and draw
    zones.sort((a, b) => b.radius - a.radius);
    
    zones.forEach(zone => {
        L.circle([asteroidData.lat, asteroidData.lon], {
            radius: zone.radius,
            color: zone.color,
            fillColor: zone.color,
            fillOpacity: zone.fillOpacity,
            weight: 2
        }).addTo(currentMapLayer)
          .bindPopup(`<b>${zone.label}</b><br>${zone.details}`);
    });
    
    // Add impact point marker
    L.marker([asteroidData.lat, asteroidData.lon], {
        icon: L.divIcon({
            className: 'impact-marker',
            html: '<div style="background: #ffffff; width: 20px; height: 20px; border-radius: 50%; border: 3px solid #ff0000; box-shadow: 0 0 20px rgba(255,255,255,1), 0 0 40px rgba(255,100,0,0.8);"></div>',
            iconSize: [20, 20]
        })
    }).addTo(currentMapLayer).bindPopup(`
        <b>Impact Point</b><br>
        Fireball: ${(fireball_radius/1000).toFixed(2)} km radius<br>
        Duration: ${fireball_duration.toFixed(1)} seconds<br>
        Peak Temperature: ${(Math.pow(E_megatons, 0.25) * 8000).toFixed(0)}¬∞C
    `);
    
    currentMapLayer.addTo(mainMap);
    
    // Fit bounds to show all thermal zones
    const maxRadius = Math.max(...zones.map(z => z.radius));
    mainMap.fitBounds([
        [asteroidData.lat - maxRadius/111320, asteroidData.lon - maxRadius/(111320*Math.cos(asteroidData.lat*Math.PI/180))],
        [asteroidData.lat + maxRadius/111320, asteroidData.lon + maxRadius/(111320*Math.cos(asteroidData.lat*Math.PI/180))]
    ]);
}

async function generateThermalContent() {
    if (!asteroidData) return "<p>Loading data...</p>";
    
    // Check if asteroid will reach the ground
    if (!willAsteroidReachGround(asteroidData)) {
        const oldMessage = document.getElementById("thermalMessage");
        if (oldMessage) oldMessage.remove();
        
        const messageDiv = document.createElement("div");
        messageDiv.id = "thermalMessage";
        messageDiv.style.position = "fixed";
        messageDiv.style.top = "50%";
        messageDiv.style.left = "50%";
        messageDiv.style.transform = "translate(-50%, -50%)";
        messageDiv.style.backgroundColor = "#ff9800";
        messageDiv.style.color = "white";
        messageDiv.style.padding = "30px 40px";
        messageDiv.style.borderRadius = "12px";
        messageDiv.style.boxShadow = "0 4px 15px rgba(0,0,0,0.3)";
        messageDiv.style.textAlign = "center";
        messageDiv.style.zIndex = "9999";
        messageDiv.innerHTML = `
            <h2>üí® Atmospheric Airburst</h2>
            <p>The asteroid will explode in the atmosphere.<br><b>Thermal effects still occur but are reduced.</b></p>
            <button id="closeThermalMessage" style="
                margin-top: 15px;
                padding: 8px 15px;
                background: white;
                color: #ff9800;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: bold;
            ">Close</button>
        `;
        
        document.body.appendChild(messageDiv);
        
        document.getElementById("closeThermalMessage").addEventListener("click", () => {
            messageDiv.remove();
        });
        
        return;
    }
    
    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const E_megatons = E_joules / 4.184e15;
    
    // Fireball calculations
    const fireball_radius = 440 * Math.pow(E_megatons, 0.4); // meters
    const fireball_duration = 0.44 * Math.pow(E_megatons, 0.22); // seconds
    const fireball_temperature = Math.pow(E_megatons, 0.25) * 8000; // ¬∞C
    
    // Thermal radiation calculations
    function getThermalFlux(distance_m) {
        const distance_km = distance_m / 1000;
        if (distance_km < fireball_radius / 1000) return 1e6;
        
        const thermal_yield_fraction = 0.35;
        const thermal_energy = E_joules * thermal_yield_fraction;
        const flux_at_distance = thermal_energy / (4 * Math.PI * Math.pow(distance_m, 2)) / 10000;
        const absorption_factor = Math.exp(-distance_km / 50);
        
        return flux_at_distance * absorption_factor;
    }
    
    function getDistanceForFlux(target_flux) {
        let low = fireball_radius;
        let high = 1000000;
        
        while (high - low > 100) {
            const mid = (low + high) / 2;
            const flux = getThermalFlux(mid);
            
            if (flux > target_flux) {
                low = mid;
            } else {
                high = mid;
            }
        }
        
        return (low + high) / 2;
    }
    
    const third_degree_radius = getDistanceForFlux(10);
    const second_degree_radius = getDistanceForFlux(5);
    const first_degree_radius = getDistanceForFlux(2.5);
    const flash_blindness_radius = getDistanceForFlux(0.5);
    const ignition_radius = getDistanceForFlux(20);



    
    
    const casualties_3rd = await fetchPopulation(asteroidData.lat, asteroidData.lon, third_degree_radius/1000);
    console.log(casualties_3rd)
    const casualties_2nd = await fetchPopulation(asteroidData.lat, asteroidData.lon, second_degree_radius/1000);
    const casualties_1st = await fetchPopulation(asteroidData.lat, asteroidData.lon, first_degree_radius/1000);
    
    return `
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background-color: black; padding: 10px; color: white;">
        <div>
            <span><b>Fireball Radius:</b></span> ${formatLargeNumberWords(fireball_radius)} m<br>
            <span><b>Duration:</b></span> ${fireball_duration.toFixed(2)} seconds<br>
            <span><b>Peak Temperature:</b></span> ${formatLargeNumberWords(fireball_temperature)} ¬∞C<br>
            <span><b>Thermal Energy:</b></span> ${(E_megatons * 0.35).toFixed(2)} MT
        </div>
        <div>
            <span><b>Brightness:</b></span> ${(Math.pow(E_megatons, 0.5) * 1000).toExponential(2)} times sun<br>
            <span><b>Thermal Flux (1 km):</b></span> ${getThermalFlux(1000).toFixed(1)} J/cm¬≤<br>
            <span><b>Rise Velocity:</b></span> ${(Math.pow(E_megatons, 0.25) * 100).toFixed(0)} m/s<br>
            <span><b>Final Altitude:</b></span> ${(Math.pow(E_megatons, 0.25) * 12).toFixed(1)} km
        </div>
    </div>
    

        <div class="info-section" style="background: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <h3 style="margin: 0 0 10px 0; color: #ff6600;">üî• Thermal Radiation Zones</h3>
            <div style="position: relative; height: 250px; background: radial-gradient(circle, #ffffff 0%, #ff6600 20%, #ff4500 40%, #FFA500 60%, #FFD700 80%, #1a1a2e 100%); border-radius: 8px; overflow: hidden;">
                <svg width="100%" height="100%" viewBox="0 0 400 250" style="position: absolute; top: 0; left: 0;">
                    <!-- Impact point -->
                    <circle cx="200" cy="125" r="5" fill="white" stroke="#ff0000" stroke-width="2"/>
                    
                    <!-- Zone circles -->
                    <circle cx="200" cy="125" r="30" fill="none" stroke="white" stroke-width="2" opacity="0.8"/>
                    <circle cx="200" cy="125" r="60" fill="none" stroke="#ff0000" stroke-width="2" opacity="0.7"/>
                    <circle cx="200" cy="125" r="90" fill="none" stroke="#ff4500" stroke-width="2" opacity="0.6"/>
                    <circle cx="200" cy="125" r="120" fill="none" stroke="#FFA500" stroke-width="2" opacity="0.5"/>
                    <circle cx="200" cy="125" r="150" fill="none" stroke="#FFD700" stroke-width="2" opacity="0.4"/>
                    
                    <!-- Labels -->
                    <text x="200" y="100" text-anchor="middle" fill="black" font-size="10" font-weight="bold">FIREBALL</text>
                    <text x="260" y="125" text-anchor="start" fill="white" font-size="9">3rd Degree</text>
                    <text x="290" y="125" text-anchor="start" fill="white" font-size="9">2nd Degree</text>
                    <text x="320" y="125" text-anchor="start" fill="white" font-size="9">1st Degree</text>
                </svg>
            </div>
            <p style="margin: 10px 0 0 0; font-size: 0.85em; color: #aaa; text-align: center;">
                Thermal radiation zones from impact point (overhead view)
            </p>
        </div>

        <div class="info-section" style="background: linear-gradient(135deg, #8B0000 0%, #ff0000 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ff6600;">
            <h3 style="margin: 0 0 10px 0; color: white;">ü©π Burn Injury Zones</h3>
            <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                <h4 style="margin: 0 0 8px 0; color: #fff;">üî• Third-Degree Burns (Full Thickness)</h4>
                <b>Radius:</b> ${(third_degree_radius/1000).toFixed(2)} km<br>
                <b>Thermal Flux:</b> >10 J/cm¬≤<br>
                <b>Effects:</b> Complete destruction of skin layers, nerve endings destroyed (initially painless), charring, requires skin grafts, life-threatening<br>
                <b>Clothing:</b> Ignites immediately<br>
                <b>Est. Casualties:</b> ${formatLargeNumberWords(casualties_3rd)} people
            </div>
            <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                <h4 style="margin: 0 0 8px 0; color: #fff;">üî• Second-Degree Burns (Partial Thickness)</h4>
                <b>Radius:</b> ${(second_degree_radius/1000).toFixed(2)} km<br>
                <b>Thermal Flux:</b> 5-10 J/cm¬≤<br>
                <b>Effects:</b> Blistering, severe pain, destruction of epidermis and part of dermis, permanent scarring likely, high infection risk<br>
                <b>Clothing:</b> Synthetic fabrics melt, cotton smolders<br>
                <b>Est. Casualties:</b> ${formatLargeNumberWords(casualties_2nd)} people
            </div>
            <div style="background: rgba(0,0,0,0.1); padding: 12px; border-radius: 6px;">
                <h4 style="margin: 0 0 8px 0; color: #fff;">üî• First-Degree Burns (Superficial)</h4>
                <b>Radius:</b> ${(first_degree_radius/1000).toFixed(2)} km<br>
                <b>Thermal Flux:</b> 2.5-5 J/cm¬≤<br>
                <b>Effects:</b> Redness, pain, swelling, similar to severe sunburn, heals without scarring in 3-7 days<br>
                <b>Clothing:</b> Darkening and scorching of exposed fabrics<br>
                <b>Est. Casualties:</b> ${formatLargeNumberWords(casualties_1st)} people
            </div>
        </div>

        <div class="chart-container" style="margin-bottom: 15px;">
            <canvas id="thermalZonesChart" height="200"></canvas>
        </div>

        <div class="chart-container" style="margin-bottom: 15px;">
            <canvas id="thermalFluxChart" height="220"></canvas>
        </div>

        <div class="chart-container" style="margin-bottom: 15px;">
            <canvas id="burnCasualtiesChart" height="200"></canvas>
        </div>

        <div class="info-section" style="background: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <h3 style="margin: 0 0 10px 0; color: #ff6600;">üî• Secondary Fire Effects</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
                <div style="background: rgba(255,102,0,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #ff6600;">
                    <b style="color: #ff6600;">Ignition Zone:</b><br>
                    ${(ignition_radius/1000).toFixed(2)} km radius<br>
                    <span style="font-size: 0.85em; color: #aaa;">Dry vegetation, wood, paper ignite spontaneously</span>
                </div>
                <div style="background: rgba(255,102,0,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #ff6600;">
                    <b style="color: #ff6600;">Firestorm Potential:</b><br>
                    ${E_megatons > 1 ? 'HIGH' : 'MODERATE'}<br>
                    <span style="font-size: 0.85em; color: #aaa;">Self-sustaining fire consuming oxygen</span>
                </div>
                <div style="background: rgba(255,102,0,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #ff6600;">
                    <b style="color: #ff6600;">Smoke Plume:</b><br>
                    ${(Math.pow(E_megatons, 0.25) * 15).toFixed(1)} km altitude<br>
                    <span style="font-size: 0.85em; color: #aaa;">Blocks sunlight, temperature drop</span>
                </div>
                <div style="background: rgba(255,102,0,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #ff6600;">
                    <b style="color: #ff6600;">Fire Duration:</b><br>
                    ${(Math.sqrt(E_megatons) * 2).toFixed(1)} hours to days<br>
                    <span style="font-size: 0.85em; color: #aaa;">Depending on fuel availability</span>
                </div>
            </div>
        </div>

        <div class="info-section" style="background: #0f3460; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <h3 style="margin: 0 0 10px 0; color: #FFD700;">üëÅÔ∏è Flash Blindness & Eye Damage</h3>
            <div style="font-size: 0.9em; line-height: 1.8;">
                <b style="color: #FFD700;">Flash Blindness Radius:</b> ${(flash_blindness_radius/1000).toFixed(2)} km<br>
                <b style="color: #FFD700;">Duration of Flash:</b> ${fireball_duration.toFixed(2)} seconds<br>
                <b style="color: #FFD700;">Peak Brightness:</b> ${(Math.pow(E_megatons, 0.5) * 1000).toExponential(2)} times brighter than sun<br>
                <b style="color: #FFD700;">Effects:</b>
                <ul style="margin: 5px 0; padding-left: 20px; line-height: 1.6;">
                    <li>Temporary blindness lasting ${(fireball_duration * 20).toFixed(0)}-${(fireball_duration * 40).toFixed(0)} minutes</li>
                    <li>Permanent retinal damage if looking directly at fireball</li>
                    <li>Retinal burns from distances up to ${(flash_blindness_radius/1000 * 0.3).toFixed(0)} km</li>
                    <li>Night vision impairment for hours after exposure</li>
                    <li>Animals blinded and disoriented across affected zone</li>
                </ul>
            </div>
        </div>

        <div class="info-section" style="background: linear-gradient(135deg, #1a1a2e 0%, #2d1810 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #ff6600;">
            <h3 style="margin: 0 0 10px 0; color: #ff6600;">üí° Thermal Radiation Facts</h3>
            <ul style="margin: 5px 0; padding-left: 20px; line-height: 1.7; font-size: 0.9em;">
                <li>Thermal radiation travels at the speed of light - no warning before exposure</li>
                <li>The flash occurs before the blast wave arrives, giving false sense of safety</li>
                <li>Light-colored, loose-fitting clothing provides better protection than dark, tight fabrics</li>
                <li>Being indoors or behind any barrier significantly reduces thermal effects</li>
                <li>Shadows provide complete protection - anyone shielded escapes direct thermal radiation</li>
                <li>The "double flash" phenomenon: initial flash, brief dimming, then sustained fireball glow</li>
                <li>Thermal pulse can ignite fires that spread beyond the initial burn zone</li>
                <li>At night, the flash can temporarily blind observers hundreds of kilometers away</li>
                <li>Reflective surfaces can redirect thermal radiation to create unexpected burn patterns</li>
            </ul>
        </div>

        <div class="info-section" style="background: linear-gradient(135deg, #ff4500 0%, #ff6600 100%); padding: 15px; border-radius: 8px; margin-top: 15px;">
            <h3 style="margin: 0 0 10px 0; color: white;">üè• Medical Response Requirements</h3>
            <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px;">
                <b>Total Burn Casualties:</b> ${formatLargeNumberWords(casualties_1st + casualties_2nd + casualties_3rd)} people<br>
                <b>Critical (3rd degree):</b> ${formatLargeNumberWords(casualties_3rd)} requiring immediate intensive care<br>
                <b>Severe (2nd degree):</b> ${formatLargeNumberWords(casualties_2nd)} requiring hospitalization<br>
                <b>Moderate (1st degree):</b> ${formatLargeNumberWords(casualties_1st)} requiring outpatient treatment<br><br>
                <b style="color: #ffff00;">Hospital beds needed:</b> ${formatLargeNumberWords(casualties_3rd + casualties_2nd * 0.5)}<br>
                <b style="color: #ffff00;">Burn units required:</b> ${Math.ceil(casualties_3rd / 20)} specialized facilities<br>
                <b style="color: #ffff00;">Medical personnel:</b> ${formatLargeNumberWords((casualties_3rd + casualties_2nd) * 2)} doctors and nurses
            </div>
        </div>

        <div class="info-section" style="background: #2d1810; padding: 15px; border-radius: 8px; margin-top: 15px; border: 2px solid #ff6600;">
            <h3 style="margin: 0 0 10px 0; color: #ff6600;">üõ°Ô∏è Protection Measures</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.9em;">
                <div style="background: rgba(255,102,0,0.15); padding: 10px; border-radius: 5px;">
                    <b style="color: #FFD700;">‚úì Effective Protection:</b>
                    <ul style="margin: 5px 0; padding-left: 15px; line-height: 1.5;">
                        <li>Being inside buildings</li>
                        <li>Basement or interior rooms</li>
                        <li>Any solid barrier/shadow</li>
                        <li>Light-colored clothing</li>
                        <li>Immediate drop and cover</li>
                    </ul>
                </div>
                <div style="background: rgba(255,0,0,0.15); padding: 10px; border-radius: 5px;">
                    <b style="color: #ff6600;">‚úó Inadequate Protection:</b>
                    <ul style="margin: 5px 0; padding-left: 15px; line-height: 1.5;">
                        <li>Standard sunglasses</li>
                        <li>Vehicle windows (may shatter)</li>
                        <li>Trees and vegetation</li>
                        <li>Water (reflects radiation)</li>
                        <li>Distance alone</li>
                    </ul>
                </div>
            </div>
        </div>
    `;
}

async function initThermalCharts() {
    if (!asteroidData) return;
    
    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const E_megatons = E_joules / 4.184e15;
    
    const fireball_radius = 440 * Math.pow(E_megatons, 0.4);
    
    function getThermalFlux(distance_m) {
        const distance_km = distance_m / 1000;
        if (distance_km < fireball_radius / 1000) return 1e6;
        
        const thermal_yield_fraction = 0.35;
        const thermal_energy = E_joules * thermal_yield_fraction;
        const flux_at_distance = thermal_energy / (4 * Math.PI * Math.pow(distance_m, 2)) / 10000;
        const absorption_factor = Math.exp(-distance_km / 50);
        
        return flux_at_distance * absorption_factor;
    }
    
    function getDistanceForFlux(target_flux) {
        let low = fireball_radius;
        let high = 1000000;
        
        while (high - low > 100) {
            const mid = (low + high) / 2;
            const flux = getThermalFlux(mid);
            
            if (flux > target_flux) {
                low = mid;
            } else {
                high = mid;
            }
        }
        
        return (low + high) / 2;
    }
    
    const third_degree_radius = getDistanceForFlux(10);
    const second_degree_radius = getDistanceForFlux(5);
    const first_degree_radius = getDistanceForFlux(2.5);
    const flash_blindness_radius = getDistanceForFlux(0.5);
    
    
    const casualties_3rd = await fetchPopulation(asteroidData.lat, asteroidData.lon, third_degree_radius/1000);
    const casualties_2nd = await fetchPopulation(asteroidData.lat, asteroidData.lon, second_degree_radius/1000);
    const casualties_1st = await fetchPopulation(asteroidData.lat, asteroidData.lon, first_degree_radius/1000);


    // Chart 1: Thermal Zone Radii
    new Chart(document.getElementById('thermalZonesChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: ['Fireball', '3rd Degree Burns', '2nd Degree Burns', '1st Degree Burns', 'Flash Blindness'],
            datasets: [{
                label: 'Zone Radius (km)',
                data: [
                    fireball_radius / 1000,
                    third_degree_radius / 1000,
                    second_degree_radius / 1000,
                    first_degree_radius / 1000,
                    flash_blindness_radius / 1000
                ],
                backgroundColor: ['#FFFFFF', '#8B0000', '#FF4500', '#FFA500', '#FFD700'],
                borderColor: '#654321',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: 'white' }
                },
                title: {
                    display: true,
                    text: 'Thermal Effect Zones',
                    color: 'white',
                    font: { size: 14 }
                }
            },
            scales: {
                y: {
                    type: 'logarithmic',
                    ticks: { color: 'white' },
                    grid: { color: '#333' },
                    title: {
                        display: true,
                        text: 'Radius (km, log scale)',
                        color: 'white'
                    }
                },
                x: {
                    ticks: { color: 'white' },
                    grid: { color: '#333' }
                }
            }
        }
    });
    
    // Chart 2: Thermal Flux vs Distance
    const distances = [];
    const fluxes = [];
    for (let d = fireball_radius; d <= flash_blindness_radius * 1.5; d += (flash_blindness_radius * 1.5 - fireball_radius) / 50) {
        distances.push((d / 1000).toFixed(2));
        fluxes.push(getThermalFlux(d));
    }
    
    new Chart(document.getElementById('thermalFluxChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: distances.map(d => d + ' km'),
            datasets: [{
                label: 'Thermal Flux (J/cm¬≤)',
                data: fluxes,
                borderColor: '#ff6600',
                backgroundColor: 'rgba(255, 102, 0, 0.2)',
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: 'white' }
                },
                title: {
                    display: true,
                    text: 'Thermal Radiation Intensity vs Distance',
                    color: 'white',
                    font: { size: 14 }
                },
                annotation: {
                    annotations: {
                        line1: {
                            type: 'line',
                            yMin: 10,
                            yMax: 10,
                            borderColor: '#8B0000',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            label: {
                                content: '3rd Degree',
                                enabled: true,
                                position: 'end'
                            }
                        },
                        line2: {
                            type: 'line',
                            yMin: 5,
                            yMax: 5,
                            borderColor: '#FF4500',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            label: {
                                content: '2nd Degree',
                                enabled: true,
                                position: 'end'
                            }
                        },
                        line3: {
                            type: 'line',
                            yMin: 2.5,
                            yMax: 2.5,
                            borderColor: '#FFA500',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            label: {
                                content: '1st Degree',
                                enabled: true,
                                position: 'end'
                            }
                        }
                    }
                }
            },
            scales: {
                y: {
                    type: 'logarithmic',
                    ticks: { color: 'white' },
                    grid: { color: '#333' },
                    title: {
                        display: true,
                        text: 'Thermal Flux (J/cm¬≤, log scale)',
                        color: 'white'
                    }
                },
                x: {
                    ticks: { 
                        color: 'white',
                        maxTicksLimit: 10
                    },
                    grid: { color: '#333' },
                    title: {
                        display: true,
                        text: 'Distance from Impact',
                        color: 'white'
                    }
                }
            }
        }
    });
    
    // Chart 3: Burn Casualties by Type
    new Chart(document.getElementById('burnCasualtiesChart').getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: ['3rd Degree (Critical)', '2nd Degree (Severe)', '1st Degree (Moderate)'],
            datasets: [{
                data: [casualties_3rd, casualties_2nd, casualties_1st],
                backgroundColor: ['#8B0000', '#FF4500', '#FFA500'],
                borderColor: '#1a1a2e',
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { 
                        color: 'white',
                        font: { size: 11 }
                    },
                    position: 'bottom'
                },
                title: {
                    display: true,
                    text: 'Estimated Burn Casualties by Severity',
                    color: 'white',
                    font: { size: 14 }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value.toLocaleString()} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}


// ------------------ SEISMIC MAP ------------------
function showSeismicMap() {
    if (!asteroidData) return;
    
    if (currentMapLayer) {
        mainMap.removeLayer(currentMapLayer);
        currentMapLayer = null;
    }
    
    currentMapLayer = L.layerGroup();
    
    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const E_megatons = E_joules / 4.184e15;
    
    // Calculate seismic magnitude using empirical relationships
    // Richter magnitude formula: M = 0.67 * log10(E) - 5.87 (E in joules)
    const seismic_magnitude = 0.67 * Math.log10(E_joules) - 5.87;
    
    // Modified Mercalli Intensity (MMI) at distance
    // Based on attenuation: MMI = a - b*log10(distance_km)
    function getMMI(distance_km) {
        if (distance_km < 1) return 12; // Extreme - beyond scale
        
        // Empirical formula for MMI attenuation
        const a = seismic_magnitude * 1.5 + 1.5;
        const b = 3.5;
        const mmi = a - b * Math.log10(distance_km);
        
        return Math.max(1, Math.min(12, mmi));
    }
    
    // Calculate distance for specific MMI levels
    function getDistanceForMMI(target_mmi) {
        const a = seismic_magnitude * 1.5 + 1.5;
        const b = 3.5;
        const distance_km = Math.pow(10, (a - target_mmi) / b);
        return distance_km * 1000; // Convert to meters
    }
    
    // Define seismic intensity zones (MMI scale)
    const zones = [
        {
            radius: getDistanceForMMI(10),
            color: '#8B0000',
            label: 'üèöÔ∏è MMI X - Extreme',
            fillOpacity: 0.8,
            details: `Radius: ${(getDistanceForMMI(10)/1000).toFixed(0)} km<br>Magnitude felt: ${getMMI(getDistanceForMMI(10)/1000).toFixed(1)}<br>Most buildings destroyed, ground cracks, landslides widespread`
        },
        {
            radius: getDistanceForMMI(9),
            color: '#CD5C5C',
            label: 'üåã MMI IX - Violent',
            fillOpacity: 0.65,
            details: `Radius: ${(getDistanceForMMI(9)/1000).toFixed(0)} km<br>Magnitude felt: ${getMMI(getDistanceForMMI(9)/1000).toFixed(1)}<br>General panic, buildings shifted off foundations, ground cracks`
        },
        {
            radius: getDistanceForMMI(8),
            color: '#FF6347',
            label: 'üè¢ MMI VIII - Severe',
            fillOpacity: 0.5,
            details: `Radius: ${(getDistanceForMMI(8)/1000).toFixed(0)} km<br>Magnitude felt: ${getMMI(getDistanceForMMI(8)/1000).toFixed(1)}<br>Considerable damage to ordinary buildings, chimneys fall`
        },
        {
            radius: getDistanceForMMI(7),
            color: '#FFA500',
            label: 'üè† MMI VII - Very Strong',
            fillOpacity: 0.4,
            details: `Radius: ${(getDistanceForMMI(7)/1000).toFixed(0)} km<br>Magnitude felt: ${getMMI(getDistanceForMMI(7)/1000).toFixed(1)}<br>Damage to poorly built structures, felt by everyone`
        },
        {
            radius: getDistanceForMMI(6),
            color: '#FFD700',
            label: '‚ö†Ô∏è MMI VI - Strong',
            fillOpacity: 0.3,
            details: `Radius: ${(getDistanceForMMI(6)/1000).toFixed(0)} km<br>Magnitude felt: ${getMMI(getDistanceForMMI(6)/1000).toFixed(1)}<br>Felt by all, minor damage, objects fall`
        },
        {
            radius: getDistanceForMMI(5),
            color: '#FFFF00',
            label: 'üìä MMI V - Moderate',
            fillOpacity: 0.2,
            details: `Radius: ${(getDistanceForMMI(5)/1000).toFixed(0)} km<br>Magnitude felt: ${getMMI(getDistanceForMMI(5)/1000).toFixed(1)}<br>Felt by most, sleeping people awakened`
        },
        {
            radius: getDistanceForMMI(4),
            color: '#ADFF2F',
            label: 'üîî MMI IV - Light',
            fillOpacity: 0.15,
            details: `Radius: ${(getDistanceForMMI(4)/1000).toFixed(0)} km<br>Magnitude felt: ${getMMI(getDistanceForMMI(4)/1000).toFixed(1)}<br>Felt indoors, windows rattle`
        },
        {
            radius: getDistanceForMMI(3),
            color: '#98FB98',
            label: 'üë• MMI III - Weak',
            fillOpacity: 0.1,
            details: `Radius: ${(getDistanceForMMI(3)/1000).toFixed(0)} km<br>Magnitude felt: ${getMMI(getDistanceForMMI(3)/1000).toFixed(1)}<br>Felt by some people, like passing truck`
        }
    ];
    
    // Sort by radius (largest first) and draw
    zones.sort((a, b) => b.radius - a.radius);
    
    zones.forEach(zone => {
        L.circle([asteroidData.lat, asteroidData.lon], {
            radius: zone.radius,
            color: zone.color,
            fillColor: zone.color,
            fillOpacity: zone.fillOpacity,
            weight: 2
        }).addTo(currentMapLayer)
          .bindPopup(`<b>${zone.label}</b><br>${zone.details}`);
    });
    
    // Add impact point marker
    L.marker([asteroidData.lat, asteroidData.lon], {
        icon: L.divIcon({
            className: 'impact-marker',
            html: '<div style="background: #ff0000; width: 24px; height: 24px; border-radius: 50%; border: 3px solid #8B0000; box-shadow: 0 0 20px rgba(255,0,0,1), 0 0 40px rgba(139,0,0,0.8);"></div>',
            iconSize: [24, 24]
        })
    }).addTo(currentMapLayer).bindPopup(`
        <b>Seismic Epicenter</b><br>
        Magnitude: ${seismic_magnitude.toFixed(1)} (Richter)<br>
        Energy: ${E_megatons.toFixed(2)} MT<br>
        Ground acceleration: >1g<br>
        Duration: ${(Math.pow(E_megatons, 0.33) * 10).toFixed(0)} seconds
    `);
    
    currentMapLayer.addTo(mainMap);
    
    // Fit bounds to show seismic zones (limit to MMI IV for readability)
    const maxRadius = getDistanceForMMI(4);
    mainMap.fitBounds([
        [asteroidData.lat - maxRadius/111320, asteroidData.lon - maxRadius/(111320*Math.cos(asteroidData.lat*Math.PI/180))],
        [asteroidData.lat + maxRadius/111320, asteroidData.lon + maxRadius/(111320*Math.cos(asteroidData.lat*Math.PI/180))]
    ]);
}

async function generateSeismicContent() {
    if (!asteroidData) return "<p>Loading data...</p>";
    
    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const E_megatons = E_joules / 4.184e15;
    
    // Seismic calculations
    const seismic_magnitude = 0.67 * Math.log10(E_joules) - 5.87;
    const seismic_energy_fraction = 0.001; // ~0.1% of impact energy becomes seismic
    const seismic_energy_joules = E_joules * seismic_energy_fraction;
    
    // Ground motion parameters
    const peak_ground_acceleration = Math.pow(E_megatons, 0.5) * 9.81; // m/s¬≤ (multiples of g)
    const seismic_duration = Math.pow(E_megatons, 0.33) * 10; // seconds
    
    function getMMI(distance_km) {
        if (distance_km < 1) return 12;
        const a = seismic_magnitude * 1.5 + 1.5;
        const b = 3.5;
        const mmi = a - b * Math.log10(distance_km);
        return Math.max(1, Math.min(12, mmi));
    }
    
    function getDistanceForMMI(target_mmi) {
        const a = seismic_magnitude * 1.5 + 1.5;
        const b = 3.5;
        const distance_km = Math.pow(10, (a - target_mmi) / b);
        return distance_km * 1000;
    }
    
    function getPGA(distance_km) {
        // Peak Ground Acceleration in g's
        // Attenuation formula: PGA = PGA_0 * (R_0 / R)^1.5 * e^(-R/500)
        if (distance_km < 1) return peak_ground_acceleration / 9.81;
        const pga_0 = peak_ground_acceleration / 9.81;
        const pga = pga_0 * Math.pow(10 / distance_km, 1.5) * Math.exp(-distance_km / 500);
        return Math.max(0.001, pga);
    }
    
    function getPGV(distance_km) {
        // Peak Ground Velocity in cm/s
        const pga_g = getPGA(distance_km);
        const pgv = pga_g * 9.81 * 10; // Approximate conversion
        return pgv;
    }
    
    // Calculate seismic wave arrival times
    function getArrivalTime(distance_km) {
        // P-wave velocity ~6 km/s, S-wave velocity ~3.5 km/s
        const p_wave_speed = 6; // km/s
        const s_wave_speed = 3.5; // km/s
        const surface_wave_speed = 3; // km/s
        
        return {
            p_wave: distance_km / p_wave_speed,
            s_wave: distance_km / s_wave_speed,
            surface_wave: distance_km / surface_wave_speed
        };
    }
    
    // Population casualties by MMI zone
    const casualties_mmi_10 = await fetchPopulation(asteroidData.lat, asteroidData.lon, getDistanceForMMI(10)/1000);
    const casualties_mmi_9 = await fetchPopulation(asteroidData.lat, asteroidData.lon, getDistanceForMMI(9)/1000);
    const casualties_mmi_8 = await fetchPopulation(asteroidData.lat, asteroidData.lon, getDistanceForMMI(8)/1000);
    const casualties_mmi_7 = await fetchPopulation(asteroidData.lat, asteroidData.lon, getDistanceForMMI(7)/1000);
    const casualties_mmi_6 = await fetchPopulation(asteroidData.lat, asteroidData.lon, getDistanceForMMI(6)/1000);
    
    // Seismic fatality rates by MMI
    const total_seismic_deaths = Math.floor(
        casualties_mmi_10 * 0.80 +
        (casualties_mmi_9 - casualties_mmi_10) * 0.50 +
        (casualties_mmi_8 - casualties_mmi_9) * 0.20 +
        (casualties_mmi_7 - casualties_mmi_8) * 0.05 +
        (casualties_mmi_6 - casualties_mmi_7) * 0.01
    );
    
    // Compare to historical earthquakes
    const nearest_historical = seismic_magnitude > 9.5 ? "Larger than any recorded earthquake" :
                              seismic_magnitude > 9.0 ? "Similar to 2011 Tohoku earthquake (9.1)" :
                              seismic_magnitude > 8.0 ? "Similar to 1906 San Francisco earthquake (7.9)" :
                              "Comparable to major regional earthquake";
    
    return `
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background-color: #2c1810; padding: 10px; color: white;">
        <div>
            <span><b>Seismic Magnitude:</b></span> ${seismic_magnitude.toFixed(1)} (Richter)<br>
            <span><b>Moment Magnitude:</b></span> ${(seismic_magnitude + 0.3).toFixed(1)} (Mw)<br>
            <span><b>Seismic Energy:</b></span> ${(seismic_energy_joules/4.184e15).toFixed(3)} MT<br>
            <span><b>Total Deaths:</b></span> ${formatLargeNumberWords(total_seismic_deaths)}
        </div>
        <div>
            <span><b>Peak Ground Accel:</b></span> ${(peak_ground_acceleration/9.81).toFixed(1)}g<br>
            <span><b>Duration:</b></span> ${seismic_duration.toFixed(0)} seconds<br>
            <span><b>Historical Compare:</b></span> ${nearest_historical}<br>
            <span><b>Felt Distance:</b></span> ${(getDistanceForMMI(3)/1000).toFixed(0)} km
        </div>
    </div>

    <div class="info-section" style="background: linear-gradient(180deg, #2c1810 0%, #4a2c1a 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0; color: #ff8c00;">üåç Seismic Wave Propagation</h3>
        <div style="position: relative; height: 250px; background: radial-gradient(circle, #8B0000 0%, #CD5C5C 15%, #FF6347 30%, #FFA500 50%, #FFD700 70%, #2c1810 100%); border-radius: 8px; overflow: hidden;">
            <svg width="100%" height="100%" viewBox="0 0 400 250" style="position: absolute; top: 0; left: 0;">
                <!-- Epicenter -->
                <circle cx="200" cy="125" r="8" fill="#ff0000" stroke="white" stroke-width="2"/>
                
                <!-- Seismic waves -->
                <circle cx="200" cy="125" r="25" fill="none" stroke="#8B0000" stroke-width="3" opacity="0.9"/>
                <circle cx="200" cy="125" r="50" fill="none" stroke="#CD5C5C" stroke-width="2.5" opacity="0.7"/>
                <circle cx="200" cy="125" r="75" fill="none" stroke="#FF6347" stroke-width="2" opacity="0.6"/>
                <circle cx="200" cy="125" r="100" fill="none" stroke="#FFA500" stroke-width="2" opacity="0.5"/>
                <circle cx="200" cy="125" r="130" fill="none" stroke="#FFD700" stroke-width="1.5" opacity="0.4"/>
                
                <!-- Labels -->
                <text x="200" y="122" text-anchor="middle" fill="white" font-size="10" font-weight="bold">IMPACT</text>
                <text x="225" y="125" text-anchor="start" fill="white" font-size="9">MMI X</text>
                <text x="250" y="125" text-anchor="start" fill="white" font-size="9">MMI VIII</text>
                <text x="275" y="125" text-anchor="start" fill="white" font-size="9">MMI VI</text>
                <text x="330" y="125" text-anchor="start" fill="#FFD700" font-size="9">MMI IV</text>
            </svg>
        </div>
        <p style="margin: 10px 0 0 0; font-size: 0.85em; color: #aaa; text-align: center;">
            Seismic intensity zones (Modified Mercalli Intensity scale)
        </p>
    </div>

    <div class="info-section" style="background: linear-gradient(135deg, #8B0000 0%, #CD5C5C 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ff8c00;">
        <h3 style="margin: 0 0 10px 0; color: white;">üìä Seismic Intensity Zones (MMI)</h3>
        
        <div style="background: rgba(0,0,0,0.4); padding: 12px; border-radius: 6px; margin-bottom: 10px;">
            <h4 style="margin: 0 0 8px 0; color: #fff;">MMI X - Extreme (0-${(getDistanceForMMI(10)/1000).toFixed(0)} km)</h4>
            <b>Shaking:</b> Violent, impossible to stand<br>
            <b>PGA:</b> ${getPGA(getDistanceForMMI(10)/1000/2).toFixed(2)}g<br>
            <b>PGV:</b> ${getPGV(getDistanceForMMI(10)/1000/2).toFixed(0)} cm/s<br>
            <b>Damage:</b> Most masonry/frame structures destroyed, ground badly cracked, landslides, liquefaction<br>
            <b>Casualties:</b> ${formatLargeNumberWords(casualties_mmi_10)} (80% fatality)
        </div>
        
        <div style="background: rgba(0,0,0,0.35); padding: 12px; border-radius: 6px; margin-bottom: 10px;">
            <h4 style="margin: 0 0 8px 0; color: #fff;">MMI IX - Violent (${(getDistanceForMMI(10)/1000).toFixed(0)}-${(getDistanceForMMI(9)/1000).toFixed(0)} km)</h4>
            <b>Shaking:</b> Violent, general panic<br>
            <b>PGA:</b> ${getPGA(getDistanceForMMI(9)/1000).toFixed(2)}g<br>
            <b>PGV:</b> ${getPGV(getDistanceForMMI(9)/1000).toFixed(0)} cm/s<br>
            <b>Damage:</b> Buildings shifted off foundations, considerable ground cracks, pipes broken<br>
            <b>Casualties:</b> ${formatLargeNumberWords(casualties_mmi_9 - casualties_mmi_10)} additional (50% fatality)
        </div>
        
        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; margin-bottom: 10px;">
            <h4 style="margin: 0 0 8px 0; color: #fff;">MMI VIII - Severe (${(getDistanceForMMI(9)/1000).toFixed(0)}-${(getDistanceForMMI(8)/1000).toFixed(0)} km)</h4>
            <b>Shaking:</b> Severe, difficult to steer vehicles<br>
            <b>PGA:</b> ${getPGA(getDistanceForMMI(8)/1000).toFixed(3)}g<br>
            <b>PGV:</b> ${getPGV(getDistanceForMMI(8)/1000).toFixed(1)} cm/s<br>
            <b>Damage:</b> Considerable damage to ordinary buildings, chimneys fall, sand/mud ejected<br>
            <b>Casualties:</b> ${formatLargeNumberWords(casualties_mmi_8 - casualties_mmi_9)} additional (20% fatality)
        </div>
        
        <div style="background: rgba(0,0,0,0.25); padding: 12px; border-radius: 6px; margin-bottom: 10px;">
            <h4 style="margin: 0 0 8px 0; color: #fff;">MMI VII - Very Strong (${(getDistanceForMMI(8)/1000).toFixed(0)}-${(getDistanceForMMI(7)/1000).toFixed(0)} km)</h4>
            <b>Shaking:</b> Very strong, difficult to stand<br>
            <b>PGA:</b> ${getPGA(getDistanceForMMI(7)/1000).toFixed(3)}g<br>
            <b>PGV:</b> ${getPGV(getDistanceForMMI(7)/1000).toFixed(1)} cm/s<br>
            <b>Damage:</b> Damage to poorly built structures, noticed by drivers, waves on ponds<br>
            <b>Casualties:</b> ${formatLargeNumberWords(casualties_mmi_7 - casualties_mmi_8)} additional (5% fatality)
        </div>
        
        <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 6px; margin-bottom: 10px;">
            <h4 style="margin: 0 0 8px 0; color: #fff;">MMI VI - Strong (${(getDistanceForMMI(7)/1000).toFixed(0)}-${(getDistanceForMMI(6)/1000).toFixed(0)} km)</h4>
            <b>Shaking:</b> Strong, felt by all<br>
            <b>PGA:</b> ${getPGA(getDistanceForMMI(6)/1000).toFixed(4)}g<br>
            <b>PGV:</b> ${getPGV(getDistanceForMMI(6)/1000).toFixed(2)} cm/s<br>
            <b>Damage:</b> Books fall, pictures knocked off walls, plaster cracks, minor damage<br>
            <b>Casualties:</b> ${formatLargeNumberWords(casualties_mmi_6 - casualties_mmi_7)} additional (1% fatality)
        </div>
        
        <div style="background: rgba(0,0,0,0.15); padding: 12px; border-radius: 6px;">
            <h4 style="margin: 0 0 8px 0; color: #fff;">MMI V and Below (>${(getDistanceForMMI(6)/1000).toFixed(0)} km)</h4>
            <b>Shaking:</b> Moderate to weak<br>
            <b>Damage:</b> Minimal to none, felt by people but little structural impact<br>
            <b>Distance Range:</b> Felt up to ${(getDistanceForMMI(3)/1000).toFixed(0)} km away
        </div>
    </div>

    <div class="chart-container" style="margin-bottom: 15px;">
        <canvas id="seismicIntensityChart" height="200"></canvas>
    </div>

    <div class="chart-container" style="margin-bottom: 15px;">
        <canvas id="groundMotionChart" height="220"></canvas>
    </div>

    <div class="chart-container" style="margin-bottom: 15px;">
        <canvas id="seismicCasualtiesChart" height="200"></canvas>
    </div>

    <div class="info-section" style="background: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0; color: #ff8c00;">üåä Seismic Wave Types</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; font-size: 0.9em;">
            <div style="background: rgba(255,140,0,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #ff8c00;">
                <b style="color: #ff8c00;">P-Waves (Primary)</b><br>
                Speed: 6 km/s<br>
                <span style="font-size: 0.85em; color: #aaa;">Compression waves, arrive first, least damaging</span>
            </div>
            <div style="background: rgba(255,140,0,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #ff8c00;">
                <b style="color: #ff8c00;">S-Waves (Secondary)</b><br>
                Speed: 3.5 km/s<br>
                <span style="font-size: 0.85em; color: #aaa;">Shear waves, more destructive, cannot travel through liquid</span>
            </div>
            <div style="background: rgba(255,140,0,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #ff8c00;">
                <b style="color: #ff8c00;">Surface Waves</b><br>
                Speed: 3 km/s<br>
                <span style="font-size: 0.85em; color: #aaa;">Love & Rayleigh waves, most destructive, cause rolling motion</span>
            </div>
        </div>
        
        <h4 style="margin: 15px 0 10px 0; color: #ff8c00;">Wave Arrival Times</h4>
        <div style="font-size: 0.9em; line-height: 1.8;">
            <b>At 100 km:</b> P-wave ${getArrivalTime(100).p_wave.toFixed(1)}s, S-wave ${getArrivalTime(100).s_wave.toFixed(1)}s, Surface ${getArrivalTime(100).surface_wave.toFixed(1)}s<br>
            <b>At 500 km:</b> P-wave ${(getArrivalTime(500).p_wave/60).toFixed(1)}min, S-wave ${(getArrivalTime(500).s_wave/60).toFixed(1)}min, Surface ${(getArrivalTime(500).surface_wave/60).toFixed(1)}min<br>
            <b>At 1000 km:</b> P-wave ${(getArrivalTime(1000).p_wave/60).toFixed(1)}min, S-wave ${(getArrivalTime(1000).s_wave/60).toFixed(1)}min, Surface ${(getArrivalTime(1000).surface_wave/60).toFixed(1)}min
        </div>
    </div>

    <div class="info-section" style="background: #2c1810; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0; color: #ff8c00;">‚ö†Ô∏è Secondary Seismic Effects</h3>
        <ul style="margin: 5px 0; padding-left: 20px; line-height: 1.8; font-size: 0.9em;">
            <li><b>Liquefaction:</b> Saturated soil loses strength, buildings sink, radius ${(getDistanceForMMI(8)/1000 * 0.8).toFixed(0)} km</li>
            <li><b>Landslides:</b> Massive slope failures in mountainous areas, radius ${(getDistanceForMMI(7)/1000).toFixed(0)} km</li>
            <li><b>Ground Rupture:</b> Surface faulting and cracks up to ${(Math.pow(E_megatons, 0.4) * 5).toFixed(1)} meters wide</li>
            <li><b>Aftershocks:</b> ${Math.floor(Math.log10(E_megatons) * 100)} aftershocks over weeks, magnitude ${(seismic_magnitude - 1.2).toFixed(1)} to ${(seismic_magnitude - 0.5).toFixed(1)}</li>
            <li><b>Seiches:</b> Standing waves in lakes/reservoirs, potential dam failures</li>
            <li><b>Infrastructure Damage:</b> Pipeline breaks, bridge collapses, road buckling within ${(getDistanceForMMI(7)/1000).toFixed(0)} km</li>
            <li><b>Fire Following:</b> Gas line ruptures ignite widespread fires, compounded by broken water mains</li>
        </ul>
    </div>

    <div class="info-section" style="background: linear-gradient(135deg, #4a2c1a 0%, #6d4c3d 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0; color: #ff8c00;">üìà Historical Earthquake Comparison</h3>
        <table style="width: 100%; font-size: 0.9em; border-collapse: collapse;">
            <thead>
                <tr style="background: rgba(255,140,0,0.2); border-bottom: 2px solid #ff8c00;">
                    <th style="padding: 8px; text-align: left;">Event</th>
                    <th style="padding: 8px; text-align: center;">Magnitude</th>
                    <th style="padding: 8px; text-align: center;">Deaths</th>
                    <th style="padding: 8px; text-align: left;">Comparison</th>
                </tr>
            </thead>
            <tbody>
                <tr style="border-bottom: 1px solid #444;">
                    <td style="padding: 8px;">This Impact</td>
                    <td style="padding: 8px; text-align: center;">${seismic_magnitude.toFixed(1)}</td>
                    <td style="padding: 8px; text-align: center;">${formatLargeNumberWords(total_seismic_deaths)}</td>
                    <td style="padding: 8px;">${nearest_historical}</td>
                </tr>
                <tr style="border-bottom: 1px solid #444;">
                    <td style="padding: 8px;">1960 Chile</td>
                    <td style="padding: 8px; text-align: center;">9.5</td>
                    <td style="padding: 8px; text-align: center;">1,655</td>
                    <td style="padding: 8px;">Largest recorded earthquake</td>
                </tr>
                <tr style="border-bottom: 1px solid #444;">
                    <td style="padding: 8px;">2011 Tohoku, Japan</td>
                    <td style="padding: 8px; text-align: center;">9.1</td>
                    <td style="padding: 8px; text-align: center;">15,899</td>
                    <td style="padding: 8px;">Triggered devastating tsunami</td>
                </tr>
                <tr style="border-bottom: 1px solid #444;">
                    <td style="padding: 8px;">2010 Haiti</td>
                    <td style="padding: 8px; text-align: center;">7.0</td>
                    <td style="padding: 8px; text-align: center;">316,000</td>
                    <td style="padding: 8px;">Deadliest recent earthquake</td>
                </tr>
                <tr>
                    <td style="padding: 8px;">1906 San Francisco</td>
                    <td style="padding: 8px; text-align: center;">7.9</td>
                    <td style="padding: 8px; text-align: center;">3,000+</td>
                    <td style="padding: 8px;">Historic California quake</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="info-section" style="background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0; color: white;">üöë Seismic Casualty Summary</h3>
        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 6px;">
            <div style="font-size: 1.5em; font-weight: bold; margin-bottom: 10px;">
                ${formatLargeNumberWords(total_seismic_deaths)} Deaths
            </div>
            <div style="font-size: 0.95em; line-height: 1.7;">
                <b>Primary Causes of Seismic Death:</b>
                <ul style="margin: 8px 0; padding-left: 20px;">
                    <li>Building collapse (60%): ${formatLargeNumberWords(Math.floor(total_seismic_deaths * 0.60))} people</li>
                    <li>Landslides and rockfalls (15%): ${formatLargeNumberWords(Math.floor(total_seismic_deaths * 0.15))} people</li>
                    <li>Infrastructure failure (10%): ${formatLargeNumberWords(Math.floor(total_seismic_deaths * 0.10))} people</li>
                    <li>Fire following earthquake (10%): ${formatLargeNumberWords(Math.floor(total_seismic_deaths * 0.10))} people</li>
                    <li>Other causes (5%): ${formatLargeNumberWords(Math.floor(total_seismic_deaths * 0.05))} people</li>
                </ul>
                <b>Injured (non-fatal):</b> ${formatLargeNumberWords(Math.floor(total_seismic_deaths * 3))} additional casualties<br>
                <b>Displaced:</b> ${formatLargeNumberWords(casualties_mmi_7)} people lose homes
            </div>
        </div>
    </div>

    <div class="info-section" style="background: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0; color: #ff8c00;">üèóÔ∏è Building Damage by Construction Type</h3>
        <table style="width: 100%; font-size: 0.9em; border-collapse: collapse;">
            <thead>
                <tr style="background: rgba(255,140,0,0.2); border-bottom: 2px solid #ff8c00;">
                    <th style="padding: 8px; text-align: left;">Building Type</th>
                    <th style="padding: 8px; text-align: center;">MMI VII</th>
                    <th style="padding: 8px; text-align: center;">MMI VIII</th>
                    <th style="padding: 8px; text-align: center;">MMI IX+</th>
                </tr>
            </thead>
            <tbody>
                <tr style="border-bottom: 1px solid #444;">
                    <td style="padding: 8px;">Wood Frame Houses</td>
                    <td style="padding: 8px; text-align: center;">Moderate</td>
                    <td style="padding: 8px; text-align: center;">Heavy</td>
                    <td style="padding: 8px; text-align: center;">Destroyed</td>
                </tr>
                <tr style="border-bottom: 1px solid #444;">
                    <td style="padding: 8px;">Unreinforced Masonry</td>
                    <td style="padding: 8px; text-align: center;">Heavy</td>
                    <td style="padding: 8px; text-align: center;">Destroyed</td>
                    <td style="padding: 8px; text-align: center;">Collapsed</td>
                </tr>
                <tr style="border-bottom: 1px solid #444;">
                    <td style="padding: 8px;">Reinforced Concrete</td>
                    <td style="padding: 8px; text-align: center;">Light</td>
                    <td style="padding: 8px; text-align: center;">Moderate</td>
                    <td style="padding: 8px; text-align: center;">Heavy/Destroyed</td>
                </tr>
                <tr>
                    <td style="padding: 8px;">Steel Frame</td>
                    <td style="padding: 8px; text-align: center;">Light</td>
                    <td style="padding: 8px; text-align: center;">Moderate</td>
                    <td style="padding: 8px; text-align: center;">Heavy</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="info-section" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #ff8c00;">
        <h3 style="margin: 0 0 10px 0; color: #ff8c00;">üí° Seismic Facts</h3>
        <ul style="margin: 5px 0; padding-left: 20px; line-height: 1.7; font-size: 0.9em;">
            <li>Seismic waves travel through the entire planet - detectable globally by seismometers</li>
            <li>The shaking duration increases with magnitude - this impact produces ${seismic_duration.toFixed(0)} seconds of intense shaking</li>
            <li>Soft soil amplifies ground motion by 2-4x compared to bedrock</li>
            <li>Resonance effects can cause specific buildings to shake violently even at lower intensities</li>
            <li>Most earthquake deaths occur from building collapse, not ground shaking itself</li>
            <li>Modern seismic building codes can reduce casualties by >90% at the same intensity</li>
            <li>P-waves provide seconds to minutes of warning before destructive S-waves arrive</li>
            <li>The "triangle of life" (doorways) is a myth - "drop, cover, hold on" is correct procedure</li>
            <li>Aftershocks can continue for months, some nearly as strong as the main event</li>
            <li>Seismic energy released is ${(Math.pow(10, 1.5 * seismic_magnitude + 4.8) / 4.184e15).toFixed(1)} times the Hiroshima bomb</li>
        </ul>
    </div>

    <div class="info-section" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); padding: 15px; border-radius: 8px; margin-top: 15px; border: 2px solid #27ae60;">
        <h3 style="margin: 0 0 10px 0; color: white;">üõ°Ô∏è Earthquake Survival Guide</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.9em;">
            <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px;">
                <b style="color: white;">‚úì During Shaking:</b>
                <ul style="margin: 5px 0; padding-left: 15px; line-height: 1.5;">
                    <li>DROP to hands and knees</li>
                    <li>COVER head/neck under desk</li>
                    <li>HOLD ON until shaking stops</li>
                    <li>Stay away from windows</li>
                    <li>If in bed, stay there with pillow</li>
                </ul>
            </div>
            <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px;">
                <b style="color: white;">‚úì After Shaking:</b>
                <ul style="margin: 5px 0; padding-left: 15px; line-height: 1.5;">
                    <li>Check for injuries</li>
                    <li>Expect aftershocks</li>
                    <li>Check gas/water/electric</li>
                    <li>Stay away from damaged buildings</li>
                    <li>Have emergency supplies ready</li>
                </ul>
            </div>
            <div style="background: rgba(192,57,43,0.3); padding: 10px; border-radius: 5px;">
                <b style="color: white;">‚úó Dangerous Actions:</b>
                <ul style="margin: 5px 0; padding-left: 15px; line-height: 1.5;">
                    <li>Running outside (falling debris)</li>
                    <li>Standing in doorways (no longer safe)</li>
                    <li>Using elevators</li>
                    <li>Lighting matches (gas leaks)</li>
                    <li>Returning to damaged buildings</li>
                </ul>
            </div>
            <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px;">
                <b style="color: white;">‚ö†Ô∏è Special Situations:</b>
                <ul style="margin: 5px 0; padding-left: 15px; line-height: 1.5;">
                    <li>In car: Stop, stay inside</li>
                    <li>Outdoors: Move away from buildings</li>
                    <li>In stadium: Stay, don't rush exits</li>
                    <li>Near coast: Move to high ground</li>
                    <li>In mountains: Watch for landslides</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="info-section" style="background: #34495e; padding: 15px; border-radius: 8px; margin-top: 15px;">
        <h3 style="margin: 0 0 10px 0; color: #ff8c00;">üåç Global Seismic Impact</h3>
        <div style="font-size: 0.9em; line-height: 1.8;">
            <b>Detectable Distance:</b> ${(getDistanceForMMI(1)/1000).toFixed(0)} km (global seismograph detection)<br>
            <b>Felt by Humans:</b> Up to ${(getDistanceForMMI(3)/1000).toFixed(0)} km away<br>
            <b>Structural Damage:</b> Within ${(getDistanceForMMI(6)/1000).toFixed(0)} km<br>
            <b>Energy Released:</b> ${(seismic_energy_joules/4.184e15).toFixed(3)} megatons (seismic only)<br>
            <b>Equivalent TNT:</b> ${(seismic_energy_joules/4.184e9).toFixed(0)} tons<br>
            <b>Hiroshima Bombs:</b> ${(seismic_energy_joules/(63e12)).toFixed(0)} (15 kiloton equivalent)<br>
            <b>Duration of Shaking:</b> ${seismic_duration.toFixed(0)} seconds at epicenter
        </div>
    </div>
    `;
}

async function initSeismicCharts() {
    if (!asteroidData) return;
    
    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const E_megatons = E_joules / 4.184e15;
    
    const seismic_magnitude = 0.67 * Math.log10(E_joules) - 5.87;
    
    function getMMI(distance_km) {
        if (distance_km < 1) return 12;
        const a = seismic_magnitude * 1.5 + 1.5;
        const b = 3.5;
        const mmi = a - b * Math.log10(distance_km);
        return Math.max(1, Math.min(12, mmi));
    }
    
    function getDistanceForMMI(target_mmi) {
        const a = seismic_magnitude * 1.5 + 1.5;
        const b = 3.5;
        const distance_km = Math.pow(10, (a - target_mmi) / b);
        return distance_km * 1000;
    }
    
    function getPGA(distance_km) {
        if (distance_km < 1) return Math.pow(E_megatons, 0.5);
        const peak_ground_acceleration = Math.pow(E_megatons, 0.5) * 9.81;
        const pga_0 = peak_ground_acceleration / 9.81;
        const pga = pga_0 * Math.pow(10 / distance_km, 1.5) * Math.exp(-distance_km / 500);
        return Math.max(0.001, pga);
    }
    
    const casualties_mmi_10 = await fetchPopulation(asteroidData.lat, asteroidData.lon, getDistanceForMMI(10)/1000);
    const casualties_mmi_9 = await fetchPopulation(asteroidData.lat, asteroidData.lon, getDistanceForMMI(9)/1000);
    const casualties_mmi_8 = await fetchPopulation(asteroidData.lat, asteroidData.lon, getDistanceForMMI(8)/1000);
    const casualties_mmi_7 = await fetchPopulation(asteroidData.lat, asteroidData.lon, getDistanceForMMI(7)/1000);
    const casualties_mmi_6 = await fetchPopulation(asteroidData.lat, asteroidData.lon, getDistanceForMMI(6)/1000);
    const casualties_mmi_5 = await fetchPopulation(asteroidData.lat, asteroidData.lon, getDistanceForMMI(5)/1000);
    
    // Chart 1: Seismic Intensity vs Distance
    new Chart(document.getElementById('seismicIntensityChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: ['MMI X', 'MMI IX', 'MMI VIII', 'MMI VII', 'MMI VI', 'MMI V'],
            datasets: [{
                label: 'Distance (km)',
                data: [
                    getDistanceForMMI(10) / 1000,
                    getDistanceForMMI(9) / 1000,
                    getDistanceForMMI(8) / 1000,
                    getDistanceForMMI(7) / 1000,
                    getDistanceForMMI(6) / 1000,
                    getDistanceForMMI(5) / 1000
                ],
                backgroundColor: ['#8B0000', '#CD5C5C', '#FF6347', '#FFA500', '#FFD700', '#FFFF00'],
                borderColor: '#ff8c00',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: 'white' }
                },
                title: {
                    display: true,
                    text: 'Seismic Intensity Zones (Modified Mercalli)',
                    color: 'white',
                    font: { size: 14 }
                }
            },
            scales: {
                y: {
                    type: 'logarithmic',
                    ticks: { color: 'white' },
                    grid: { color: '#333' },
                    title: {
                        display: true,
                        text: 'Distance (km, log scale)',
                        color: 'white'
                    }
                },
                x: {
                    ticks: { color: 'white' },
                    grid: { color: '#333' }
                }
            }
        }
    });
    
    // Chart 2: Ground Motion (PGA) vs Distance
    const distances = [];
    const pgaValues = [];
    
    for (let d = 1; d <= 2000; d += 20) {
        distances.push(d);
        pgaValues.push(getPGA(d));
    }
    
    new Chart(document.getElementById('groundMotionChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: distances.map(d => d + ' km'),
            datasets: [{
                label: 'Peak Ground Acceleration (g)',
                data: pgaValues,
                borderColor: '#ff8c00',
                backgroundColor: 'rgba(255,140,0,0.2)',
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: 'white' }
                },
                title: {
                    display: true,
                    text: 'Peak Ground Acceleration vs Distance',
                    color: 'white',
                    font: { size: 14 }
                }
            },
            scales: {
                y: {
                    type: 'logarithmic',
                    ticks: { color: 'white' },
                    grid: { color: '#333' },
                    title: {
                        display: true,
                        text: 'PGA (g, log scale)',
                        color: 'white'
                    }
                },
                x: {
                    ticks: { 
                        color: 'white',
                        maxTicksLimit: 15
                    },
                    grid: { color: '#333' },
                    title: {
                        display: true,
                        text: 'Distance from Epicenter',
                        color: 'white'
                    }
                }
            }
        }
    });
    
    // Chart 3: Population Exposure by MMI Zone
    new Chart(document.getElementById('seismicCasualtiesChart').getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: ['MMI X', 'MMI IX', 'MMI VIII', 'MMI VII', 'MMI VI', 'MMI V'],
            datasets: [{
                data: [
                    casualties_mmi_10,
                    casualties_mmi_9 - casualties_mmi_10,
                    casualties_mmi_8 - casualties_mmi_9,
                    casualties_mmi_7 - casualties_mmi_8,
                    casualties_mmi_6 - casualties_mmi_7,
                    casualties_mmi_5 - casualties_mmi_6
                ],
                backgroundColor: ['#8B0000', '#CD5C5C', '#FF6347', '#FFA500', '#FFD700', '#FFFF00'],
                borderColor: '#2c1810',
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { 
                        color: 'white',
                        font: { size: 11 }
                    },
                    position: 'bottom'
                },
                title: {
                    display: true,
                    text: 'Population Exposure by Seismic Intensity',
                    color: 'white',
                    font: { size: 14 }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value.toLocaleString()} people (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}


function showWaterMap() {
    const isOverWater = asteroidSession.is_tsunami;  // notice the underscore

    if (!asteroidData) return;
    if (!isOverWater)
    {
        return
    }
    if(!willAsteroidReachGround(asteroidData)){
        return;
    }
    if (currentMapLayer) {
        mainMap.removeLayer(currentMapLayer);
        currentMapLayer = null;
    }
    
    currentMapLayer = L.layerGroup();
    
    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const E_megatons = E_joules / 4.184e15;
    
    // Water depth at impact location (assume ocean depth)
    const ocean_depth = 4000; // meters, average ocean depth
    const g = 9.81;
    
    // Calculate tsunami wave characteristics
    const initial_amplitude = Math.pow(E_megatons, 0.5) * 50; // meters
    const wave_period = 2 * Math.PI * Math.sqrt(ocean_depth / g); // seconds
    const tsunami_speed = Math.sqrt(g * ocean_depth); // m/s (~200 m/s in deep ocean)
    
    // Calculate wave heights at different distances
    function getTsunamiHeight(distance_m) {
        const distance_km = distance_m / 1000;
        if (distance_km < 10) return initial_amplitude;
        
        const amplitude = initial_amplitude * Math.sqrt(10 / distance_km);
        const friction_loss = Math.exp(-distance_km / 1000);
        
        return amplitude * friction_loss;
    }
    
    // Calculate coastal wave amplification (shoaling effect)
    function getCoastalWaveHeight(deep_water_height) {
        const amplification_factor = Math.pow(ocean_depth / 10, 0.25);
        return deep_water_height * amplification_factor * 2;
    }
    
    // Define tsunami zones based on wave heights
    const mega_tsunami_radius = 50000; // 50 km
    const major_tsunami_radius = 200000; // 200 km
    const moderate_tsunami_radius = 500000; // 500 km
    const minor_tsunami_radius = 1000000; // 1000 km
    const detectable_radius = 2000000; // 2000 km
    
    const zones = [
        {
            radius: mega_tsunami_radius,
            color: '#000080',
            label: 'üåä Mega-Tsunami Zone',
            fillOpacity: 0.85,
            details: `Radius: ${(mega_tsunami_radius/1000).toFixed(0)} km<br>Wave Height: ${getTsunamiHeight(mega_tsunami_radius).toFixed(0)}m (Deep)<br>Coastal Height: ${getCoastalWaveHeight(getTsunamiHeight(mega_tsunami_radius)).toFixed(0)}m<br>Complete coastal devastation`
        },
        {
            radius: major_tsunami_radius,
            color: '#0000CD',
            label: 'üåä Major Tsunami Zone',
            fillOpacity: 0.65,
            details: `Radius: ${(major_tsunami_radius/1000).toFixed(0)} km<br>Wave Height: ${getTsunamiHeight(major_tsunami_radius).toFixed(0)}m (Deep)<br>Coastal Height: ${getCoastalWaveHeight(getTsunamiHeight(major_tsunami_radius)).toFixed(0)}m<br>Severe coastal destruction`
        },
        {
            radius: moderate_tsunami_radius,
            color: '#4169E1',
            label: 'üåä Moderate Tsunami Zone',
            fillOpacity: 0.45,
            details: `Radius: ${(moderate_tsunami_radius/1000).toFixed(0)} km<br>Wave Height: ${getTsunamiHeight(moderate_tsunami_radius).toFixed(1)}m (Deep)<br>Coastal Height: ${getCoastalWaveHeight(getTsunamiHeight(moderate_tsunami_radius)).toFixed(0)}m<br>Major coastal damage`
        },
        {
            radius: minor_tsunami_radius,
            color: '#87CEEB',
            label: 'üåä Minor Tsunami Zone',
            fillOpacity: 0.3,
            details: `Radius: ${(minor_tsunami_radius/1000).toFixed(0)} km<br>Wave Height: ${getTsunamiHeight(minor_tsunami_radius).toFixed(1)}m (Deep)<br>Coastal Height: ${getCoastalWaveHeight(getTsunamiHeight(minor_tsunami_radius)).toFixed(1)}m<br>Coastal flooding and damage`
        },
        {
            radius: detectable_radius,
            color: '#B0E0E6',
            label: 'üìä Detectable Wave Zone',
            fillOpacity: 0.15,
            details: `Radius: ${(detectable_radius/1000).toFixed(0)} km<br>Wave Height: ${getTsunamiHeight(detectable_radius).toFixed(2)}m<br>Observable by instruments<br>Minor coastal effects`
        }
    ];
    
    // Sort and draw zones
    zones.sort((a, b) => b.radius - a.radius);
    
    zones.forEach(zone => {
        L.circle([asteroidData.lat, asteroidData.lon], {
            radius: zone.radius,
            color: zone.color,
            fillColor: zone.color,
            fillOpacity: zone.fillOpacity,
            weight: 2
        }).addTo(currentMapLayer)
          .bindPopup(`<b>${zone.label}</b><br>${zone.details}`);
    });
    
    // Add impact point marker
    L.marker([asteroidData.lat, asteroidData.lon], {
        icon: L.divIcon({
            className: 'impact-marker',
            html: '<div style="background: #1E90FF; width: 24px; height: 24px; border-radius: 50%; border: 3px solid #000080; box-shadow: 0 0 20px rgba(30,144,255,1), 0 0 40px rgba(0,0,255,0.8);"></div>',
            iconSize: [24, 24]
        })
    }).addTo(currentMapLayer).bindPopup(`
        <b>Ocean Impact Point</b><br>
        Initial Wave: ${initial_amplitude.toFixed(0)}m<br>
        Tsunami Speed: ${(tsunami_speed * 3.6).toFixed(0)} km/h<br>
        Wave Period: ${wave_period.toFixed(0)} seconds<br>
        Ocean Depth: ${ocean_depth}m
    `);
    
    currentMapLayer.addTo(mainMap);
    
    // Fit bounds to show tsunami zones
    const maxRadius = detectable_radius;
    mainMap.fitBounds([
        [asteroidData.lat - maxRadius/111320, asteroidData.lon - maxRadius/(111320*Math.cos(asteroidData.lat*Math.PI/180))],
        [asteroidData.lat + maxRadius/111320, asteroidData.lon + maxRadius/(111320*Math.cos(asteroidData.lat*Math.PI/180))]
    ]);
}

async function generateWaterContent() {
    if (!asteroidData) return "<p>Loading data...</p>";

    if (!willAsteroidReachGround(asteroidData)) {
        // Remove previous message if exists
        const oldMessage = document.getElementById("waterImpactMessage");
        if (oldMessage) oldMessage.remove();
    
        // Create a centered modal
        const messageDiv = document.createElement("div");
        messageDiv.id = "waterImpactMessage";
        messageDiv.style.position = "fixed";
        messageDiv.style.top = "50%";
        messageDiv.style.left = "50%";
        messageDiv.style.transform = "translate(-50%, -50%)";
        messageDiv.style.backgroundColor = "#2196F3"; // Blue for water
        messageDiv.style.color = "white";
        messageDiv.style.padding = "30px 40px";
        messageDiv.style.borderRadius = "12px";
        messageDiv.style.boxShadow = "0 4px 15px rgba(0,0,0,0.3)";
        messageDiv.style.textAlign = "center";
        messageDiv.style.zIndex = "9999";
        messageDiv.innerHTML = `
            <h2>üåä Water Impact</h2>
            <p>The asteroid will explode in the atmosphere.</p>
            <button id="closeWaterMessage" style="
                margin-top: 15px;
                padding: 8px 15px;
                background: white;
                color: #2196F3;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: bold;
            ">Close</button>
        `;
        document.body.appendChild(messageDiv);
    
        // Close button functionality
        document.getElementById("closeWaterMessage").addEventListener("click", () => {
            messageDiv.remove();
        });
    
        return; // stop execution
    }


    console.log(asteroidSession.is_tsunami)
    // Check if impact is over water (simplified - you'd use actual ocean data)
    const isOverWater = asteroidSession.is_tsunami;  // notice the underscore
    
    if (!isOverWater) {
        const messageDiv = document.createElement("div");
        messageDiv.id = "waterMessage";
        messageDiv.style.cssText = "position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #2196F3; color: white; padding: 30px 40px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); text-align: center; z-index: 9999;";
        messageDiv.innerHTML = `
            <h2>üèúÔ∏è Land Impact</h2>
            <p>The asteroid will impact on land.<br><b>Water effects analysis not applicable.</b></p>
            <button onclick="this.parentElement.remove()" style="margin-top: 15px; padding: 8px 15px; background: white; color: #2196F3; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">Close</button>
        `;
        document.body.appendChild(messageDiv);
        return;
    }
    
    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const E_megatons = E_joules / 4.184e15;
    
    // Ocean parameters
    const ocean_depth = 4000;
    const g = 9.81;
    const water_density = 1025; // kg/m¬≥ seawater
    
    // Crater and cavity calculations
    const transient_crater_diameter = 2.68 * Math.pow(E_megatons / 1000, 0.3) * 1000; // meters
    const cavity_depth = transient_crater_diameter * 0.3;
    const water_displacement = Math.PI * Math.pow(transient_crater_diameter/2, 2) * cavity_depth;
    const displaced_mass = water_displacement * water_density;
    
    // Tsunami calculations
    const initial_amplitude = Math.pow(E_megatons, 0.5) * 50;
    const tsunami_speed = Math.sqrt(g * ocean_depth);
    const wave_period = 2 * Math.PI * Math.sqrt(ocean_depth / g);
    
    function getTsunamiHeight(distance_m) {
        const distance_km = distance_m / 1000;
        if (distance_km < 10) return initial_amplitude;
        const amplitude = initial_amplitude * Math.sqrt(10 / distance_km);
        const friction_loss = Math.exp(-distance_km / 1000);
        return amplitude * friction_loss;
    }
    
    function getCoastalWaveHeight(deep_water_height) {
        const amplification_factor = Math.pow(ocean_depth / 10, 0.25);
        return deep_water_height * amplification_factor * 2;
    }
    
    function getArrivalTime(distance_m) {
        return distance_m / tsunami_speed / 60; // minutes
    }
    
    // Population exposure
    const mega_casualties = await fetchPopulation(asteroidData.lat, asteroidData.lon, 50);
    const major_casualties = await fetchPopulation(asteroidData.lat, asteroidData.lon, 200);
    const moderate_casualties = await fetchPopulation(asteroidData.lat, asteroidData.lon, 500);
    const minor_casualties = await fetchPopulation(asteroidData.lat, asteroidData.lon, 1000);
    
    // Steam and aerosol calculations
    const water_vaporized = (E_joules * 0.1) / 2.26e6; // kg
    
    return `
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background-color: #001f3f; padding: 10px; color: white;">
        <div>
            <span><b>Impact Energy:</b></span> ${E_megatons.toFixed(2)} MT<br>
            <span><b>Ocean Depth:</b></span> ${ocean_depth.toLocaleString()} m<br>
            <span><b>Tsunami Speed:</b></span> ${(tsunami_speed * 3.6).toFixed(0)} km/h<br>
            <span><b>Wave Period:</b></span> ${wave_period.toFixed(0)} seconds
        </div>
        <div>
            <span><b>Initial Wave Height:</b></span> ${initial_amplitude.toFixed(0)} m<br>
            <span><b>Cavity Diameter:</b></span> ${(transient_crater_diameter/1000).toFixed(2)} km<br>
            <span><b>Water Displaced:</b></span> ${(water_displacement/1e9).toFixed(2)} km¬≥<br>
            <span><b>Displaced Mass:</b></span> ${(displaced_mass/1e12).toFixed(2)} trillion kg
        </div>
    </div>

    <div class="info-section" style="background: linear-gradient(180deg, #001f3f 0%, #003366 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0; color: #1E90FF;">üåä Tsunami Wave Propagation</h3>
        <div style="position: relative; height: 200px; background: linear-gradient(180deg, #87CEEB 0%, #4169E1 50%, #000080 100%); border-radius: 8px; overflow: hidden;">
            <svg width="100%" height="100%" viewBox="0 0 400 200" style="position: absolute; top: 0; left: 0;">
                <circle cx="200" cy="100" r="8" fill="#FF0000" stroke="#FFFFFF" stroke-width="2"/>
                <circle cx="200" cy="100" r="30" fill="none" stroke="white" stroke-width="3" opacity="0.9"/>
                <circle cx="200" cy="100" r="60" fill="none" stroke="#4169E1" stroke-width="2" opacity="0.7"/>
                <circle cx="200" cy="100" r="90" fill="none" stroke="#87CEEB" stroke-width="2" opacity="0.5"/>
                <circle cx="200" cy="100" r="120" fill="none" stroke="#B0E0E6" stroke-width="1" opacity="0.3"/>
                <text x="200" y="95" text-anchor="middle" fill="white" font-size="10" font-weight="bold">IMPACT</text>
                <text x="230" y="100" text-anchor="start" fill="white" font-size="9">50 km</text>
                <text x="260" y="100" text-anchor="start" fill="white" font-size="9">200 km</text>
                <text x="290" y="100" text-anchor="start" fill="#E0E0E0" font-size="9">500 km</text>
            </svg>
        </div>
    </div>

    <div class="info-section" style="background: linear-gradient(135deg, #000080 0%, #1E90FF 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #4169E1;">
        <h3 style="margin: 0 0 10px 0; color: white;">üåä Tsunami Zones & Wave Heights</h3>
        
        <div style="background: rgba(0,0,0,0.4); padding: 12px; border-radius: 6px; margin-bottom: 10px;">
            <h4 style="margin: 0 0 8px 0; color: #fff;">Mega-Tsunami Zone (0-50 km)</h4>
            <b>Deep Water Height:</b> ${getTsunamiHeight(25000).toFixed(0)} m<br>
            <b>Coastal Height:</b> ${getCoastalWaveHeight(getTsunamiHeight(25000)).toFixed(0)} m<br>
            <b>Arrival Time:</b> ${getArrivalTime(50000).toFixed(0)} minutes<br>
            <b>Effects:</b> Complete annihilation of coastal regions, waves overtop mountains, total infrastructure destruction<br>
            <b>Est. Affected:</b> ${formatLargeNumberWords(mega_casualties)} people
        </div>
        
        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; margin-bottom: 10px;">
            <h4 style="margin: 0 0 8px 0; color: #fff;">Major Tsunami Zone (50-200 km)</h4>
            <b>Deep Water Height:</b> ${getTsunamiHeight(100000).toFixed(0)} m<br>
            <b>Coastal Height:</b> ${getCoastalWaveHeight(getTsunamiHeight(100000)).toFixed(0)} m<br>
            <b>Arrival Time:</b> ${getArrivalTime(200000).toFixed(0)} minutes<br>
            <b>Effects:</b> Massive coastal devastation, inland flooding up to 10 km, port cities destroyed<br>
            <b>Est. Affected:</b> ${formatLargeNumberWords(major_casualties)} people
        </div>
        
        <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 6px; margin-bottom: 10px;">
            <h4 style="margin: 0 0 8px 0; color: #fff;">Moderate Tsunami Zone (200-500 km)</h4>
            <b>Deep Water Height:</b> ${getTsunamiHeight(350000).toFixed(1)} m<br>
            <b>Coastal Height:</b> ${getCoastalWaveHeight(getTsunamiHeight(350000)).toFixed(0)} m<br>
            <b>Arrival Time:</b> ${getArrivalTime(500000).toFixed(0)} minutes (${(getArrivalTime(500000)/60).toFixed(1)} hours)<br>
            <b>Effects:</b> Severe coastal flooding, harbor damage, evacuations required<br>
            <b>Est. Affected:</b> ${formatLargeNumberWords(moderate_casualties)} people
        </div>
        
        <div style="background: rgba(0,0,0,0.1); padding: 12px; border-radius: 6px;">
            <h4 style="margin: 0 0 8px 0; color: #fff;">Minor Tsunami Zone (500-1000 km)</h4>
            <b>Deep Water Height:</b> ${getTsunamiHeight(750000).toFixed(1)} m<br>
            <b>Coastal Height:</b> ${getCoastalWaveHeight(getTsunamiHeight(750000)).toFixed(1)} m<br>
            <b>Arrival Time:</b> ${(getArrivalTime(1000000)/60).toFixed(1)} hours<br>
            <b>Effects:</b> Coastal flooding, boat damage, beach erosion<br>
            <b>Est. Affected:</b> ${formatLargeNumberWords(minor_casualties)} people
        </div>
    </div>

    <div class="chart-container" style="margin-bottom: 15px;">
        <canvas id="tsunamiHeightChart" height="220"></canvas>
    </div>

    <div class="chart-container" style="margin-bottom: 15px;">
        <canvas id="arrivalTimeChart" height="200"></canvas>
    </div>

    <div class="chart-container" style="margin-bottom: 15px;">
        <canvas id="waterCasualtiesChart" height="200"></canvas>
    </div>

    <div class="info-section" style="background: #0a2540; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0; color: #1E90FF;">üí® Water Vapor & Atmospheric Effects</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
            <div style="background: rgba(30,144,255,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #1E90FF;">
                <b style="color: #1E90FF;">Water Vaporized:</b><br>
                ${(water_vaporized/1e12).toFixed(2)} trillion kg<br>
                <span style="font-size: 0.85em; color: #aaa;">Enough to fill ${(water_vaporized/1e9).toFixed(0)} Olympic pools</span>
            </div>
            <div style="background: rgba(30,144,255,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #1E90FF;">
                <b style="color: #1E90FF;">Steam Plume Height:</b><br>
                ${(Math.pow(E_megatons, 0.3) * 30).toFixed(1)} km<br>
                <span style="font-size: 0.85em; color: #aaa;">Reaches stratosphere</span>
            </div>
            <div style="background: rgba(30,144,255,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #1E90FF;">
                <b style="color: #1E90FF;">Salt Aerosols:</b><br>
                ${(displaced_mass * 0.035 / 1e12).toFixed(2)} trillion kg<br>
                <span style="font-size: 0.85em; color: #aaa;">Global atmospheric distribution</span>
            </div>
            <div style="background: rgba(30,144,255,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #1E90FF;">
                <b style="color: #1E90FF;">Climate Impact Duration:</b><br>
                ${(Math.log10(E_megatons) * 6).toFixed(0)} months<br>
                <span style="font-size: 0.85em; color: #aaa;">Increased humidity, rainfall changes</span>
            </div>
        </div>
    </div>

    <div class="info-section" style="background: #001a33; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0; color: #1E90FF;">‚ö†Ô∏è Secondary Effects</h3>
        <ul style="margin: 5px 0; padding-left: 20px; line-height: 1.8; font-size: 0.9em;">
            <li><b>Seiche Waves:</b> Oscillating waves in enclosed bays and harbors lasting hours to days</li>
            <li><b>Rogue Waves:</b> Individual waves reaching ${(initial_amplitude * 1.5).toFixed(0)}m+ in deep ocean</li>
            <li><b>Underwater Landslides:</b> Continental shelf collapses generating secondary tsunamis</li>
            <li><b>Resonance Effects:</b> Amplified waves in certain coastal geometries and harbors</li>
            <li><b>Multiple Wave Trains:</b> Series of ${Math.floor(Math.sqrt(E_megatons))} major waves over ${(wave_period * Math.sqrt(E_megatons) / 60).toFixed(0)} minutes</li>
            <li><b>Acoustic Shock:</b> Underwater pressure wave kills marine life within ${(transient_crater_diameter/1000).toFixed(0)} km</li>
            <li><b>Ocean Current Disruption:</b> Thermohaline circulation affected for months</li>
        </ul>
    </div>

    <div class="info-section" style="background: linear-gradient(135deg, #001f3f 0%, #003d7a 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #1E90FF;">
        <h3 style="margin: 0 0 10px 0; color: #1E90FF;">üìä Impact Statistics</h3>
        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px;">
            <b>Total Coastal Population at Risk:</b> ${formatLargeNumberWords(minor_casualties)} people<br>
            <b>Immediate Inundation Zone:</b> ${formatLargeNumberWords(mega_casualties)} people<br>
            <b>Critical Evacuation Zone:</b> ${formatLargeNumberWords(major_casualties - mega_casualties)} people<br>
            <b>Extended Warning Zone:</b> ${formatLargeNumberWords(moderate_casualties - major_casualties)} people<br><br>
            <b style="color: #FFD700;">Estimated Fatalities:</b> ${formatLargeNumberWords(Math.floor(mega_casualties * 0.8 + major_casualties * 0.3))} people<br>
            <b style="color: #FFD700;">Infrastructure Loss:</b> $${(mega_casualties * 50000 / 1e9).toFixed(0)} trillion USD<br>
            <b style="color: #FFD700;">Ships Destroyed:</b> ${Math.floor(mega_casualties / 10000)} vessels within mega-tsunami zone
        </div>
    </div>

    <div class="info-section" style="background: linear-gradient(135deg, #2d5016 0%, #4a7c23 100%); padding: 15px; border-radius: 8px; margin-top: 15px;">
        <h3 style="margin: 0 0 10px 0; color: white;">üö® Warning & Evacuation Timeline</h3>
        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; font-size: 0.9em;">
            <b>Detection to Impact:</b> Varies (hours to years depending on advance warning)<br>
            <b>Tsunami Generation:</b> Instantaneous at impact<br>
            <b>First Wave Arrival (50 km coast):</b> ${getArrivalTime(50000).toFixed(0)} minutes<br>
            <b>First Wave Arrival (500 km coast):</b> ${(getArrivalTime(500000)/60).toFixed(1)} hours<br>
            <b>First Wave Arrival (2000 km coast):</b> ${(getArrivalTime(2000000)/60).toFixed(1)} hours<br>
            <b>Wave Train Duration:</b> ${(wave_period * Math.sqrt(E_megatons) / 3600).toFixed(1)} hours<br>
            <b>All-Clear Time:</b> ${(wave_period * Math.sqrt(E_megatons) / 3600 * 2).toFixed(0)} hours after last major wave
        </div>
    </div>

    <div class="info-section" style="background: #1a0033; padding: 15px; border-radius: 8px; margin-top: 15px; border: 2px solid #1E90FF;">
        <h3 style="margin: 0 0 10px 0; color: #1E90FF;">üõ°Ô∏è Survival & Protection Measures</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.9em;">
            <div style="background: rgba(30,144,255,0.15); padding: 10px; border-radius: 5px;">
                <b style="color: #4169E1;">‚úì Effective Actions:</b>
                <ul style="margin: 5px 0; padding-left: 15px; line-height: 1.5;">
                    <li>Move to high ground (>100m elevation)</li>
                    <li>Move inland (>5 km from coast)</li>
                    <li>Evacuate immediately upon warning</li>
                    <li>Seek upper floors of strong concrete buildings</li>
                    <li>Avoid harbors, rivers, beaches</li>
                </ul>
            </div>
            <div style="background: rgba(255,0,0,0.15); padding: 10px; border-radius: 5px;">
                <b style="color: #FF6347;">‚úó Dangerous Actions:</b>
                <ul style="margin: 5px 0; padding-left: 15px; line-height: 1.5;">
                    <li>Staying near coast to watch</li>
                    <li>Returning after first wave</li>
                    <li>Taking boats to deep water</li>
                    <li>Sheltering in vehicles or wood structures</li>
                    <li>Underestimating wave arrival time</li>
                </ul>
            </div>
        </div>
    </div>
    `;
}

async function initWaterCharts() {
    if (!asteroidData) return;
    
    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const E_megatons = E_joules / 4.184e15;
    
    const ocean_depth = 4000;
    const g = 9.81;
    const initial_amplitude = Math.pow(E_megatons, 0.5) * 50;
    const tsunami_speed = Math.sqrt(g * ocean_depth);
    
    function getTsunamiHeight(distance_m) {
        const distance_km = distance_m / 1000;
        if (distance_km < 10) return initial_amplitude;
        const amplitude = initial_amplitude * Math.sqrt(10 / distance_km);
        const friction_loss = Math.exp(-distance_km / 1000);
        return amplitude * friction_loss;
    }
    
    function getCoastalWaveHeight(deep_water_height) {
        const amplification_factor = Math.pow(ocean_depth / 10, 0.25);
        return deep_water_height * amplification_factor * 2;
    }
    
    function getArrivalTime(distance_m) {
        return distance_m / tsunami_speed / 60;
    }
    
    const mega_casualties = await fetchPopulation(asteroidData.lat, asteroidData.lon, 50);
    const major_casualties = await fetchPopulation(asteroidData.lat, asteroidData.lon, 200);
    const moderate_casualties = await fetchPopulation(asteroidData.lat, asteroidData.lon, 500);
    const minor_casualties = await fetchPopulation(asteroidData.lat, asteroidData.lon, 1000);
    
    // Chart 1: Tsunami Wave Height vs Distance
    const distances = [];
    const deepWaterHeights = [];
    const coastalHeights = [];
    
    for (let d = 10; d <= 2000; d += 20) {
        distances.push(d);
        const deepHeight = getTsunamiHeight(d * 1000);
        deepWaterHeights.push(deepHeight);
        coastalHeights.push(getCoastalWaveHeight(deepHeight));
    }

    new Chart(document.getElementById('tsunamiHeightChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: distances.map(d => d + ' km'),
            datasets: [{
                label: 'Deep Water Wave Height (m)',
                data: deepWaterHeights,
                borderColor: '#1E90FF',
                backgroundColor: 'rgba(30,144,255,0.2)',
                fill: true,
                tension: 0.4,
                borderWidth: 3,
                pointRadius: 0
            }, {
                label: 'Coastal Wave Height (m)',
                data: coastalHeights,
                borderColor: '#FF6347',
                backgroundColor: 'rgba(255,99,71,0.2)',
                fill: true,
                tension: 0.4,
                borderWidth: 3,
                pointRadius: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: 'white' }
                },
                title: {
                    display: true,
                    text: 'Tsunami Wave Height vs Distance from Impact',
                    color: 'white',
                    font: { size: 14 }
                }
            },
            scales: {
                y: {
                    type: 'logarithmic',
                    ticks: { color: 'white' },
                    grid: { color: '#333' },
                    title: {
                        display: true,
                        text: 'Wave Height (m, log scale)',
                        color: 'white'
                    }
                },
                x: {
                    ticks: { 
                        color: 'white',
                        maxTicksLimit: 15
                    },
                    grid: { color: '#333' },
                    title: {
                        display: true,
                        text: 'Distance from Impact',
                        color: 'white'
                    }
                }
            }
        }
    });
    
    // Chart 2: Tsunami Arrival Time
    const arrivalDistances = [50, 100, 200, 500, 1000, 1500, 2000];
    const arrivalTimes = arrivalDistances.map(d => getArrivalTime(d * 1000));
    
    new Chart(document.getElementById('arrivalTimeChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: arrivalDistances.map(d => d + ' km'),
            datasets: [{
                label: 'Tsunami Arrival Time (minutes)',
                data: arrivalTimes,
                backgroundColor: [
                    'rgba(255,0,0,0.8)',
                    'rgba(255,69,0,0.8)',
                    'rgba(255,140,0,0.8)',
                    'rgba(30,144,255,0.8)',
                    'rgba(65,105,225,0.8)',
                    'rgba(135,206,235,0.8)',
                    'rgba(176,224,230,0.8)'
                ],
                borderColor: '#1E90FF',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: 'white' }
                },
                title: {
                    display: true,
                    text: 'Tsunami Arrival Time by Distance',
                    color: 'white',
                    font: { size: 14 }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const minutes = context.parsed.y;
                            const hours = (minutes / 60).toFixed(1);
                            return `${minutes.toFixed(0)} minutes (${hours} hours)`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    ticks: { color: 'white' },
                    grid: { color: '#333' },
                    title: {
                        display: true,
                        text: 'Arrival Time (minutes)',
                        color: 'white'
                    }
                },
                x: {
                    ticks: { color: 'white' },
                    grid: { color: '#333' },
                    title: {
                        display: true,
                        text: 'Coastal Distance from Impact',
                        color: 'white'
                    }
                }
            }
        }
    });
    
    // Chart 3: Population Exposure by Zone
    new Chart(document.getElementById('waterCasualtiesChart').getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: ['Mega-Tsunami (0-50km)', 'Major Tsunami (50-200km)', 'Moderate (200-500km)', 'Minor (500-1000km)'],
            datasets: [{
                data: [
                    mega_casualties,
                    major_casualties - mega_casualties,
                    moderate_casualties - major_casualties,
                    minor_casualties - moderate_casualties
                ],
                backgroundColor: [
                    'rgba(0,0,128,0.8)',
                    'rgba(0,0,205,0.8)',
                    'rgba(65,105,225,0.8)',
                    'rgba(135,206,235,0.8)'
                ],
                borderColor: '#001f3f',
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { 
                        color: 'white',
                        font: { size: 11 }
                    },
                    position: 'bottom'
                },
                title: {
                    display: true,
                    text: 'Coastal Population Exposure by Tsunami Zone',
                    color: 'white',
                    font: { size: 14 }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value.toLocaleString()} people (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}


function showWindMap() {
    // Bail if no data
    if (!asteroidData) return;

    // Remove previous wind map layer, if any
    if (currentMapLayer) {
        mainMap.removeLayer(currentMapLayer);
        currentMapLayer = null;
    }
    // Atmospheric filtering model
    function willAsteroidReachGround(data) {
        const r_m = data.radius;
        const v = data.velocity * 1000;
        const min_ground_impact_radius = 25;
        const velocity_factor = v / 15000;
        const effective_min_radius = min_ground_impact_radius / Math.sqrt(velocity_factor);
        return r_m > effective_min_radius;
    }

    // Physical constants and asteroid parameters
    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const m = (4 / 3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const E_megatons = E_joules / 4.184e15;

    // Overpressure at distance (m)
    function getOverpressure(distance_m) {
        const distance_km = distance_m / 1000;
        const scaled_distance = distance_km / Math.pow(E_megatons, 1/3);
        if (scaled_distance < 0.1) return 1000; // Extreme pressure close-in
        return 6.7 / Math.pow(scaled_distance, 3) + 1 / Math.pow(scaled_distance, 2);
    }

    // Overpressure (bar) to wind speed (m/s)
    function overpressureToWindSpeed(overpressure_bar) {
        const overpressure_pa = overpressure_bar * 100000;
        return Math.sqrt((2 * overpressure_pa) / 1.225);
    }

    // Binary search for radius at given wind speed (m/s)
    function getDistanceForWindSpeed(target_wind_speed_ms) {
        let low = r_m, high = 500000, mid;
        while (high - low > 50) {
            mid = (low + high) / 2;
            const wind_speed = overpressureToWindSpeed(getOverpressure(mid));
            if (wind_speed > target_wind_speed_ms) low = mid;
            else high = mid;
        }
        return (low + high) / 2;
    }

    // Wind speed thresholds (m/s)
    const thresholds = [
        { speed: 3830, color: '#000000', label: 'üí® Hypersonic Winds', fillOpacity: 0.9, description: 'Complete molecular disintegration' },
        { speed: 400, color: '#4B0082', label: 'üå™Ô∏è Faster Than Jupiter Storms', fillOpacity: 0.75, description: 'Total obliteration' },
        { speed: 135, color: '#8B0000', label: 'üèöÔ∏è Total Building Destruction', fillOpacity: 0.6, description: 'All structures leveled' },
        { speed: 89, color: '#FF4500', label: 'üå™Ô∏è EF5 Tornado Conditions', fillOpacity: 0.45, description: 'Homes destroyed, vehicles airborne' },
        { speed: 50, color: '#FFA500', label: 'üè† Severe Structural Damage', fillOpacity: 0.3, description: 'Roofs torn, walls collapsed' },
        { speed: 33, color: '#90EE90', label: 'üå≤ Tree Destruction Zone', fillOpacity: 0.15, description: 'Most trees uprooted' }
    ];

    // Cap radii to avoid giant circles
    const MAX_RADIUS_METERS = 200000; // 200km
    const zones = thresholds.map(th => {
        const r = getDistanceForWindSpeed(th.speed);
        return {
            ...th,
            radius: Math.min(r, MAX_RADIUS_METERS),
            details: `Wind Speed: >${th.speed} m/s<br>Max radius: ${(Math.min(r, MAX_RADIUS_METERS)/1000).toFixed(2)} km`
        };
    });

    // Only keep zones with radius > asteroid and radius > 0
    const validZones = zones.filter(z => z.radius > r_m && z.radius > 0);

    // New layer group
    const windLayer = L.layerGroup();

    // Draw wind zones (largest first)
    validZones.sort((a, b) => b.radius - a.radius).forEach(zone => {
        L.circle([asteroidData.lat, asteroidData.lon], {
            radius: zone.radius,
            color: zone.color,
            fillColor: zone.color,
            fillOpacity: zone.fillOpacity,
            weight: 2
        }).addTo(windLayer).bindPopup(`<b>${zone.label}</b><br>${zone.details}<br>${zone.description}`);
    });

    // Add impact marker
    L.marker([asteroidData.lat, asteroidData.lon], {
        icon: L.divIcon({
            className: 'impact-marker',
            html: '<div style="background: #ff0000; width: 20px; height: 20px; border-radius: 50%; border: 3px solid #000; box-shadow: 0 0 20px rgba(255,0,0,1);"></div>',
            iconSize: [20, 20]
        })
    }).addTo(windLayer).bindPopup(`
        <b>Impact Ground Zero</b><br>
        Peak Wind: ${(overpressureToWindSpeed(getOverpressure(100)) * 2.237).toFixed(0)} mph<br>
        Peak Overpressure: ${getOverpressure(100).toFixed(1)} bar<br>
        Blast Wave Speed: ${(Math.pow(E_megatons, 0.25) * 1000).toFixed(0)} m/s
    `);

    // Add to map and assign for later cleanup
    windLayer.addTo(mainMap);
    currentMapLayer = windLayer;
    // Fit to largest valid radius or skip if none
    if (validZones.length) {
        const maxR = Math.max(...validZones.map(z => z.radius));
        const lat = asteroidData.lat, lon = asteroidData.lon;
        mainMap.fitBounds([
            [lat - maxR/111320, lon - maxR/(111320 * Math.cos(lat * Math.PI / 180))],
            [lat + maxR/111320, lon + maxR/(111320 * Math.cos(lat * Math.PI / 180))]
        ]);
    }
}


async function generateWindContent() {
    if (!asteroidData) return "<p>Loading data...</p>";
    
    // Check if asteroid will reach the ground
    if (!willAsteroidReachGround(asteroidData)) {
        const oldMessage = document.getElementById("windMessage");
        if (oldMessage) oldMessage.remove();
        
        const messageDiv = document.createElement("div");
        messageDiv.id = "windMessage";
        messageDiv.style.position = "fixed";
        messageDiv.style.top = "50%";
        messageDiv.style.left = "50%";
        messageDiv.style.transform = "translate(-50%, -50%)";
        messageDiv.style.backgroundColor = "#2196F3";
        messageDiv.style.color = "white";
        messageDiv.style.padding = "30px 40px";
        messageDiv.style.borderRadius = "12px";
        messageDiv.style.boxShadow = "0 4px 15px rgba(0,0,0,0.3)";
        messageDiv.style.textAlign = "center";
        messageDiv.style.zIndex = "9999";
        messageDiv.innerHTML = `
            <h2>üí® Atmospheric Airburst</h2>
            <p>The asteroid will explode in the atmosphere.<br><b>Wind effects still occur but from airburst altitude.</b></p>
            <button id="closeWindMessage" style="
                margin-top: 15px;
                padding: 8px 15px;
                background: white;
                color: #2196F3;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: bold;
            ">Close</button>
        `;
        
        document.body.appendChild(messageDiv);
        
        document.getElementById("closeWindMessage").addEventListener("click", () => {
            messageDiv.remove();
        });
    }
    
    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const E_megatons = E_joules / 4.184e15;
    
    // Wind speed calculations
    function getOverpressure(distance_m) {
        const distance_km = distance_m / 1000;
        const scaled_distance = distance_km / Math.pow(E_megatons, 1/3);
        if (scaled_distance < 0.1) return 1000;
        return 6.7 / Math.pow(scaled_distance, 3) + 1 / Math.pow(scaled_distance, 2);
    }
    
    function overpressureToWindSpeed(overpressure_bar) {
        const overpressure_pa = overpressure_bar * 100000;
        return Math.sqrt((2 * overpressure_pa) / 1.225);
    }
    
    function getDistanceForWindSpeed(target_wind_speed_ms) {
        let low = r_m;
        let high = 500000;
        
        while (high - low > 100) {
            const mid = (low + high) / 2;
            const overpressure = getOverpressure(mid);
            const wind_speed = overpressureToWindSpeed(overpressure);
            
            if (wind_speed > target_wind_speed_ms) {
                low = mid;
            } else {
                high = mid;
            }
        }
        
        return (low + high) / 2;
    }
    
    const hypersonic_radius = getDistanceForWindSpeed(3830);
    const jupiter_radius = getDistanceForWindSpeed(400);
    const total_destruction_radius = getDistanceForWindSpeed(135);
    const ef5_radius = getDistanceForWindSpeed(89);
    const severe_damage_radius = getDistanceForWindSpeed(50);
    const tree_destruction_radius = getDistanceForWindSpeed(33);
    
    // Peak wind speed at impact
    const peak_wind_speed_ms = overpressureToWindSpeed(getOverpressure(100));
    const peak_wind_speed_mph = peak_wind_speed_ms * 2.237;
    const peak_wind_speed_kmh = peak_wind_speed_ms * 3.6;
    
    // Blast wave arrival times
    const blast_wave_speed = Math.pow(E_megatons, 0.25) * 340; // m/s
    
    function getArrivalTime(distance_m) {
        return distance_m / blast_wave_speed;
    }
    
    // Population casualties
    const casualties_hypersonic = await fetchPopulation(asteroidData.lat, asteroidData.lon, hypersonic_radius/1000);
    const casualties_jupiter = await fetchPopulation(asteroidData.lat, asteroidData.lon, jupiter_radius/1000);
    const casualties_total_destruction = await fetchPopulation(asteroidData.lat, asteroidData.lon, total_destruction_radius/1000);
    const casualties_ef5 = await fetchPopulation(asteroidData.lat, asteroidData.lon, ef5_radius/1000);
    const casualties_severe = await fetchPopulation(asteroidData.lat, asteroidData.lon, severe_damage_radius/1000);
    const casualties_trees = await fetchPopulation(asteroidData.lat, asteroidData.lon, tree_destruction_radius/1000);
    
    // Total wind-related deaths (mainly from building collapse and debris)
    const total_wind_deaths = Math.floor(
        casualties_hypersonic * 1.0 + 
        (casualties_jupiter - casualties_hypersonic) * 1.0 +
        (casualties_total_destruction - casualties_jupiter) * 0.95 +
        (casualties_ef5 - casualties_total_destruction) * 0.70 +
        (casualties_severe - casualties_ef5) * 0.30 +
        (casualties_trees - casualties_severe) * 0.05
    );
    
    return `
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; background-color: #007BFF; padding: 10px; border-radius: 5px;">
        <div>
            <span style="color: white;"><b>Peak Wind Speed:</b></span> ${formatLargeNumberWords(peak_wind_speed_mph)} mph (${formatLargeNumberWords(peak_wind_speed_kmh)} km/h)<br>
            <span style="color: white;"><b>Peak Overpressure:</b></span> ${getOverpressure(100).toFixed(1)} bar (${(getOverpressure(100) * 14.5).toFixed(0)} psi)<br>
            <span style="color: white;"><b>Blast Wave Speed:</b></span> ${(blast_wave_speed).toFixed(0)} m/s (Mach ${(blast_wave_speed/340).toFixed(1)})<br>
            <span style="color: white;"><b>Total Wind Deaths:</b></span> ${formatLargeNumberWords(total_wind_deaths)} people
        </div>
        <div>
            <span style="color: white;"><b>Dynamic Pressure:</b></span> ${((0.5 * 1.225 * Math.pow(peak_wind_speed_ms, 2))/1000).toFixed(0)} kPa<br>
            <span style="color: white;"><b>Blast Duration:</b></span> ${(Math.pow(E_megatons, 0.33) * 2).toFixed(1)} seconds<br>
            <span style="color: white;"><b>Max Debris Velocity:</b></span> ${(peak_wind_speed_mph * 0.6).toFixed(0)} mph<br>
            <span style="color: white;"><b>Affected Area:</b></span> ${formatLargeNumberWords(Math.PI * Math.pow(tree_destruction_radius/1000, 2))} km¬≤
        </div>
    </div>
    

    <div class="info-section" style="background: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0; color: #00d4ff;">üí® Blast Wave Visualization</h3>
        <div style="position: relative; height: 300px; background: radial-gradient(circle, #000000 0%, #4B0082 10%, #8B0000 25%, #FF4500 45%, #FFA500 65%, #90EE90 85%, #1a1a2e 100%); border-radius: 8px; overflow: hidden;">
            <svg width="100%" height="100%" viewBox="0 0 400 300" style="position: absolute; top: 0; left: 0;">
                <!-- Impact point -->
                <circle cx="200" cy="150" r="6" fill="#ff0000" stroke="white" stroke-width="2"/>
                
                <!-- Expanding blast waves -->
                <circle cx="200" cy="150" r="20" fill="none" stroke="white" stroke-width="3" opacity="0.9"/>
                <circle cx="200" cy="150" r="40" fill="none" stroke="#4B0082" stroke-width="3" opacity="0.8"/>
                <circle cx="200" cy="150" r="60" fill="none" stroke="#8B0000" stroke-width="3" opacity="0.7"/>
                <circle cx="200" cy="150" r="80" fill="none" stroke="#FF4500" stroke-width="2" opacity="0.6"/>
                <circle cx="200" cy="150" r="100" fill="none" stroke="#FFA500" stroke-width="2" opacity="0.5"/>
                <circle cx="200" cy="150" r="130" fill="none" stroke="#90EE90" stroke-width="2" opacity="0.4"/>
                
                <!-- Wind speed arrows -->
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                        <polygon points="0 0, 10 3, 0 6" fill="#00d4ff" />
                    </marker>
                </defs>
                
                <!-- Radial wind arrows -->
                <line x1="200" y1="150" x2="260" y2="150" stroke="#00d4ff" stroke-width="2" marker-end="url(#arrowhead)"/>
                <line x1="200" y1="150" x2="170" y2="100" stroke="#00d4ff" stroke-width="2" marker-end="url(#arrowhead)"/>
                <line x1="200" y1="150" x2="140" y2="150" stroke="#00d4ff" stroke-width="2" marker-end="url(#arrowhead)"/>
                <line x1="200" y1="150" x2="230" y2="200" stroke="#00d4ff" stroke-width="2" marker-end="url(#arrowhead)"/>
                
                <!-- Labels -->
                <text x="200" y="145" text-anchor="middle" fill="white" font-size="11" font-weight="bold">GROUND</text>
                <text x="200" y="158" text-anchor="middle" fill="white" font-size="11" font-weight="bold">ZERO</text>
                <text x="270" y="155" text-anchor="start" fill="white" font-size="10">${(peak_wind_speed_mph).toFixed(0)} mph</text>
                <text x="175" y="95" text-anchor="middle" fill="white" font-size="9">Hypersonic</text>
                <text x="320" y="155" text-anchor="start" fill="#90EE90" font-size="9">Tree zone</text>
            </svg>
        </div>
        <p style="margin: 10px 0 0 0; font-size: 0.85em; color: #aaa; text-align: center;">
            Blast wave propagation showing wind speed zones radiating from impact (top view)
        </p>
    </div>

    <div class="info-section" style="background: linear-gradient(135deg, #000000 0%, #4B0082 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #00d4ff;">
        <h3 style="margin: 0 0 10px 0; color: white;">üå™Ô∏è Wind Damage Zones</h3>
        
        <div style="background: rgba(0,0,0,0.5); padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #ffffff;">
            <h4 style="margin: 0 0 8px 0; color: #fff;">üí® Hypersonic Winds (>8,560 mph)</h4>
            <b>Radius:</b> ${(hypersonic_radius/1000).toFixed(2)} km (${(hypersonic_radius/1609).toFixed(1)} miles)<br>
            <b>Wind Speed:</b> ${(overpressureToWindSpeed(getOverpressure(hypersonic_radius)) * 2.237).toFixed(0)} mph<br>
            <b>Overpressure:</b> ${getOverpressure(hypersonic_radius).toFixed(1)} bar<br>
            <b>Effects:</b> Complete molecular disintegration, nothing recognizable remains, ground scoured to bedrock<br>
            <b>Arrival Time:</b> ${getArrivalTime(hypersonic_radius).toFixed(1)} seconds<br>
            <b>Casualties:</b> ${formatLargeNumberWords(casualties_hypersonic)} (100% fatality)
        </div>

        <div style="background: rgba(75,0,130,0.4); padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #4B0082;">
            <h4 style="margin: 0 0 8px 0; color: #fff;">üåÄ Faster Than Jupiter Storms (>900 mph)</h4>
            <b>Radius:</b> ${(jupiter_radius/1000).toFixed(2)} km (${(jupiter_radius/1609).toFixed(1)} miles)<br>
            <b>Wind Speed:</b> ${(overpressureToWindSpeed(getOverpressure(jupiter_radius)) * 2.237).toFixed(0)} mph<br>
            <b>Overpressure:</b> ${getOverpressure(jupiter_radius).toFixed(2)} bar<br>
            <b>Effects:</b> Total obliteration of all structures, reinforced concrete pulverized, vehicles become supersonic projectiles<br>
            <b>Comparison:</b> Exceeds wind speeds in Jupiter's Great Red Spot (400 mph)<br>
            <b>Arrival Time:</b> ${getArrivalTime(jupiter_radius).toFixed(1)} seconds<br>
            <b>Casualties:</b> ${formatLargeNumberWords(casualties_jupiter - casualties_hypersonic)} additional (100% fatality)
        </div>

        <div style="background: rgba(139,0,0,0.4); padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #8B0000;">
            <h4 style="margin: 0 0 8px 0; color: #fff;">üèöÔ∏è Total Building Destruction (>300 mph)</h4>
            <b>Radius:</b> ${(total_destruction_radius/1000).toFixed(2)} km (${(total_destruction_radius/1609).toFixed(1)} miles)<br>
            <b>Wind Speed:</b> ${(overpressureToWindSpeed(getOverpressure(total_destruction_radius)) * 2.237).toFixed(0)} mph<br>
            <b>Overpressure:</b> ${getOverpressure(total_destruction_radius).toFixed(2)} bar<br>
            <b>Effects:</b> All buildings leveled regardless of construction, steel-reinforced structures collapse, debris field of unrecognizable material<br>
            <b>Arrival Time:</b> ${getArrivalTime(total_destruction_radius).toFixed(1)} seconds<br>
            <b>Casualties:</b> ${formatLargeNumberWords(casualties_total_destruction - casualties_jupiter)} additional (95% fatality)
        </div>

        <div style="background: rgba(255,69,0,0.3); padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #FF4500;">
            <h4 style="margin: 0 0 8px 0; color: #fff;">üå™Ô∏è EF5 Tornado Conditions (>200 mph)</h4>
            <b>Radius:</b> ${(ef5_radius/1000).toFixed(2)} km (${(ef5_radius/1609).toFixed(1)} miles)<br>
            <b>Wind Speed:</b> ${(overpressureToWindSpeed(getOverpressure(ef5_radius)) * 2.237).toFixed(0)} mph<br>
            <b>Overpressure:</b> ${getOverpressure(ef5_radius).toFixed(2)} bar<br>
            <b>Effects:</b> Well-built homes destroyed, cars and trucks thrown hundreds of meters, people become lethal projectiles<br>
            <b>Comparison:</b> Equivalent to the most violent tornadoes ever recorded<br>
            <b>Arrival Time:</b> ${(getArrivalTime(ef5_radius)/60).toFixed(1)} minutes<br>
            <b>Casualties:</b> ${formatLargeNumberWords(casualties_ef5 - casualties_total_destruction)} additional (70% fatality)
        </div>

        <div style="background: rgba(255,165,0,0.2); padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #FFA500;">
            <h4 style="margin: 0 0 8px 0; color: #fff;">üè† Severe Structural Damage (>112 mph)</h4>
            <b>Radius:</b> ${(severe_damage_radius/1000).toFixed(2)} km (${(severe_damage_radius/1609).toFixed(1)} miles)<br>
            <b>Wind Speed:</b> ${(overpressureToWindSpeed(getOverpressure(severe_damage_radius)) * 2.237).toFixed(0)} mph<br>
            <b>Overpressure:</b> ${getOverpressure(severe_damage_radius).toFixed(3)} bar<br>
            <b>Effects:</b> Roofs torn off, exterior walls collapsed, windows shattered, mobile homes destroyed, flying debris causes mass casualties<br>
            <b>Arrival Time:</b> ${(getArrivalTime(severe_damage_radius)/60).toFixed(1)} minutes<br>
            <b>Casualties:</b> ${formatLargeNumberWords(casualties_severe - casualties_ef5)} additional (30% fatality)
        </div>

        <div style="background: rgba(144,238,144,0.15); padding: 12px; border-radius: 6px; border-left: 3px solid #90EE90;">
            <h4 style="margin: 0 0 8px 0; color: #fff;">üå≤ Tree Destruction Zone (>75 mph)</h4>
            <b>Radius:</b> ${(tree_destruction_radius/1000).toFixed(2)} km (${(tree_destruction_radius/1609).toFixed(1)} miles)<br>
            <b>Wind Speed:</b> ${(overpressureToWindSpeed(getOverpressure(tree_destruction_radius)) * 2.237).toFixed(0)} mph<br>
            <b>Overpressure:</b> ${getOverpressure(tree_destruction_radius).toFixed(3)} bar<br>
            <b>Effects:</b> Nearly all trees uprooted or snapped, power lines down, significant roof damage, broken windows, outdoor structures destroyed<br>
            <b>Arrival Time:</b> ${(getArrivalTime(tree_destruction_radius)/60).toFixed(1)} minutes<br>
            <b>Casualties:</b> ${formatLargeNumberWords(casualties_trees - casualties_severe)} additional (5% fatality)
        </div>
    </div>

    <div class="chart-container" style="margin-bottom: 15px;">
        <canvas id="windZonesChart" height="200"></canvas>
    </div>

    <div class="chart-container" style="margin-bottom: 15px;">
        <canvas id="windSpeedDistanceChart" height="220"></canvas>
    </div>

    <div class="chart-container" style="margin-bottom: 15px;">
        <canvas id="windCasualtiesChart" height="200"></canvas>
    </div>

    <div class="info-section" style="background: #0f3460; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0; color: #00d4ff;">‚è±Ô∏è Blast Wave Timeline</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; font-size: 0.9em;">
                <div style="background: rgba(0,212,255,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #00d4ff;">
                    <b style="color: #00d4ff;">T+0.0s:</b><br>Impact<br>
                    <span style="font-size: 0.85em; color: #aaa;">Ground zero detonation</span>
                </div>
                <div style="background: rgba(0,212,255,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #00d4ff;">
                    <b style="color: #00d4ff;">T+${getArrivalTime(hypersonic_radius).toFixed(1)}s:</b><br>Hypersonic zone<br>
                    <span style="font-size: 0.85em; color: #aaa;">${(hypersonic_radius/1609).toFixed(1)} miles</span>
                </div>
                <div style="background: rgba(0,212,255,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #00d4ff;">
                    <b style="color: #00d4ff;">T+${getArrivalTime(jupiter_radius).toFixed(1)}s:</b><br>Jupiter winds<br>
                    <span style="font-size: 0.85em; color: #aaa;">${(jupiter_radius/1609).toFixed(1)} miles</span>
                </div>
                <div style="background: rgba(0,212,255,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #00d4ff;">
                    <b style="color: #00d4ff;">T+${(getArrivalTime(total_destruction_radius)/60).toFixed(1)}min:</b><br>Total destruction<br>
                    <span style="font-size: 0.85em; color: #aaa;">${(total_destruction_radius/1609).toFixed(1)} miles</span>
                </div>
                <div style="background: rgba(0,212,255,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #00d4ff;">
                    <b style="color: #00d4ff;">T+${(getArrivalTime(ef5_radius)/60).toFixed(1)}min:</b><br>EF5 tornado<br>
                    <span style="font-size: 0.85em; color: #aaa;">${(ef5_radius/1609).toFixed(1)} miles</span>
                </div>
                <div style="background: rgba(0,212,255,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #00d4ff;">
                    <b style="color: #00d4ff;">T+${(getArrivalTime(tree_destruction_radius)/60).toFixed(1)}min:</b><br>Tree destruction<br>
                    <span style="font-size: 0.85em; color: #aaa;">${(tree_destruction_radius/1609).toFixed(1)} miles</span>
                </div>
            </div>
        </div>

        <div class="info-section" style="background: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <h3 style="margin: 0 0 10px 0; color: #ff6600;">üí• Debris and Projectiles</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
                <div style="background: rgba(255,102,0,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #ff6600;">
                    <b style="color: #ff6600;">Maximum Debris Velocity:</b><br>
                    ${(peak_wind_speed_mph * 0.6).toFixed(0)} mph<br>
                    <span style="font-size: 0.85em; color: #aaa;">Large objects become supersonic missiles</span>
                </div>
                <div style="background: rgba(255,102,0,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #ff6600;">
                    <b style="color: #ff6600;">Lethal Debris Range:</b><br>
                    ${(ef5_radius/1000 * 1.5).toFixed(1)} km<br>
                    <span style="font-size: 0.85em; color: #aaa;">Cars, trucks, building materials airborne</span>
                </div>
                <div style="background: rgba(255,102,0,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #ff6600;">
                    <b style="color: #ff6600;">Human Body Displacement:</b><br>
                    Up to ${(peak_wind_speed_mph * 0.3).toFixed(0)} meters<br>
                    <span style="font-size: 0.85em; color: #aaa;">People thrown like ragdolls in close zones</span>
                </div>
                <div style="background: rgba(255,102,0,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #ff6600;">
                    <b style="color: #ff6600;">Glass Fragment Velocity:</b><br>
                    ${(peak_wind_speed_mph * 0.8).toFixed(0)} mph<br>
                    <span style="font-size: 0.85em; color: #aaa;">Billions of glass shards become shrapnel</span>
                </div>
            </div>
        </div>

        <div class="info-section" style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <h3 style="margin: 0 0 10px 0; color: #00d4ff;">üèóÔ∏è Structural Damage Assessment</h3>
            <table style="width: 100%; font-size: 0.9em; border-collapse: collapse;">
                <thead>
                    <tr style="background: rgba(0,212,255,0.2); border-bottom: 2px solid #00d4ff;">
                        <th style="padding: 8px; text-align: left;">Structure Type</th>
                        <th style="padding: 8px; text-align: center;">Damage Radius</th>
                        <th style="padding: 8px; text-align: center;">Wind Speed</th>
                        <th style="padding: 8px; text-align: left;">Damage Level</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="border-bottom: 1px solid #444;">
                        <td style="padding: 8px;">Reinforced Concrete Bunkers</td>
                        <td style="padding: 8px; text-align: center;">${(jupiter_radius/1609).toFixed(1)} mi</td>
                        <td style="padding: 8px; text-align: center;">900+ mph</td>
                        <td style="padding: 8px;">Complete destruction</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #444;">
                        <td style="padding: 8px;">Steel-Frame Skyscrapers</td>
                        <td style="padding: 8px; text-align: center;">${(total_destruction_radius/1609).toFixed(1)} mi</td>
                        <td style="padding: 8px; text-align: center;">300+ mph</td>
                        <td style="padding: 8px;">Total collapse</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #444;">
                        <td style="padding: 8px;">Brick/Concrete Homes</td>
                        <td style="padding: 8px; text-align: center;">${(ef5_radius/1609).toFixed(1)} mi</td>
                        <td style="padding: 8px; text-align: center;">200+ mph</td>
                        <td style="padding: 8px;">Walls collapsed, rubble</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #444;">
                        <td style="padding: 8px;">Wood-Frame Houses</td>
                        <td style="padding: 8px; text-align: center;">${(severe_damage_radius/1609).toFixed(1)} mi</td>
                        <td style="padding: 8px; text-align: center;">112+ mph</td>
                        <td style="padding: 8px;">Destroyed beyond repair</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #444;">
                        <td style="padding: 8px;">Mobile Homes</td>
                        <td style="padding: 8px; text-align: center;">${(tree_destruction_radius/1609 * 0.8).toFixed(1)} mi</td>
                        <td style="padding: 8px; text-align: center;">75+ mph</td>
                        <td style="padding: 8px;">Disintegrated, scattered</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px;">Vehicles (Cars/Trucks)</td>
                        <td style="padding: 8px; text-align: center;">${(ef5_radius/1609).toFixed(1)} mi</td>
                        <td style="padding: 8px; text-align: center;">200+ mph</td>
                        <td style="padding: 8px;">Airborne, crushed</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="info-section" style="background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <h3 style="margin: 0 0 10px 0; color: white;">üöë Total Wind-Related Casualties</h3>
            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 6px;">
                <div style="font-size: 1.5em; font-weight: bold; margin-bottom: 10px;">
                    ${formatLargeNumberWords(total_wind_deaths)} Deaths
                </div>
                <div style="font-size: 0.95em; line-height: 1.7;">
                    <b>Primary Causes of Death:</b>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                        <li>Building collapse and crushing (45%): ${formatLargeNumberWords(Math.floor(total_wind_deaths * 0.45))} people</li>
                        <li>Flying debris impact (30%): ${formatLargeNumberWords(Math.floor(total_wind_deaths * 0.30))} people</li>
                        <li>Impact with stationary objects (15%): ${formatLargeNumberWords(Math.floor(total_wind_deaths * 0.15))} people</li>
                        <li>Asphyxiation from debris burial (7%): ${formatLargeNumberWords(Math.floor(total_wind_deaths * 0.07))} people</li>
                        <li>Other trauma (3%): ${formatLargeNumberWords(Math.floor(total_wind_deaths * 0.03))} people</li>
                    </ul>
                    <b>Injured (non-fatal):</b> ${formatLargeNumberWords(Math.floor(total_wind_deaths * 2.5))} additional casualties requiring medical attention
                </div>
            </div>
        </div>

        <div class="info-section" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #00d4ff;">
            <h3 style="margin: 0 0 10px 0; color: #00d4ff;">üí° Blast Wave Facts</h3>
            <ul style="margin: 5px 0; padding-left: 20px; line-height: 1.7; font-size: 0.9em;">
                <li>The blast wave is a supersonic shock front traveling faster than the speed of sound</li>
                <li>There are two phases: positive phase (pushing) and negative phase (suction) - both are deadly</li>
                <li>The negative phase can be 2-3 times longer than the positive phase, pulling debris back</li>
                <li>Wind speeds peak instantly - there is no "ramp up" period for preparation</li>
                <li>The blast wave reflects off surfaces, creating complex interference patterns that can amplify or reduce effects</li>
                <li>Valleys and urban canyons can channel winds, increasing destruction in specific corridors</li>
                <li>Being underground provides almost complete protection from blast effects</li>
                <li>The blast wave continues long after visible fireball dissipates</li>
                <li>Overpressure alone (without wind) can cause lethal injuries to lungs and internal organs</li>
                <li>Animals with air-filled cavities (lungs, intestines) are extremely vulnerable to overpressure</li>
            </ul>
        </div>

        <div class="info-section" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); padding: 15px; border-radius: 8px; margin-top: 15px; border: 2px solid #27ae60;">
            <h3 style="margin: 0 0 10px 0; color: white;">üõ°Ô∏è Survival Strategies</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.9em;">
                <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px;">
                    <b style="color: white;">‚úì Best Protection:</b>
                    <ul style="margin: 5px 0; padding-left: 15px; line-height: 1.5;">
                        <li>Underground shelters/basements</li>
                        <li>Center of concrete buildings</li>
                        <li>Below ground level</li>
                        <li>Away from windows and doors</li>
                        <li>Behind thick walls or earth</li>
                    </ul>
                </div>
                <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px;">
                    <b style="color: white;">‚ö†Ô∏è Critical Actions:</b>
                    <ul style="margin: 5px 0; padding-left: 15px; line-height: 1.5;">
                        <li>Get below ground immediately</li>
                        <li>Lie flat, face down</li>
                        <li>Cover head and neck</li>
                        <li>Stay clear of windows</li>
                        <li>Wait for both blast phases</li>
                    </ul>
                </div>
                <div style="background: rgba(192,57,43,0.3); padding: 10px; border-radius: 5px;">
                    <b style="color: white;">‚úó Death Traps:</b>
                    <ul style="margin: 5px 0; padding-left: 15px; line-height: 1.5;">
                        <li>Vehicles (become projectiles)</li>
                        <li>Above-ground structures</li>
                        <li>Near windows or glass</li>
                        <li>Open areas</li>
                        <li>Upper floors of buildings</li>
                    </ul>
                </div>
                <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px;">
                    <b style="color: white;">‚è∞ Warning Time:</b>
                    <ul style="margin: 5px 0; padding-left: 15px; line-height: 1.5;">
                        <li>Light flash: instant</li>
                        <li>Thermal pulse: 0-1 second</li>
                        <li>Blast wave: ${(getArrivalTime(severe_damage_radius)/60).toFixed(0)}-${(getArrivalTime(tree_destruction_radius)/60).toFixed(0)} minutes at outer zones</li>
                        <li>No warning at close range</li>
                        <li>Seconds to take cover</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="info-section" style="background: #34495e; padding: 15px; border-radius: 8px; margin-top: 15px;">
            <h3 style="margin: 0 0 10px 0; color: #00d4ff;">üìä Comparative Wind Speeds</h3>
            <div style="font-size: 0.9em; line-height: 1.8;">
                <b>Impact Peak Wind:</b> ${formatLargeNumberWords(peak_wind_speed_mph)} mph<br>
                <b>Jupiter's Great Red Spot:</b> 400 mph (${((peak_wind_speed_mph/400).toFixed(1))}x weaker)<br>
                <b>Neptune's Fastest Winds:</b> 1,200 mph (${((peak_wind_speed_mph/1200).toFixed(1))}x weaker)<br>
                <b>Strongest Tornado (EF5):</b> 200-300 mph (${((peak_wind_speed_mph/250).toFixed(1))}x weaker)<br>
                <b>Category 5 Hurricane:</b> 157+ mph (${((peak_wind_speed_mph/157).toFixed(1))}x weaker)<br>
                <b>Speed of Sound:</b> 767 mph (Mach ${(peak_wind_speed_mph/767).toFixed(1)})<br>
                <b>Commercial Jet Cruise:</b> 550 mph (${((peak_wind_speed_mph/550).toFixed(1))}x faster)
            </div>
        </div>
    `;
}

async function initWindCharts() {
    if (!asteroidData) return;
    
    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const E_megatons = E_joules / 4.184e15;
    
    function getOverpressure(distance_m) {
        const distance_km = distance_m / 1000;
        const scaled_distance = distance_km / Math.pow(E_megatons, 1/3);
        if (scaled_distance < 0.1) return 1000;
        return 6.7 / Math.pow(scaled_distance, 3) + 1 / Math.pow(scaled_distance, 2);
    }
    
    function overpressureToWindSpeed(overpressure_bar) {
        const overpressure_pa = overpressure_bar * 100000;
        return Math.sqrt((2 * overpressure_pa) / 1.225);
    }
    
    function getDistanceForWindSpeed(target_wind_speed_ms) {
        let low = r_m;
        let high = 500000;
        
        while (high - low > 100) {
            const mid = (low + high) / 2;
            const overpressure = getOverpressure(mid);
            const wind_speed = overpressureToWindSpeed(overpressure);
            
            if (wind_speed > target_wind_speed_ms) {
                low = mid;
            } else {
                high = mid;
            }
        }
        
        return (low + high) / 2;
    }
    
    const hypersonic_radius = getDistanceForWindSpeed(3830);
    const jupiter_radius = getDistanceForWindSpeed(400);
    const total_destruction_radius = getDistanceForWindSpeed(135);
    const ef5_radius = getDistanceForWindSpeed(89);
    const severe_damage_radius = getDistanceForWindSpeed(50);
    const tree_destruction_radius = getDistanceForWindSpeed(33);
    
    const casualties_hypersonic = await fetchPopulation(asteroidData.lat, asteroidData.lon, hypersonic_radius/1000);
    const casualties_jupiter = await fetchPopulation(asteroidData.lat, asteroidData.lon, jupiter_radius/1000);
    const casualties_total_destruction = await fetchPopulation(asteroidData.lat, asteroidData.lon, total_destruction_radius/1000);
    const casualties_ef5 = await fetchPopulation(asteroidData.lat, asteroidData.lon, ef5_radius/1000);
    const casualties_severe = await fetchPopulation(asteroidData.lat, asteroidData.lon, severe_damage_radius/1000);
    const casualties_trees = await fetchPopulation(asteroidData.lat, asteroidData.lon, tree_destruction_radius/1000);
    
    // Chart 1: Wind Zone Radii
    new Chart(document.getElementById('windZonesChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: ['Hypersonic\n(8,560+ mph)', 'Jupiter Storms\n(900+ mph)', 'Total Destruction\n(300+ mph)', 'EF5 Tornado\n(200+ mph)', 'Severe Damage\n(112+ mph)', 'Tree Destruction\n(75+ mph)'],
            datasets: [{
                label: 'Zone Radius (km)',
                data: [
                    hypersonic_radius / 1000,
                    jupiter_radius / 1000,
                    total_destruction_radius / 1000,
                    ef5_radius / 1000,
                    severe_damage_radius / 1000,
                    tree_destruction_radius / 1000
                ],
                backgroundColor: ['#000000', '#4B0082', '#8B0000', '#FF4500', '#FFA500', '#90EE90'],
                borderColor: '#00d4ff',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: 'white' }
                },
                title: {
                    display: true,
                    text: 'Wind Damage Zones by Radius',
                    color: 'white',
                    font: { size: 14 }
                }
            },
            scales: {
                y: {
                    type: 'logarithmic',
                    ticks: { color: 'white' },
                    grid: { color: '#333' },
                    title: {
                        display: true,
                        text: 'Radius (km, log scale)',
                        color: 'white'
                    }
                },
                x: {
                    ticks: { 
                        color: 'white',
                        font: { size: 9 }
                    },
                    grid: { color: '#333' }
                }
            }
        }
    });
    
    // Chart 2: Wind Speed vs Distance
    const distances = [];
    const windSpeeds = [];
    const overpressures = [];
    
    for (let d = hypersonic_radius; d <= tree_destruction_radius * 1.2; d += (tree_destruction_radius * 1.2 - hypersonic_radius) / 100) {
        distances.push((d / 1000).toFixed(2));
        const overpressure = getOverpressure(d);
        const windSpeed = overpressureToWindSpeed(overpressure) * 2.237; // Convert to mph
        windSpeeds.push(windSpeed);
        overpressures.push(overpressure);
    }
    
    new Chart(document.getElementById('windSpeedDistanceChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: distances.map(d => d + ' km'),
            datasets: [{
                label: 'Wind Speed (mph)',
                data: windSpeeds,
                borderColor: '#00d4ff',
                backgroundColor: 'rgba(0, 212, 255, 0.2)',
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                borderWidth: 3,
                yAxisID: 'y'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: 'white' }
                },
                title: {
                    display: true,
                    text: 'Wind Speed vs Distance from Impact',
                    color: 'white',
                    font: { size: 14 }
                }
            },
            scales: {
                y: {
                    type: 'logarithmic',
                    ticks: { color: 'white' },
                    grid: { color: '#333' },
                    title: {
                        display: true,
                        text: 'Wind Speed (mph, log scale)',
                        color: 'white'
                    }
                },
                x: {
                    ticks: { 
                        color: 'white',
                        maxTicksLimit: 15
                    },
                    grid: { color: '#333' },
                    title: {
                        display: true,
                        text: 'Distance from Impact',
                        color: 'white'
                    }
                }
            }
        }
    });
    
    // Chart 3: Casualties by Wind Zone
    const casualtyData = [
        casualties_hypersonic,
        casualties_jupiter - casualties_hypersonic,
        casualties_total_destruction - casualties_jupiter,
        casualties_ef5 - casualties_total_destruction,
        casualties_severe - casualties_ef5,
        casualties_trees - casualties_severe
    ];
    
    new Chart(document.getElementById('windCasualtiesChart').getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: [
                'Hypersonic (100% fatal)',
                'Jupiter Winds (100% fatal)',
                'Total Destruction (95% fatal)',
                'EF5 Tornado (70% fatal)',
                'Severe Damage (30% fatal)',
                'Tree Destruction (5% fatal)'
            ],
            datasets: [{
                data: casualtyData,
                backgroundColor: ['#000000', '#4B0082', '#8B0000', '#FF4500', '#FFA500', '#90EE90'],
                borderColor: '#1a1a2e',
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { 
                        color: 'white',
                        font: { size: 10 }
                    },
                    position: 'bottom'
                },
                title: {
                    display: true,
                    text: 'Population Affected by Wind Zone',
                    color: 'white',
                    font: { size: 14 }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value.toLocaleString()} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}



async function generateGlobalEffectsContent() {
    if (!asteroidData) return "<p>Loading data...</p>";
    
    // Physical constants
    const EARTH_MASS = 5.972e24; // kg
    const EARTH_ORBITAL_VELOCITY = 29780; // m/s
    const EARTH_ANGULAR_MOMENTUM = 5.86e33; // kg¬∑m¬≤/s
    const EARTH_RADIUS = 6371000; // m
    const EARTH_VOLUME = (4/3) * Math.PI * Math.pow(EARTH_RADIUS, 3); // m¬≥
    const EARTH_CIRCUMFERENCE = 2 * Math.PI * EARTH_RADIUS; // m
    
    // Asteroid parameters
    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000; // m/s
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const E_megatons = E_joules / 4.184e15;
    
    // Linear momentum calculations
    const impactor_momentum = m * v;
    const earth_momentum = EARTH_MASS * EARTH_ORBITAL_VELOCITY;
    const momentum_ratio = impactor_momentum / earth_momentum;
    
    // Determine orbital effect
    let orbital_effect, orbital_description, orbital_color;
    if (momentum_ratio < 0.001) {
        orbital_effect = "No Noticeable Change";
        orbital_description = "Earth's orbit remains essentially unchanged";
        orbital_color = "#27ae60";
    } else if (momentum_ratio < 0.01) {
        orbital_effect = "Noticeable Change";
        orbital_description = "Slight alteration in orbital eccentricity or distance from Sun";
        orbital_color = "#f39c12";
    } else if (momentum_ratio < 0.1) {
        orbital_effect = "Substantial Change";
        orbital_description = "Major shift in Earth's orbit - climate zones altered permanently";
        orbital_color = "#e67e22";
    } else {
        orbital_effect = "Catastrophic Orbital Change";
        orbital_description = "Earth's orbit fundamentally altered - potentially ejected from habitable zone";
        orbital_color = "#c0392b";
    }
    
    // Angular momentum calculations (assuming perpendicular impact at equator for maximum effect)
    const impact_angular_momentum = m * v * EARTH_RADIUS;
    const angular_momentum_ratio = impact_angular_momentum / EARTH_ANGULAR_MOMENTUM;
    
    // Determine rotation effect
    let rotation_effect, rotation_description, rotation_color;
    if (angular_momentum_ratio < 0.01) {
        rotation_effect = "No Noticeable Change";
        rotation_description = "Day length and axial tilt remain unchanged";
        rotation_color = "#27ae60";
    } else if (angular_momentum_ratio < 0.1) {
        rotation_effect = "Noticeable Change";
        rotation_description = "Day length altered by minutes to hours, axis tilt shifted slightly";
        rotation_color = "#f39c12";
    } else if (angular_momentum_ratio < 1.0) {
        rotation_effect = "Substantial Change";
        rotation_description = "Day length dramatically altered, seasons fundamentally changed";
        rotation_color = "#e67e22";
    } else {
        rotation_effect = "Total Rotation Change";
        rotation_description = "Earth's rotation completely disrupted - potential tidal lock or chaotic tumbling";
        rotation_color = "#c0392b";
    }
    
    // Crater volume and Earth disruption
    // Transient crater diameter (Collins et al. 2005)
    const transient_crater_diameter = 1.161 * Math.pow(r_m, 0.78) * Math.pow(v/1000, 0.44) * Math.pow(rho/2700, 0.36) * Math.pow(2.7, -0.22); // km
    const transient_crater_depth = transient_crater_diameter / 3; // Rough approximation
    const transient_crater_volume = (1/3) * Math.PI * Math.pow(transient_crater_diameter * 1000 / 2, 2) * transient_crater_depth * 1000; // m¬≥
    const volume_ratio = transient_crater_volume / EARTH_VOLUME;
    
    // Determine disruption level
    let disruption_effect, disruption_description, disruption_color;
    if (volume_ratio > 0.5) {
        disruption_effect = "Complete Planetary Disruption";
        disruption_description = "Earth shattered into fragments - new asteroid belt forms between Venus and Mars";
        disruption_color = "#8b0000";
    } else if (volume_ratio > 0.1) {
        disruption_effect = "Severe Planetary Disturbance";
        disruption_description = "Earth loses significant mass but remains intact - massive geological restructuring";
        disruption_color = "#c0392b";
    } else {
        disruption_effect = "Minor Planetary Disturbance";
        disruption_description = "Earth loses negligible mass - impact is regional rather than planetary scale";
        disruption_color = "#27ae60";
    }
    
    // Global environmental effects
    const ejecta_mass = Math.pow(E_megatons, 0.6) * 1e12; // kg (rough scaling)
    const ejecta_coverage_area = Math.min(4 * Math.PI * Math.pow(EARTH_RADIUS, 2), ejecta_mass / 10); // m¬≤ assuming 10 kg/m¬≤
    const global_coverage_percent = (ejecta_coverage_area / (4 * Math.PI * Math.pow(EARTH_RADIUS, 2))) * 100;
    
    // Atmospheric dust loading
    const dust_mass = ejecta_mass * 0.1; // 10% of ejecta becomes atmospheric dust
    const atmospheric_optical_depth = Math.min((dust_mass / 5e15), 100); // Normalized optical depth
    const darkness_duration_days = atmospheric_optical_depth * 30; // Days of darkness
    
    // Temperature effects
    const immediate_cooling = Math.min(atmospheric_optical_depth * 0.5, 50); // ¬∞C drop
    const cooling_duration_years = Math.pow(E_megatons, 0.3) / 10;
    
    // Acid rain and chemical effects
    const sulfur_release = E_megatons * 1e9 * 0.01; // kg (1% of energy converts to SO2)
    const acid_rain_ph = Math.max(7 - Math.log10(sulfur_release / 1e12), 1);
    
    // Wildfires
    const thermal_ignition_area = Math.PI * Math.pow(getDistanceForFlux(20), 2); // m¬≤ (20 J/cm¬≤ threshold)
    const wildfire_area_percent = Math.min((thermal_ignition_area / (4 * Math.PI * Math.pow(EARTH_RADIUS, 2))) * 100, 100);
    
    // Ozone depletion
    const ozone_depletion_percent = Math.min((E_megatons / 100) * 50, 90);
    const ozone_recovery_years = ozone_depletion_percent / 2;
    
    // Tsunami (if ocean impact)
   
    
    // Mass extinction probability
    let extinction_probability, extinction_level;
    if (E_megatons < 100) {
        extinction_probability = 0;
        extinction_level = "No mass extinction";
    } else if (E_megatons < 1000) {
        extinction_probability = 10;
        extinction_level = "Local extinctions possible";
    } else if (E_megatons < 10000) {
        extinction_probability = 30;
        extinction_level = "Regional extinctions likely";
    } else if (E_megatons < 100000) {
        extinction_probability = 60;
        extinction_level = "Major mass extinction event (>50% species)";
    } else {
        extinction_probability = 95;
        extinction_level = "Planetary sterilization - extinction of most complex life";
    }
    
    // Helper function for thermal flux (reuse from thermal effects)
    function getDistanceForFlux(target_flux) {
        const fireball_radius = 440 * Math.pow(E_megatons, 0.4);
        let low = fireball_radius;
        let high = 1000000;
        
        while (high - low > 100) {
            const mid = (low + high) / 2;
            const distance_km = mid / 1000;
            const thermal_yield_fraction = 0.35;
            const thermal_energy = E_joules * thermal_yield_fraction;
            const flux_at_distance = thermal_energy / (4 * Math.PI * Math.pow(mid, 2)) / 10000;
            const absorption_factor = Math.exp(-distance_km / 50);
            const flux = flux_at_distance * absorption_factor;
            
            if (flux > target_flux) {
                low = mid;
            } else {
                high = mid;
            }
        }
        
        return (low + high) / 2;
    }
    
    return `
    <div style="background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 3px solid #6c5ce7;">
        <h2 style="margin: 0 0 15px 0; color: #00d4ff; text-align: center; font-size: 1.8em;">üåç GLOBAL PLANETARY EFFECTS</h2>
        <p style="text-align: center; color: #aaa; font-size: 0.95em; margin: 0;">
            Beyond local devastation, impacts of this magnitude can alter Earth's fundamental properties
        </p>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
        <div style="background: ${orbital_color}; padding: 15px; border-radius: 8px; text-align: center;">
            <h3 style="margin: 0 0 10px 0; color: white;">üåê Orbital Change</h3>
            <div style="font-size: 1.3em; font-weight: bold; color: white; margin-bottom: 8px;">
                ${orbital_effect}
            </div>
            <div style="font-size: 0.85em; color: rgba(255,255,255,0.9);">
                Ratio: ${formatMetric(momentum_ratio)}
            </div>
        </div>
        <div style="background: ${rotation_color}; padding: 15px; border-radius: 8px; text-align: center;">
            <h3 style="margin: 0 0 10px 0; color: white;">üîÑ Rotation Change</h3>
            <div style="font-size: 1.3em; font-weight: bold; color: white; margin-bottom: 8px;">
                ${rotation_effect}
            </div>
            <div style="font-size: 0.85em; color: rgba(255,255,255,0.9);">
                Ratio: ${formatMetric(angular_momentum_ratio)}
            </div>
        </div>
        <div style="background: ${disruption_color}; padding: 15px; border-radius: 8px; text-align: center;">
            <h3 style="margin: 0 0 10px 0; color: white;">üí• Planetary Integrity</h3>
            <div style="font-size: 1.3em; font-weight: bold; color: white; margin-bottom: 8px;">
                ${disruption_effect}
            </div>
            <div style="font-size: 0.85em; color: rgba(255,255,255,0.9);">
                Ratio: ${formatMetric(volume_ratio.toExponential(2))}
            </div>
        </div>
    </div>

    <div class="info-section" style="background: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0; color: #6c5ce7;">üåç Earth's Orbital Dynamics</h3>
        <div style="background: rgba(108,92,231,0.1); padding: 12px; border-radius: 6px; border-left: 3px solid ${orbital_color};">
            <b style="color: ${orbital_color};">${orbital_effect}:</b> ${orbital_description}<br><br>
            <b>Impactor Momentum:</b> ${formatMetric(impactor_momentum)} kg¬∑m/s<br>
            <b>Earth Orbital Momentum:</b> ${formatLargeNumberWords(earth_momentum)} kg¬∑m/s<br>
            <b>Momentum Ratio:</b> ${(momentum_ratio * 100).toExponential(2)}%<br><br>
            ${momentum_ratio >= 0.001 ? `
                <b style="color: #e74c3c;">Potential Consequences:</b><br>
                ‚Ä¢ Orbital velocity change: ~${(momentum_ratio * EARTH_ORBITAL_VELOCITY).toFixed(2)} m/s<br>
                ‚Ä¢ Distance from Sun altered by: ~${(momentum_ratio * 149597870.7).toFixed(0)} km<br>
                ‚Ä¢ Year length change: ~${(momentum_ratio * 365.25).toFixed(2)} days<br>
                ‚Ä¢ Average temperature shift: ~${(momentum_ratio * 1000).toFixed(1)}¬∞C
            ` : `
                <b style="color: #27ae60;">Earth's Orbit Stable:</b><br>
                The impact energy is insufficient to meaningfully alter Earth's 149.6 million km orbit around the Sun.
            `}
        </div>
    </div>

    <div class="info-section" style="background: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0; color: #e67e22;">üîÑ Earth's Rotation & Axial Tilt</h3>
        <div style="background: rgba(230,126,34,0.1); padding: 12px; border-radius: 6px; border-left: 3px solid ${rotation_color};">
            <b style="color: ${rotation_color};">${rotation_effect}:</b> ${rotation_description}<br><br>
            <b>Impact Angular Momentum:</b> ${formatLargeNumberWords(impact_angular_momentum)} kg¬∑m¬≤/s<br>
            <b>Earth's Angular Momentum:</b> ${formatLargeNumberWords(EARTH_ANGULAR_MOMENTUM)} kg¬∑m¬≤/s<br>
            <b>Angular Momentum Ratio:</b> ${(angular_momentum_ratio * 100).toExponential(2)}%<br><br>
            ${angular_momentum_ratio >= 0.01 ? `
                <b style="color: #e74c3c;">Potential Consequences:</b><br>
                ‚Ä¢ Day length change: ~${(angular_momentum_ratio * 24).toFixed(2)} hours<br>
                ‚Ä¢ New day length: ~${(24 + angular_momentum_ratio * 24).toFixed(1)} hours<br>
                ‚Ä¢ Axial tilt change: ~${(angular_momentum_ratio * 23.5).toFixed(1)}¬∞ (current: 23.5¬∞)<br>
                ‚Ä¢ Seasonal pattern disruption: ${angular_momentum_ratio > 0.1 ? "SEVERE" : "MODERATE"}<br>
                ‚Ä¢ Climate zone shift: ${angular_momentum_ratio > 0.1 ? "Complete reorganization" : "Significant changes"}
            ` : `
                <b style="color: #27ae60;">Earth's Rotation Stable:</b><br>
                The 24-hour day and 23.5¬∞ axial tilt remain essentially unchanged. Seasons continue as normal.
            `}
        </div>
    </div>

    <div class="info-section" style="background: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0; color: #c0392b;">üí• Planetary Structural Integrity</h3>
        <div style="background: rgba(192,57,43,0.1); padding: 12px; border-radius: 6px; border-left: 3px solid ${disruption_color};">
            <b style="color: ${disruption_color};">${disruption_effect}:</b> ${disruption_description}<br><br>
            <b>Transient Crater Diameter:</b> ${transient_crater_diameter.toFixed(2)} km<br>
            <b>Transient Crater Depth:</b> ${transient_crater_depth.toFixed(2)} km<br>
            <b>Crater Volume:</b> ${formatMetric(transient_crater_volume)} m¬≥<br>
            <b>Earth Volume:</b> ${formatMetric(EARTH_VOLUME)} m¬≥<br>
            <b>Volume Ratio:</b> ${(volume_ratio * 100).toExponential(2)}%<br><br>
            <b>Crater Size Comparison:</b> ${(transient_crater_diameter / 12742 * 100).toFixed(3)}% of Earth's diameter<br>
            ${volume_ratio > 0.1 ? `
                <b style="color: #e74c3c;">‚ö†Ô∏è CATASTROPHIC PLANETARY DAMAGE</b><br>
                The impact excavates a significant fraction of Earth's mass. Mantle material exposed, global tectonic reset.
            ` : `
                <b>Geological Impact:</b> Massive crater but Earth remains structurally intact.
            `}
        </div>
    </div>

    <div class="chart-container" style="margin-bottom: 15px;">
        <canvas id="globalRatiosChart" height="200"></canvas>
    </div>

    <div class="info-section" style="background: linear-gradient(135deg, #141e30 0%, #243b55 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #3498db;">
        <h3 style="margin: 0 0 10px 0; color: #3498db;">‚òÅÔ∏è Atmospheric & Climate Effects</h3>
        
        <div style="background: rgba(52,152,219,0.1); padding: 12px; border-radius: 6px; margin-bottom: 10px;">
            <h4 style="margin: 0 0 8px 0; color: #3498db;">üå´Ô∏è Dust & Aerosol Loading</h4>
            <b>Ejecta Mass:</b> ${formatLargeNumberWords(ejecta_mass)} kg<br>
            <b>Atmospheric Dust:</b> ${formatLargeNumberWords(dust_mass)} kg<br>
            <b>Global Coverage:</b> ${global_coverage_percent.toFixed(1)}% of Earth's surface<br>
            <b>Atmospheric Optical Depth:</b> ${atmospheric_optical_depth.toFixed(2)} (0=clear, 1=opaque)<br>
            <b>Darkness Duration:</b> ${darkness_duration_days.toFixed(0)} days<br><br>
            ${atmospheric_optical_depth > 1 ? `
                <b style="color: #e74c3c;">Impact Winter Scenario:</b><br>
                ‚Ä¢ Sunlight reduced to ${(100/atmospheric_optical_depth).toFixed(1)}% of normal<br>
                ‚Ä¢ Photosynthesis ceases globally<br>
                ‚Ä¢ Crop failure worldwide<br>
                ‚Ä¢ Food chain collapse from bottom up
            ` : `
                <b>Limited atmospheric disruption</b> - regional rather than global darkening
            `}
        </div>

        <div style="background: rgba(52,152,219,0.1); padding: 12px; border-radius: 6px; margin-bottom: 10px;">
            <h4 style="margin: 0 0 8px 0; color: #3498db;">üå°Ô∏è Temperature Effects</h4>
            <b>Immediate Cooling:</b> -${immediate_cooling.toFixed(1)}¬∞C globally<br>
            <b>Cooling Duration:</b> ${cooling_duration_years.toFixed(1)} years<br>
            <b>Followed By:</b> Greenhouse warming from CO‚ÇÇ and water vapor<br>
            <b>Long-term Temperature Shift:</b> ${momentum_ratio > 0.01 ? `+${(momentum_ratio * 500).toFixed(1)}¬∞C from orbital change` : "Minimal from orbit"}<br><br>
            ${immediate_cooling > 10 ? `
                <b style="color: #3498db;">Climate Catastrophe:</b><br>
                ‚Ä¢ Global average drops from 15¬∞C to ${(15 - immediate_cooling).toFixed(1)}¬∞C<br>
                ‚Ä¢ Widespread glaciation<br>
                ‚Ä¢ Ocean surface freezing<br>
                ‚Ä¢ Mass extinction of temperature-sensitive species
            ` : ""}
        </div>

        <div style="background: rgba(52,152,219,0.1); padding: 12px; border-radius: 6px; margin-bottom: 10px;">
            <h4 style="margin: 0 0 8px 0; color: #e74c3c;">üåßÔ∏è Acid Rain & Chemical Warfare</h4>
            <b>Sulfur Release (SO‚ÇÇ):</b> ${formatMetric(sulfur_release)} kg<br>
            <b>Nitrogen Oxides:</b> ${formatMetric(sulfur_release * 0.5)} kg<br>
            <b>Acid Rain pH:</b> ${acid_rain_ph.toFixed(1)} (normal: 5.6)<br>
            <b>Ozone Layer Depletion:</b> ${ozone_depletion_percent.toFixed(1)}%<br>
            <b>Ozone Recovery Time:</b> ${ozone_recovery_years.toFixed(0)} years<br><br>
            ${acid_rain_ph < 3 ? `
                <b style="color: #e74c3c;">‚ö†Ô∏è Extreme Chemical Contamination:</b><br>
                ‚Ä¢ Acid rain kills vegetation and aquatic life<br>
                ‚Ä¢ Soil sterilization over vast areas<br>
                ‚Ä¢ Drinking water contaminated<br>
                ‚Ä¢ UV radiation lethal at surface due to ozone loss
            ` : ""}
        </div>

        <div style="background: rgba(52,152,219,0.1); padding: 12px; border-radius: 6px;">
            <h4 style="margin: 0 0 8px 0; color: #e67e22;">üî• Global Wildfires</h4>
            <b>Thermal Ignition Area:</b> ${formatMetric(thermal_ignition_area)} m¬≤ (${wildfire_area_percent.toFixed(2)}% of Earth)<br>
            <b>Estimated Burn Area:</b> ${(wildfire_area_percent * 510).toFixed(0)} million km¬≤<br>
            <b>CO‚ÇÇ Release:</b> ${formatMetric(wildfire_area_percent * 1e15)} kg<br>
            <b>Soot Injection:</b> ${(wildfire_area_percent * 1e14).toExponential(2)} kg into stratosphere<br><br>
            ${wildfire_area_percent > 10 ? `
                <b style="color: #e67e22;">Global Firestorm:</b><br>
                ‚Ä¢ ${wildfire_area_percent.toFixed(0)}% of Earth's forests ignited<br>
                ‚Ä¢ Oxygen depletion in atmosphere<br>
                ‚Ä¢ Additional cooling from soot (nuclear winter effect)<br>
                ‚Ä¢ Carbon cycle disrupted for centuries
            ` : "Localized fires only"}
        </div>
    </div>


    <div class="chart-container" style="margin-bottom: 15px;">
        <canvas id="atmosphericEffectsChart" height="220"></canvas>
    </div>

    <div class="info-section" style="background: linear-gradient(135deg, #8b0000 0%, #4a0000 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 3px solid #ff0000;">
        <h3 style="margin: 0 0 10px 0; color: #ff6b6b;">‚ò†Ô∏è Mass Extinction Analysis</h3>
        <div style="background: rgba(255,0,0,0.2); padding: 15px; border-radius: 6px;">
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <b style="font-size: 1.1em; color: #ff6b6b;">Extinction Level:</b><br>
                    <span style="font-size: 1.3em; color: white;">${extinction_level}</span><br><br>
                    <b>Extinction Probability:</b> ${extinction_probability}%<br>
                    <b>Impact Energy:</b> ${E_megatons.toExponential(2)} MT TNT<br>
                    <b>Comparison:</b> ${(E_megatons / 15).toExponential(2)}x Chicxulub (dinosaur killer)
                </div>
                <div style="text-align: center;">
                    <div style="width: 120px; height: 120px; border-radius: 50%; border: 8px solid #ff0000; display: flex; align-items: center; justify-content: center; margin: 0 auto; background: radial-gradient(circle, #ff0000 0%, #8b0000 100%);">
                        <span style="font-size: 2.5em; font-weight: bold; color: white;">${extinction_probability}%</span>
                    </div>
                </div>
            </div>
            
            <b style="color: #ff6b6b;">Extinction Mechanisms:</b>
            <ul style="margin: 8px 0; padding-left: 20px; line-height: 1.7;">
                <li><b>Immediate:</b> ${(global_coverage_percent * 0.1).toFixed(1)}% of species in blast zone (${formatLargeNumberWords(global_coverage_percent * 0.1 * 8.7e6)} species)</li>
                <li><b>Impact Winter:</b> ${darkness_duration_days > 30 ? "Complete collapse of photosynthesis-based food chains" : "Limited food chain disruption"}</li>
                <li><b>Starvation:</b> Herbivores die within months, carnivores within year</li>
                <li><b>Ocean Acidification:</b> ${acid_rain_ph < 4 ? "Mass die-off of calcifying organisms (corals, shellfish)" : "Moderate ocean stress"}</li>
                <li><b>UV Radiation:</b> ${ozone_depletion_percent}% ozone loss = DNA damage to surface life</li>
                <li><b>Climate Chaos:</b> Temperature swings of ${immediate_cooling.toFixed(0)}¬∞C kill climate-sensitive species</li>
            </ul>
            
            ${extinction_probability > 50 ? `
                <div style="background: rgba(0,0,0,0.4); padding: 10px; border-radius: 5px; margin-top: 10px; border-left: 3px solid #ff0000;">
                    <b style="color: #ff0000;">‚ö†Ô∏è MASS EXTINCTION EVENT</b><br>
                    This impact rivals or exceeds the K-Pg extinction that killed the dinosaurs 66 million years ago.<br>
                    <b>Recovery Timeline:</b> ${(extinction_probability / 10).toFixed(0)} million years for biodiversity to recover.
                </div>
            ` : ""}
        </div>
    </div>

    <div class="chart-container" style="margin-bottom: 15px;">
        <canvas id="extinctionTimelineChart" height="200"></canvas>
    </div>

    <div class="info-section" style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0; color: #00d4ff;">üåç Historical Impact Comparisons</h3>
        <table style="width: 100%; font-size: 0.9em; border-collapse: collapse;">
            <thead>
                <tr style="background: rgba(0,212,255,0.2); border-bottom: 2px solid #00d4ff;">
                    <th style="padding: 8px; text-align: left;">Event</th>
                    <th style="padding: 8px; text-align: center;">Energy (MT)</th>
                    <th style="padding: 8px; text-align: center;">Crater Size</th>
                    <th style="padding: 8px; text-align: left;">Consequences</th>
                </tr>
            </thead>
            <tbody>
                <tr style="border-bottom: 1px solid #444;">
                    <td style="padding: 8px;"><b>This Impact</b></td>
                    <td style="padding: 8px; text-align: center;">${E_megatons.toExponential(2)}</td>
                    <td style="padding: 8px; text-align: center;">${transient_crater_diameter.toFixed(1)} km</td>
                    <td style="padding: 8px;">${extinction_level}</td>
                </tr>
                <tr style="border-bottom: 1px solid #444;">
                    <td style="padding: 8px;">Tunguska (1908)</td>
                    <td style="padding: 8px; text-align: center;">15</td>
                    <td style="padding: 8px; text-align: center;">None (airburst)</td>
                    <td style="padding: 8px;">2,000 km¬≤ of forest flattened</td>
                </tr>
                <tr style="border-bottom: 1px solid #444;">
                    <td style="padding: 8px;">Barringer Crater (50,000 ya)</td>
                    <td style="padding: 8px; text-align: center;">10-20</td>
                    <td style="padding: 8px; text-align: center;">1.2 km</td>
                    <td style="padding: 8px;">Local devastation only</td>
                </tr>
                <tr style="border-bottom: 1px solid #444;">
                    <td style="padding: 8px;">Chicxulub (66 Mya)</td>
                    <td style="padding: 8px; text-align: center;">1.0√ó10‚Å∏</td>
                    <td style="padding: 8px; text-align: center;">180 km</td>
                    <td style="padding: 8px;">Killed dinosaurs, 75% of species extinct</td>
                </tr>
                <tr style="border-bottom: 1px solid #444;">
                    <td style="padding: 8px;">Vredefort (2 Gya)</td>
                    <td style="padding: 8px; text-align: center;">5.0√ó10‚Å∏</td>
                    <td style="padding: 8px; text-align: center;">300 km</td>
                    <td style="padding: 8px;">Largest verified impact on Earth</td>
                </tr>
                <tr>
                    <td style="padding: 8px;">Moon Formation (4.5 Gya)</td>
                    <td style="padding: 8px; text-align: center;">1.0√ó10¬π‚Å¥</td>
                    <td style="padding: 8px; text-align: center;">N/A</td>
                    <td style="padding: 8px;">Mars-sized object, created the Moon</td>
                </tr>
            </tbody>
        </table>
        <p style="margin: 10px 0 0 0; font-size: 0.85em; color: #aaa;">
            <b>Your impact is ${(E_megatons / 1e8).toFixed(2)}x the Chicxulub event</b> (the one that ended the dinosaurs)
        </p>
    </div>

    <div class="info-section" style="background: linear-gradient(135deg, #16213e 0%, #0f3460 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #00d4ff;">
        <h3 style="margin: 0 0 10px 0; color: #00d4ff;">üí° Global Effects Science</h3>
        <ul style="margin: 5px 0; padding-left: 20px; line-height: 1.7; font-size: 0.9em;">
            <li>The K-Pg boundary (66 Mya) shows a global layer of iridium - evidence of the Chicxulub impact that ended the Cretaceous period</li>
            <li>Impact winter theory: dust blocks sunlight for months/years, collapsing food chains from phytoplankton upward</li>
            <li>Deccan Traps volcanism may have been triggered by Chicxulub's antipodal shock waves</li>
            <li>Ocean impacts create "impact tsunamis" that dwarf earthquake-generated ones - waves can circle the globe multiple times</li>
            <li>Sulfur release creates sulfuric acid aerosols that stay in stratosphere for years, blocking 90%+ of sunlight</li>
            <li>The "impact winter" is followed by "impact summer" - greenhouse gases cause centuries of warming</li>
            <li>Tektites (impact glass) are found thousands of km from impact sites - ejected into space and reentered</li>
            <li>The Late Heavy Bombardment (4.1-3.8 Gya) repeatedly sterilized Earth's surface - life survived only in deep oceans</li>
            <li>Impacts larger than Chicxulub could vaporize oceans, creating a steam atmosphere for thousands of years</li>
            <li>The "impact threshold" for mass extinction is roughly 10 km diameter (100,000 MT) - disrupts climate globally</li>
        </ul>
    </div>

    <div class="info-section" style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%); padding: 15px; border-radius: 8px; margin-top: 15px; border: 2px solid #2ecc71;">
        <h3 style="margin: 0 0 10px 0; color: white;">üå± Post-Impact Recovery Timeline</h3>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 0.9em;">
            <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px; border-left: 3px solid #e74c3c;">
                <b style="color: white;">Years 0-10:</b><br>
                <span style="color: #ddd;">
                ${extinction_probability > 50 ? 
                    "Impact winter, global darkness, mass starvation, 90% species loss" :
                    "Regional devastation, limited global effects"
                }
                </span>
            </div>
            <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px; border-left: 3px solid #e67e22;">
                <b style="color: white;">Years 10-100:</b><br>
                <span style="color: #ddd;">
                ${extinction_probability > 50 ?
                    "Dust settles, greenhouse warming, acid oceans, no large animals" :
                    "Ecosystem recovery begins, human civilization rebuilds"
                }
                </span>
            </div>
            <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px; border-left: 3px solid #f39c12;">
                <b style="color: white;">Years 100-1000:</b><br>
                <span style="color: #ddd;">
                ${extinction_probability > 50 ?
                    "Climate stabilizes, surviving species radiate, new ecosystems emerge" :
                    "Full recovery, geological record of impact remains"
                }
                </span>
            </div>
            <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px; border-left: 3px solid #f1c40f;">
                <b style="color: white;">1,000-10,000 years:</b><br>
                <span style="color: #ddd;">
                ${extinction_probability > 50 ?
                    "Biodiversity slowly increases, forests regrow, mammals dominate" :
                    "Impact scar remains visible, civilizations tell myths of 'the impact'"
                }
                </span>
            </div>
            <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px; border-left: 3px solid #52be80;">
                <b style="color: white;">10,000-1M years:</b><br>
                <span style="color: #ddd;">
                ${extinction_probability > 50 ?
                    "New dominant species evolve, crater erodes, climate normalized" :
                    "Crater barely visible, erosion nearly complete"
                }
                </span>
            </div>
            <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px; border-left: 3px solid #27ae60;">
                <b style="color: white;">1M-10M years:</b><br>
                <span style="color: #ddd;">
                ${extinction_probability > 50 ?
                    "Biodiversity fully restored, impact layer visible in rock record" :
                    "Only geological evidence remains in sediment layers"
                }
                </span>
            </div>
        </div>
    </div>

    <div class="info-section" style="background: #1a1a2e; padding: 20px; border-radius: 8px; margin-top: 20px; border: 2px solid #6c5ce7; text-align: center;">
        <h3 style="margin: 0 0 10px 0; color: #6c5ce7;">üî¨ Scientific Note</h3>
        <p style="color: #aaa; line-height: 1.7; margin: 0;">
            These calculations are based on empirical scaling laws from nuclear weapons testing, laboratory experiments, 
            and numerical simulations of impact events. Global effects become increasingly uncertain for very large impacts 
            as we enter regimes with no historical analogs. The Chicxulub impact (66 Mya) provides our best calibration 
            point for understanding planetary-scale consequences.
        </p>
    </div>
    `;
}

async function initGlobalEffectsCharts() {
    if (!asteroidData) return;
    
    // Constants
    const EARTH_MASS = 5.972e24;
    const EARTH_ORBITAL_VELOCITY = 29780;
    const EARTH_ANGULAR_MOMENTUM = 5.86e33;
    const EARTH_RADIUS = 6371000;
    const EARTH_VOLUME = (4/3) * Math.PI * Math.pow(EARTH_RADIUS, 3);
    
    // Calculations
    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const E_megatons = E_joules / 4.184e15;
    
    const impactor_momentum = m * v;
    const earth_momentum = EARTH_MASS * EARTH_ORBITAL_VELOCITY;
    const momentum_ratio = impactor_momentum / earth_momentum;
    
    const impact_angular_momentum = m * v * EARTH_RADIUS;
    const angular_momentum_ratio = impact_angular_momentum / EARTH_ANGULAR_MOMENTUM;
    
    const transient_crater_diameter = 1.161 * Math.pow(r_m, 0.78) * Math.pow(v/1000, 0.44) * Math.pow(rho/2700, 0.36) * Math.pow(2.7, -0.22);
    const transient_crater_depth = transient_crater_diameter / 3;
    const transient_crater_volume = (1/3) * Math.PI * Math.pow(transient_crater_diameter * 1000 / 2, 2) * transient_crater_depth * 1000;
    const volume_ratio = transient_crater_volume / EARTH_VOLUME;
    
    // Chart 1: Global Ratios Comparison
    new Chart(document.getElementById('globalRatiosChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: ['Orbital\nMomentum', 'Rotational\nAngular Momentum', 'Planetary\nVolume'],
            datasets: [{
                label: 'Impact/Earth Ratio',
                data: [momentum_ratio, angular_momentum_ratio, volume_ratio],
                backgroundColor: ['#6c5ce7', '#e67e22', '#c0392b'],
                borderColor: '#00d4ff',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: 'white' }
                },
                title: {
                    display: true,
                    text: 'Impact vs Earth: Fundamental Property Ratios',
                    color: 'white',
                    font: { size: 14 }
                }
            },
            scales: {
                y: {
                    type: 'logarithmic',
                    ticks: { color: 'white' },
                    grid: { color: '#333' },
                    title: {
                        display: true,
                        text: 'Ratio (log scale)',
                        color: 'white'
                    }
                },
                x: {
                    ticks: { color: 'white' },
                    grid: { color: '#333' }
                }
            }
        }
    });
    
    // Chart 2: Atmospheric Effects Timeline
    const ejecta_mass = Math.pow(E_megatons, 0.6) * 1e12;
    const dust_mass = ejecta_mass * 0.1;
    const atmospheric_optical_depth = Math.min((dust_mass / 5e15), 100);
    const darkness_duration_days = atmospheric_optical_depth * 30;
    const immediate_cooling = Math.min(atmospheric_optical_depth * 0.5, 50);
    
    const timeLabels = ['Day 1', 'Week 1', 'Month 1', '6 Months', '1 Year', '5 Years', '10 Years'];
    const tempData = [
        -immediate_cooling,
        -immediate_cooling * 0.95,
        -immediate_cooling * 0.85,
        -immediate_cooling * 0.6,
        -immediate_cooling * 0.4,
        -immediate_cooling * 0.1,
        immediate_cooling * 0.05 // Greenhouse warming begins
    ];
    const lightData = [
        Math.max(100 - atmospheric_optical_depth * 90, 1),
        Math.max(100 - atmospheric_optical_depth * 85, 5),
        Math.max(100 - atmospheric_optical_depth * 70, 15),
        Math.max(100 - atmospheric_optical_depth * 40, 40),
        Math.max(100 - atmospheric_optical_depth * 20, 60),
        90,
        95
    ];
    
    new Chart(document.getElementById('atmosphericEffectsChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: timeLabels,
            datasets: [
                {
                    label: 'Temperature Change (¬∞C)',
                    data: tempData,
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231,76,60,0.2)',
                    yAxisID: 'y',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Sunlight (% of normal)',
                    data: lightData,
                    borderColor: '#f39c12',
                    backgroundColor: 'rgba(243,156,18,0.2)',
                    yAxisID: 'y1',
                    tension: 0.4,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    labels: { color: 'white' }
                },
                title: {
                    display: true,
                    text: 'Atmospheric Conditions Over Time',
                    color: 'white',
                    font: { size: 14 }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    position: 'left',
                    ticks: { color: '#e74c3c' },
                    grid: { color: '#333' },
                    title: {
                        display: true,
                        text: 'Temperature Change (¬∞C)',
                        color: '#e74c3c'
                    }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    ticks: { color: '#f39c12' },
                    grid: { display: false },
                    title: {
                        display: true,
                        text: 'Sunlight (%)',
                        color: '#f39c12'
                    }
                },
                x: {
                    ticks: { color: 'white' },
                    grid: { color: '#333' }
                }
            }
        }
    });
    
    // Chart 3: Extinction Timeline
    let extinction_probability;
    if (E_megatons < 100) extinction_probability = 0;
    else if (E_megatons < 1000) extinction_probability = 10;
    else if (E_megatons < 10000) extinction_probability = 30;
    else if (E_megatons < 100000) extinction_probability = 60;
    else extinction_probability = 95;
    
    const extinctionData = {
        labels: ['Hours', 'Days', 'Weeks', 'Months', 'Years', 'Decades', 'Centuries'],
        datasets: [{
            label: 'Species Extinction (%)',
            data: [
                extinction_probability * 0.1,
                extinction_probability * 0.3,
                extinction_probability * 0.5,
                extinction_probability * 0.7,
                extinction_probability * 0.85,
                extinction_probability * 0.95,
                extinction_probability
            ],
            borderColor: '#c0392b',
            backgroundColor: 'rgba(192,57,43,0.3)',
            fill: true,
            tension: 0.4,
            borderWidth: 3
        }]
    };
    
    new Chart(document.getElementById('extinctionTimelineChart').getContext('2d'), {
        type: 'line',
        data: extinctionData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: 'white' }
                },
                title: {
                    display: true,
                    text: 'Cumulative Species Extinction Over Time',
                    color: 'white',
                    font: { size: 14 }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: { 
                        color: 'white',
                        callback: function(value) {
                            return value + '%';
                        }
                    },
                    grid: { color: '#333' },
                    title: {
                        display: true,
                        text: 'Species Lost (%)',
                        color: 'white'
                    }
                },
                x: {
                    ticks: { color: 'white' },
                    grid: { color: '#333' },
                    title: {
                        display: true,
                        text: 'Time After Impact',
                        color: 'white'
                    }
                }
            }
        }
    });
}





</script>

</body>
</html>